<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>isic-2024_kaggle</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="isic-2024_kaggle_files/libs/clipboard/clipboard.min.js"></script>
<script src="isic-2024_kaggle_files/libs/quarto-html/quarto.js"></script>
<script src="isic-2024_kaggle_files/libs/quarto-html/popper.min.js"></script>
<script src="isic-2024_kaggle_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="isic-2024_kaggle_files/libs/quarto-html/anchor.min.js"></script>
<link href="isic-2024_kaggle_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="isic-2024_kaggle_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="isic-2024_kaggle_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="isic-2024_kaggle_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="isic-2024_kaggle_files/libs/bootstrap/bootstrap-10daa034703793678e481cc8cee6d76f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>



/* Hide scrollbar for the floating TOC only */
#quarto-margin-sidebar {
  scrollbar-width: none !important;         /* Firefox */
  -ms-overflow-style: none !important;      /* Internet Explorer */
}

#quarto-margin-sidebar::-webkit-scrollbar {
  display: none !important;                 /* Chrome, Safari, Edge */
}

/* Also target the TOC itself just in case */
#TOC {
  overflow-y: hidden !important;
  scrollbar-width: none !important;
}

#TOC::-webkit-scrollbar {
  display: none !important;
}

#quarto-margin-sidebar {
  direction: ltr; /* Force left-to-right layout */
}

#quarto-margin-sidebar nav#TOC {
  direction: ltr;         /* Ensure scrollbar is on the right */
  overflow-y: auto !important; /* Restore scroll if needed */
}
#quarto-margin-sidebar::-webkit-scrollbar {
  width: 6px;
}

#quarto-margin-sidebar::-webkit-scrollbar-thumb {
  background-color: #ccc;
  border-radius: 4px;
}

#quarto-margin-sidebar::-webkit-scrollbar-track {
  background: transparent;
}

</style>

  


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title"><strong>Table of contents</strong></h2>
   
  <ul>
  <li><a href="#initialization" id="toc-initialization" class="nav-link active" data-scroll-target="#initialization"><span class="header-section-number">1</span> Initialization</a>
  <ul>
  <li><a href="#global-variables" id="toc-global-variables" class="nav-link" data-scroll-target="#global-variables"><span class="header-section-number">1.1</span> Global variables</a></li>
  <li><a href="#execution-strategy" id="toc-execution-strategy" class="nav-link" data-scroll-target="#execution-strategy"><span class="header-section-number">1.2</span> Execution strategy</a></li>
  <li><a href="#librairies-import" id="toc-librairies-import" class="nav-link" data-scroll-target="#librairies-import"><span class="header-section-number">1.3</span> Librairies import</a></li>
  <li><a href="#database-setting" id="toc-database-setting" class="nav-link" data-scroll-target="#database-setting"><span class="header-section-number">1.4</span> Database setting</a></li>
  <li><a href="#training-variables" id="toc-training-variables" class="nav-link" data-scroll-target="#training-variables"><span class="header-section-number">1.5</span> Training variables</a></li>
  </ul></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">2</span> Data preparation</a>
  <ul>
  <li><a href="#preparation-utils" id="toc-preparation-utils" class="nav-link" data-scroll-target="#preparation-utils"><span class="header-section-number">2.1</span> Preparation utils</a>
  <ul>
  <li><a href="#formatting-utils" id="toc-formatting-utils" class="nav-link" data-scroll-target="#formatting-utils"><span class="header-section-number">2.1.1</span> Formatting utils</a></li>
  <li><a href="#encoding-utils" id="toc-encoding-utils" class="nav-link" data-scroll-target="#encoding-utils"><span class="header-section-number">2.1.2</span> Encoding utils</a></li>
  <li><a href="#oversampling-utils" id="toc-oversampling-utils" class="nav-link" data-scroll-target="#oversampling-utils"><span class="header-section-number">2.1.3</span> Oversampling utils</a></li>
  <li><a href="#subset-sampling-utils" id="toc-subset-sampling-utils" class="nav-link" data-scroll-target="#subset-sampling-utils"><span class="header-section-number">2.1.4</span> Subset sampling utils</a></li>
  <li><a href="#serialization-utils" id="toc-serialization-utils" class="nav-link" data-scroll-target="#serialization-utils"><span class="header-section-number">2.1.5</span> Serialization utils</a></li>
  <li><a href="#data-download-utils" id="toc-data-download-utils" class="nav-link" data-scroll-target="#data-download-utils"><span class="header-section-number">2.1.6</span> Data download utils</a></li>
  <li><a href="#preparation-pipeline" id="toc-preparation-pipeline" class="nav-link" data-scroll-target="#preparation-pipeline"><span class="header-section-number">2.1.7</span> Preparation pipeline</a></li>
  </ul></li>
  <li><a href="#run" id="toc-run" class="nav-link" data-scroll-target="#run"><span class="header-section-number">2.2</span> Run</a>
  <ul>
  <li><a href="#download-raw-datasets" id="toc-download-raw-datasets" class="nav-link" data-scroll-target="#download-raw-datasets"><span class="header-section-number">2.2.1</span> Download raw datasets</a></li>
  <li><a href="#download-refined-datasets" id="toc-download-refined-datasets" class="nav-link" data-scroll-target="#download-refined-datasets"><span class="header-section-number">2.2.2</span> Download refined datasets</a></li>
  <li><a href="#data-preparation-1" id="toc-data-preparation-1" class="nav-link" data-scroll-target="#data-preparation-1"><span class="header-section-number">2.2.3</span> Data preparation</a></li>
  <li><a href="#data-serialization" id="toc-data-serialization" class="nav-link" data-scroll-target="#data-serialization"><span class="header-section-number">2.2.4</span> Data serialization</a></li>
  </ul></li>
  <li><a href="#data-augmentation" id="toc-data-augmentation" class="nav-link" data-scroll-target="#data-augmentation"><span class="header-section-number">2.3</span> Data augmentation</a>
  <ul>
  <li><a href="#random-hue-saturation" id="toc-random-hue-saturation" class="nav-link" data-scroll-target="#random-hue-saturation"><span class="header-section-number">2.3.0.1</span> Random hue saturation</a></li>
  <li><a href="#random-shift-scale-rotate" id="toc-random-shift-scale-rotate" class="nav-link" data-scroll-target="#random-shift-scale-rotate"><span class="header-section-number">2.3.0.2</span> Random shift scale rotate</a></li>
  <li><a href="#random-crop" id="toc-random-crop" class="nav-link" data-scroll-target="#random-crop"><span class="header-section-number">2.3.0.3</span> Random crop</a></li>
  <li><a href="#random-cutout" id="toc-random-cutout" class="nav-link" data-scroll-target="#random-cutout"><span class="header-section-number">2.3.1</span> Random cutout</a></li>
  <li><a href="#distorsions" id="toc-distorsions" class="nav-link" data-scroll-target="#distorsions"><span class="header-section-number">2.3.2</span> Distorsions</a>
  <ul class="collapse">
  <li><a href="#random-elastic-transform" id="toc-random-elastic-transform" class="nav-link" data-scroll-target="#random-elastic-transform"><span class="header-section-number">2.3.2.1</span> Random elastic transform</a></li>
  <li><a href="#random-grid-distortion" id="toc-random-grid-distortion" class="nav-link" data-scroll-target="#random-grid-distortion"><span class="header-section-number">2.3.2.2</span> Random grid distortion</a></li>
  <li><a href="#random-optical-distortion" id="toc-random-optical-distortion" class="nav-link" data-scroll-target="#random-optical-distortion"><span class="header-section-number">2.3.2.3</span> Random optical distortion</a></li>
  <li><a href="#random-one-of-distorsion" id="toc-random-one-of-distorsion" class="nav-link" data-scroll-target="#random-one-of-distorsion"><span class="header-section-number">2.3.2.4</span> Random one of distorsion</a></li>
  </ul></li>
  <li><a href="#blurings" id="toc-blurings" class="nav-link" data-scroll-target="#blurings"><span class="header-section-number">2.3.3</span> Blurings</a>
  <ul class="collapse">
  <li><a href="#random-gaussian-blur" id="toc-random-gaussian-blur" class="nav-link" data-scroll-target="#random-gaussian-blur"><span class="header-section-number">2.3.3.1</span> Random gaussian blur</a></li>
  <li><a href="#random-motion-blur" id="toc-random-motion-blur" class="nav-link" data-scroll-target="#random-motion-blur"><span class="header-section-number">2.3.3.2</span> Random motion blur</a></li>
  <li><a href="#random-median-blur" id="toc-random-median-blur" class="nav-link" data-scroll-target="#random-median-blur"><span class="header-section-number">2.3.3.3</span> Random median blur</a></li>
  <li><a href="#radom-gaussian-noise" id="toc-radom-gaussian-noise" class="nav-link" data-scroll-target="#radom-gaussian-noise"><span class="header-section-number">2.3.3.4</span> Radom gaussian noise</a></li>
  <li><a href="#random-one-of-blur" id="toc-random-one-of-blur" class="nav-link" data-scroll-target="#random-one-of-blur"><span class="header-section-number">2.3.3.5</span> Random one of blur</a></li>
  </ul></li>
  <li><a href="#apply-augmentations" id="toc-apply-augmentations" class="nav-link" data-scroll-target="#apply-augmentations"><span class="header-section-number">2.3.4</span> Apply augmentations</a></li>
  </ul></li>
  <li><a href="#data-processing" id="toc-data-processing" class="nav-link" data-scroll-target="#data-processing"><span class="header-section-number">2.4</span> Data processing</a>
  <ul>
  <li><a href="#caching-utils" id="toc-caching-utils" class="nav-link" data-scroll-target="#caching-utils"><span class="header-section-number">2.4.1</span> Caching utils</a></li>
  <li><a href="#data-processing-utils" id="toc-data-processing-utils" class="nav-link" data-scroll-target="#data-processing-utils"><span class="header-section-number">2.4.2</span> Data processing utils</a></li>
  <li><a href="#oversampling-utils-1" id="toc-oversampling-utils-1" class="nav-link" data-scroll-target="#oversampling-utils-1"><span class="header-section-number">2.4.3</span> Oversampling utils</a></li>
  <li><a href="#data-loading-utils" id="toc-data-loading-utils" class="nav-link" data-scroll-target="#data-loading-utils"><span class="header-section-number">2.4.4</span> Data loading utils</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#modelling" id="toc-modelling" class="nav-link" data-scroll-target="#modelling"><span class="header-section-number">3</span> Modelling</a>
  <ul>
  <li><a href="#models-utils" id="toc-models-utils" class="nav-link" data-scroll-target="#models-utils"><span class="header-section-number">3.1</span> Models utils</a>
  <ul>
  <li><a href="#base-model" id="toc-base-model" class="nav-link" data-scroll-target="#base-model"><span class="header-section-number">3.1.1</span> Base model</a></li>
  <li><a href="#ensemble-model" id="toc-ensemble-model" class="nav-link" data-scroll-target="#ensemble-model"><span class="header-section-number">3.1.2</span> Ensemble model</a></li>
  <li><a href="#single-model" id="toc-single-model" class="nav-link" data-scroll-target="#single-model"><span class="header-section-number">3.1.3</span> Single model</a></li>
  <li><a href="#factory-utils" id="toc-factory-utils" class="nav-link" data-scroll-target="#factory-utils"><span class="header-section-number">3.1.4</span> Factory utils</a></li>
  <li><a href="#loss-functions" id="toc-loss-functions" class="nav-link" data-scroll-target="#loss-functions"><span class="header-section-number">3.1.5</span> Loss functions</a></li>
  <li><a href="#metrics" id="toc-metrics" class="nav-link" data-scroll-target="#metrics"><span class="header-section-number">3.1.6</span> Metrics</a></li>
  <li><a href="#callbacks" id="toc-callbacks" class="nav-link" data-scroll-target="#callbacks"><span class="header-section-number">3.1.7</span> Callbacks</a></li>
  <li><a href="#optimizers" id="toc-optimizers" class="nav-link" data-scroll-target="#optimizers"><span class="header-section-number">3.1.8</span> Optimizers</a></li>
  </ul></li>
  <li><a href="#training-utils" id="toc-training-utils" class="nav-link" data-scroll-target="#training-utils"><span class="header-section-number">3.2</span> Training utils</a>
  <ul>
  <li><a href="#plotting-metrics" id="toc-plotting-metrics" class="nav-link" data-scroll-target="#plotting-metrics"><span class="header-section-number">3.2.1</span> Plotting metrics</a></li>
  <li><a href="#data-loading" id="toc-data-loading" class="nav-link" data-scroll-target="#data-loading"><span class="header-section-number">3.2.2</span> Data loading</a></li>
  <li><a href="#training-pipeline-common" id="toc-training-pipeline-common" class="nav-link" data-scroll-target="#training-pipeline-common"><span class="header-section-number">3.2.3</span> Training pipeline common</a></li>
  <li><a href="#single-model-training-pipeline" id="toc-single-model-training-pipeline" class="nav-link" data-scroll-target="#single-model-training-pipeline"><span class="header-section-number">3.2.4</span> Single model training pipeline</a></li>
  </ul></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training"><span class="header-section-number">3.3</span> Training</a>
  <ul>
  <li><a href="#utils" id="toc-utils" class="nav-link" data-scroll-target="#utils"><span class="header-section-number">3.3.1</span> Utils</a></li>
  <li><a href="#initialization-1" id="toc-initialization-1" class="nav-link" data-scroll-target="#initialization-1"><span class="header-section-number">3.3.2</span> Initialization</a></li>
  <li><a href="#data-loading-1" id="toc-data-loading-1" class="nav-link" data-scroll-target="#data-loading-1"><span class="header-section-number">3.3.3</span> Data loading</a></li>
  <li><a href="#run-1" id="toc-run-1" class="nav-link" data-scroll-target="#run-1"><span class="header-section-number">3.3.4</span> Run</a></li>
  <li><a href="#evaluate-on-unseen-and-train_val-datasets" id="toc-evaluate-on-unseen-and-train_val-datasets" class="nav-link" data-scroll-target="#evaluate-on-unseen-and-train_val-datasets"><span class="header-section-number">3.3.5</span> Evaluate on unseen and train_val datasets</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#ensembling-models" id="toc-ensembling-models" class="nav-link" data-scroll-target="#ensembling-models"><span class="header-section-number">4</span> Ensembling models</a>
  <ul>
  <li><a href="#trained-ensemble-model" id="toc-trained-ensemble-model" class="nav-link" data-scroll-target="#trained-ensemble-model"><span class="header-section-number">4.1</span> Trained ensemble model</a>
  <ul>
  <li><a href="#trained-ensemble-training-pipeline" id="toc-trained-ensemble-training-pipeline" class="nav-link" data-scroll-target="#trained-ensemble-training-pipeline"><span class="header-section-number">4.1.0.1</span> Trained ensemble training pipeline</a></li>
  <li><a href="#run-2" id="toc-run-2" class="nav-link" data-scroll-target="#run-2"><span class="header-section-number">4.1.0.2</span> Run</a></li>
  <li><a href="#evaluation" id="toc-evaluation" class="nav-link" data-scroll-target="#evaluation"><span class="header-section-number">4.1.0.3</span> Evaluation</a></li>
  </ul></li>
  <li><a href="#pretrained-ensemble-model" id="toc-pretrained-ensemble-model" class="nav-link" data-scroll-target="#pretrained-ensemble-model"><span class="header-section-number">4.2</span> Pretrained ensemble model</a>
  <ul>
  <li><a href="#pretrained-ensemble-pipeline" id="toc-pretrained-ensemble-pipeline" class="nav-link" data-scroll-target="#pretrained-ensemble-pipeline"><span class="header-section-number">4.2.1</span> Pretrained ensemble pipeline</a></li>
  <li><a href="#training-1" id="toc-training-1" class="nav-link" data-scroll-target="#training-1"><span class="header-section-number">4.2.2</span> Training</a></li>
  <li><a href="#run-3" id="toc-run-3" class="nav-link" data-scroll-target="#run-3"><span class="header-section-number">4.2.3</span> Run</a></li>
  <li><a href="#evaluation-1" id="toc-evaluation-1" class="nav-link" data-scroll-target="#evaluation-1"><span class="header-section-number">4.2.4</span> Evaluation</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference"><span class="header-section-number">5</span> Inference</a>
  <ul>
  <li><a href="#data-preparation-2" id="toc-data-preparation-2" class="nav-link" data-scroll-target="#data-preparation-2"><span class="header-section-number">5.0.1</span> Data preparation</a></li>
  <li><a href="#pipeline" id="toc-pipeline" class="nav-link" data-scroll-target="#pipeline"><span class="header-section-number">5.0.2</span> Pipeline</a></li>
  <li><a href="#initialization-2" id="toc-initialization-2" class="nav-link" data-scroll-target="#initialization-2"><span class="header-section-number">5.1</span> Initialization</a></li>
  <li><a href="#run-4" id="toc-run-4" class="nav-link" data-scroll-target="#run-4"><span class="header-section-number">5.2</span> Run</a></li>
  </ul></li>
  <li><a href="#annexe" id="toc-annexe" class="nav-link" data-scroll-target="#annexe"><span class="header-section-number">6</span> Annexe</a></li>
  </ul>
</nav>
</div>
<main class="content column-page-left" id="quarto-document-content">




<section id="initialization" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Initialization</h1>
<div id="cea29b6f" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique indentifier specific to this execution</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>run_id <span class="op">=</span> <span class="bu">int</span>(time.time())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="64e5c9c8" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#! pip install tensorflow==2.15.0</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install <span class="op">-</span>q imblearn keras<span class="op">-</span>tuner tensorflow<span class="op">-</span>addons keras<span class="op">-</span>cv memory_profiler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="global-variables" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="global-variables"><span class="header-section-number">1.1</span> Global variables</h2>
<div id="95c1abbc" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Database configuration: Choose between 'dagshub_storage', 'google_drive', 'local'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>database <span class="op">=</span> <span class="st">'local'</span>  <span class="co"># Current choice: local</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Execution mode: Choose between 'CPU' or 'GPU'</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>execution_mode <span class="op">=</span> <span class="st">'GPU'</span>  <span class="co"># Current choice: GPU</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Execution environment: Choose between 'colab', 'mac'</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>execution_env <span class="op">=</span> <span class="st">'kaggle'</span>  <span class="co"># Current choice: colab</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Experimentation mode: Choose between 'test' or 'prod'</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>experimentation_mode <span class="op">=</span> <span class="st">'prod'</span>  <span class="co"># Current choice: test</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Training and Inference settings</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>train_all_models <span class="op">=</span> <span class="va">False</span>  <span class="co"># Train all models</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>run_inference <span class="op">=</span> <span class="va">True</span>  <span class="co"># Run inference</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>run_inference_use_all_models <span class="op">=</span> <span class="va">True</span>  <span class="co"># Run inference on all models</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>model_type <span class="op">=</span> <span class="st">'pretrained_ensemble_model'</span>  <span class="co"># Type of model to train, choose between 'single_model', 'pretrained_ensemble_model', 'compact_ensemble_model'</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>inference_model_name <span class="op">=</span> model_type  <span class="co"># Use the model_type as the inference model name</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset settings</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>download_raw_datasets <span class="op">=</span> <span class="va">False</span>  <span class="co"># Do not download raw datasets</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>download_refined_training_datasets <span class="op">=</span> <span class="va">True</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="va">False</span>  <span class="co"># Download refined datasets if running on Colab</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>dataset_size <span class="op">=</span> <span class="dv">20000</span>  <span class="co"># Set dataset size to 40,000 samples</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>create_new_training_datasets <span class="op">=</span> <span class="va">False</span>  <span class="co"># Do not create new training datasets</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="execution-strategy" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="execution-strategy"><span class="header-section-number">1.2</span> Execution strategy</h2>
<div id="dc01f464" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> mixed_precision</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> limit_memory_growth():</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    gpu_devices <span class="op">=</span> tf.config.experimental.list_physical_devices(<span class="st">'GPU'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gpu <span class="kw">in</span> gpu_devices:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            tf.config.experimental.set_memory_growth(gpu, <span class="va">True</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Can not set memory growth'</span>, e)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disable_eager_execution():</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    tf.compat.v1.disable_eager_execution()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> enable_xla():</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    tf.config.optimizer.set_jit(<span class="va">True</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> disable_gpu():</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    tf.config.set_visible_devices([], <span class="st">'GPU'</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    visible_devices <span class="op">=</span> tf.config.get_visible_devices()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> device <span class="kw">in</span> visible_devices:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> device.device_type <span class="op">!=</span> <span class="st">'GPU'</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> enable_mixed_precision():</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    policy <span class="op">=</span> mixed_precision.Policy(<span class="st">'mixed_float16'</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    mixed_precision.set_global_policy(policy)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Mixed precision enabled: "</span>, mixed_precision.global_policy())</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress all warnings in the notebook</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>limit_memory_growth()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">#enable_mixed_precision()</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">#tf.debugging.set_log_device_placement(True)</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">#tf.config.set_visible_devices([], 'GPU')</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>enable_xla()</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>tf.config.optimizer.set_experimental_options({</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"memory_optimization"</span>: <span class="va">True</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cf4bccbe" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_tpu_initialized():</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check if TPU is already initialized."""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    tpu_devices <span class="op">=</span> tf.config.list_logical_devices(<span class="st">'TPU'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(tpu_devices) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"TPU is already initialized with </span><span class="sc">{</span><span class="bu">len</span>(tpu_devices)<span class="sc">}</span><span class="ss"> logical devices."</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"TPU is not initialized."</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_tpu_strategy(force<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Set the TPU strategy if TPU is initialized."""</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> check_tpu_initialized() <span class="kw">and</span> <span class="kw">not</span> force:</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            resolver <span class="op">=</span> tf.distribute.cluster_resolver.TPUClusterResolver()   <span class="co"># TPU detection</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            strategy <span class="op">=</span> tf.distribute.TPUStrategy(resolver)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Using TPU strategy."</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> strategy</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error while setting TPU strategy: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Trying to initialize TPU."</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            resolver <span class="op">=</span> tf.distribute.cluster_resolver.TPUClusterResolver()</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            tf.config.experimental_connect_to_cluster(resolver)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            tf.tpu.experimental.initialize_tpu_system(resolver)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            strategy <span class="op">=</span> tf.distribute.TPUStrategy(resolver)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"TPU initialized and TPU strategy set."</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> strategy</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No TPU devices found."</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>strategy <span class="op">=</span> set_tpu_strategy(force <span class="op">=</span> execution_env <span class="op">==</span> <span class="st">'colab'</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>running_on_tpu <span class="op">=</span> strategy <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> strategy <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For GPUs or CPU</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tf.config.list_physical_devices(<span class="st">'GPU'</span>) <span class="kw">and</span> execution_mode <span class="op">==</span> <span class="st">'GPU'</span>:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      limit_memory_growth()</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      strategy <span class="op">=</span> tf.distribute.MirroredStrategy()</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      enable_mixed_precision() <span class="co"># Enable mixed precision policy</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">"Running on GPU"</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      strategy <span class="op">=</span> tf.distribute.get_strategy()</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">"Running on CPU"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="librairies-import" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="librairies-import"><span class="header-section-number">1.3</span> Librairies import</h2>
<div id="44ae4bb4" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core Libraries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> traceback</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> multiprocessing <span class="im">import</span> Pool</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow and Keras Imports</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow.keras.backend <span class="im">as</span> K</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> layers, Model, Input, regularizers, optimizers, callbacks</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> ReduceLROnPlateau, EarlyStopping, ModelCheckpoint</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers.experimental <span class="im">import</span> preprocessing</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> register_keras_serializable</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow Add-ons</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow_addons <span class="im">as</span> tfa</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Keras Tuner for Hyperparameter Optimization</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras_tuner <span class="im">as</span> kt</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras_tuner <span class="im">import</span> HyperModel</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras_tuner.tuners <span class="im">import</span> RandomSearch</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow Pretrained Models</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications <span class="im">import</span> (</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    EfficientNetB0, EfficientNetB4, EfficientNetB7,</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    DenseNet121, DenseNet169, DenseNet201,</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    InceptionV3, InceptionResNetV2,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    ResNet50, ResNet101, ResNet152V2,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    VGG16, VGG19, Xception</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Oversampling</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.over_sampling <span class="im">import</span> SMOTE</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Scikit-Learn Utilities</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    roc_curve, roc_auc_score, auc,</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    accuracy_score, classification_report, confusion_matrix</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> StratifiedShuffleSplit</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory Profiling</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> memory_profiler <span class="im">import</span> memory_usage</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization Libraries</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="database-setting" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="database-setting"><span class="header-section-number">1.4</span> Database setting</h2>
<div id="8fdb6929" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> download_refined_training_datasets:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> database <span class="op">==</span> <span class="st">'local'</span>:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">%</span>pip install <span class="op">-</span>q dagshub</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      <span class="im">import</span> dagshub.colab</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      DAGSHUB_REPO <span class="op">=</span> dagshub.colab.login()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> database <span class="op">==</span> <span class="st">'google_drive'</span>:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      drive.mount(<span class="st">'/content/drive'</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      ROOT_DB_DIR<span class="op">=</span><span class="st">'/content/drive/MyDrive/documents_travail'</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">%</span>pip install <span class="op">-</span>q dagshub</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      <span class="im">import</span> dagshub.colab</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      DAGSHUB_REPO <span class="op">=</span> dagshub.colab.login()</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      mount_path <span class="op">=</span> dagshub.storage.mount(DAGSHUB_REPO, cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f'Mount path: </span><span class="sc">{</span>mount_path<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      ROOT_DB_DIR<span class="op">=</span><span class="ss">f'/content/</span><span class="sc">{</span>mount_path<span class="sc">}</span><span class="ss">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-variables" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="training-variables"><span class="header-section-number">1.5</span> Training variables</h2>
<div id="8b9b2f0c" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define root directories based on the execution environment</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'mac'</span>: </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    ROOT_DB_DIR <span class="op">=</span> <span class="st">'/Users/amadou/local/datalab'</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> execution_env <span class="op">==</span> <span class="st">'kaggle'</span>: </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    ROOT_DB_DIR <span class="op">=</span> <span class="st">'/kaggle/'</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    ROOT_DB_DIR <span class="op">=</span> <span class="st">'/content'</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>input_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>ROOT_DB_DIR<span class="sc">}</span><span class="ss">/input'</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>ROOT_DB_DIR<span class="sc">}</span><span class="ss">/working'</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>cache_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/tf_cache'</span>  <span class="co"># Temporary cache directory for TensorFlow</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>project_dir <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/isic_2024"</span>  <span class="co"># Project-specific directory</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>tmp_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/tmp'</span>  <span class="co"># Temporary files directory</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>models_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/models'</span>  <span class="co"># Directory to save model files</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>pretrained_models_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>input_dir<span class="sc">}</span><span class="ss">/pretrained/tensorflow2/default/1/'</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Define dataset directories</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>datasets_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>input_dir<span class="sc">}</span><span class="ss">/datasets'</span>  <span class="co"># Root dataset directory</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>training_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>datasets_dir<span class="sc">}</span><span class="ss">/training'</span>  <span class="co"># Training data directory</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>training_metadata_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>training_dir<span class="sc">}</span><span class="ss">/metadata'</span>  <span class="co"># Metadata for training data</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Define directories for training data (positives and negatives)</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>train_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>datasets_dir<span class="sc">}</span><span class="ss">/training/train'</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>train_dir_pos <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>train_dir<span class="sc">}</span><span class="ss">/positives'</span>  <span class="co"># Positive training samples</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>train_dir_negs <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>train_dir<span class="sc">}</span><span class="ss">/negatives'</span>  <span class="co"># Negative training samples</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Define validation and evaluation data directories (positives and negatives)</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>val_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>datasets_dir<span class="sc">}</span><span class="ss">/training/val'</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>val_dir_pos <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>val_dir<span class="sc">}</span><span class="ss">/positives'</span>  <span class="co"># Positive validation samples</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>val_dir_negs <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>val_dir<span class="sc">}</span><span class="ss">/negatives'</span>  <span class="co"># Negative validation samples</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>eval_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>datasets_dir<span class="sc">}</span><span class="ss">/training/eval'</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>eval_dir_pos <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>eval_dir<span class="sc">}</span><span class="ss">/positives'</span>  <span class="co"># Positive evaluation samples</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>eval_dir_negs <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>eval_dir<span class="sc">}</span><span class="ss">/negatives'</span>  <span class="co"># Negative evaluation samples</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Define paths for inference</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>inference_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>project_dir<span class="sc">}</span><span class="ss">/inference'</span>  <span class="co"># Inference-related directory</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>inference_model_path <span class="op">=</span> os.path.join(models_dir, <span class="st">'inference_model.h5'</span>)  <span class="co"># Model for inference</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>inference_images_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>inference_dir<span class="sc">}</span><span class="ss">/images/hdf5'</span>  <span class="co"># Directory to source inference images</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>inference_images_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>inference_images_dir<span class="sc">}</span><span class="ss">/test-image.hdf5'</span>  <span class="co"># HDF5 file with test images</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>inference_metadata_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>inference_dir<span class="sc">}</span><span class="ss">/metadata'</span>  <span class="co"># Directory for inference metadata</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>inference_tabular_data_path <span class="op">=</span> os.path.join(inference_metadata_dir, <span class="st">'test-metadata.csv'</span>)  <span class="co"># Test metadata for tabular data</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>preprocessor_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>inference_dir<span class="sc">}</span><span class="ss">/preprocessor_</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">.pkl'</span>  <span class="co"># Preprocessor for inference</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Define TFRecord directories</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>tf_records_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>input_dir<span class="sc">}</span><span class="ss">/tf_records/</span><span class="sc">{</span>dataset_size<span class="sc">}</span><span class="ss">'</span> <span class="cf">if</span> experimentation_mode <span class="op">==</span> <span class="st">'test'</span> <span class="cf">else</span> <span class="ss">f'</span><span class="sc">{</span>input_dir<span class="sc">}</span><span class="ss">/sample-20k/sample_20k_kaggle'</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>tf_records_train_val_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>tf_records_dir<span class="sc">}</span><span class="ss">/train'</span>  <span class="co"># TFRecords for training</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>tf_records_val_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>tf_records_dir<span class="sc">}</span><span class="ss">/validation'</span>  <span class="co"># TFRecords for validation</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>tf_records_eval_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>tf_records_dir<span class="sc">}</span><span class="ss">/evaluation'</span>  <span class="co"># TFRecords for evaluation</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>oversample_persisted_data <span class="op">=</span> <span class="va">False</span>  <span class="co"># Oversample persisted data when creating tf_records</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Image and model settings</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>img_height <span class="op">=</span> <span class="dv">148</span>  <span class="co"># Height of the input images</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>img_width <span class="op">=</span> <span class="dv">148</span>  <span class="co"># Width of the input images</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>img_channels <span class="op">=</span> <span class="dv">3</span>  <span class="co"># Number of color channels</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>img_shape <span class="op">=</span> (img_height, img_width, img_channels)  <span class="co"># Shape of the input images (H x W x C)</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>image_size <span class="op">=</span> img_height  <span class="co"># Image size, set to height for consistency</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Training and evaluation settings</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>use_cross_validation <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to use cross-validation</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>augment_train_data <span class="op">=</span> <span class="va">True</span>  <span class="co"># Augment training data</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>use_tabular_data <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to include tabular data in the model</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>force_cache <span class="op">=</span> <span class="va">True</span>  <span class="co"># Force caching of data</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>cache_in_memory <span class="op">=</span> <span class="va">True</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="va">False</span>  <span class="co"># Cache in memory only for Colab</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>do_fine_tuning <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether to fine-tune the model</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>oversample_minority_class <span class="op">=</span> <span class="va">True</span>  <span class="co"># Oversample the minority class in imbalanced datasets</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>initial_epochs <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> experimentation_mode <span class="op">==</span> <span class="st">'test'</span> <span class="cf">else</span> <span class="dv">5</span>  <span class="co"># Initial epochs for training</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>fine_tune_epochs <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> experimentation_mode <span class="op">==</span> <span class="st">'test'</span> <span class="cf">else</span> <span class="dv">80</span>  <span class="co"># Epochs for fine-tuning</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>freeze_base_model <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to freeze the base model during training</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset buffering and shuffling</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>buffer_size <span class="op">=</span> <span class="dv">1000</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">700</span>  <span class="co"># Buffer size for data shuffling</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>shuffle_train_val_at_each_call <span class="op">=</span> <span class="va">True</span>  <span class="co"># Shuffle training/validation data at each call</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>train_file_pattern <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>tf_records_train_val_dir<span class="sc">}</span><span class="ss">/*.tfrecord'</span>  <span class="co"># Pattern to match TFRecord files</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Model and training configurations</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>model_name <span class="op">=</span> <span class="st">'res_net_50'</span>  <span class="co"># Name of the model to be used (ResNet50)</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>train_individuals <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to train individual models of the pretrained ensemble</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>run_evaluations <span class="op">=</span> <span class="va">False</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Batch size settings depending on environment and mode</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> experimentation_mode <span class="op">==</span> <span class="st">'test'</span>:</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    batch_size <span class="op">=</span> <span class="dv">16</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">16</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    val_batch_size <span class="op">=</span> <span class="dv">16</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">32</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    eval_batch_size <span class="op">=</span> <span class="dv">4</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">32</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    batch_size <span class="op">=</span> <span class="dv">128</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">128</span>  <span class="co"># Batch size varies between Colab and local</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    val_batch_size <span class="op">=</span> <span class="dv">128</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">128</span>  <span class="co"># Validation batch size</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    eval_batch_size <span class="op">=</span> <span class="dv">128</span> <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> <span class="dv">128</span>  <span class="co"># Evaluation batch size</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Model creation settings</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>dropout_rate <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>l2_lambda <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>num_tabular_features <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>kernel_initializer <span class="op">=</span> <span class="st">'he_normal'</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>activation <span class="op">=</span> <span class="st">'swish'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6349227c" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> create_new_training_datasets:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>rm <span class="op">-</span>rf {tf_records_dir}</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {tmp_dir}</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {sample_dir}</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {models_dir}</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {tf_records_train_val_dir}</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {tf_records_val_dir}</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {tf_records_eval_dir}</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {inference_dir}</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {inference_images_dir}</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p {inference_metadata_dir}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-preparation" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data preparation</h1>
<section id="preparation-utils" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="preparation-utils"><span class="header-section-number">2.1</span> Preparation utils</h2>
<section id="formatting-utils" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="formatting-utils"><span class="header-section-number">2.1.1</span> Formatting utils</h3>
<div id="55b25ad5" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Format all the metadatas to have the same structure</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_tabular_data(tabular_data_paths):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    tabular_dfs <span class="op">=</span> []</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> path <span class="kw">in</span> tabular_data_paths:</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        file_name <span class="op">=</span> os.path.basename(path)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> file_name <span class="op">==</span> <span class="st">'train_metadata_2024.csv'</span> <span class="kw">or</span> file_name <span class="op">==</span> <span class="st">'test-metadata.csv'</span>:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            metadata_2024 <span class="op">=</span> pd.read_csv(path, low_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            metadata_2024.fillna({<span class="st">'age_approx'</span>: metadata_2024.age_approx.median(), <span class="st">'sex'</span>: <span class="st">'unknown'</span>, <span class="st">'anatom_site_general'</span>: <span class="st">'unknown'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            tabular_dfs.append(metadata_2024[common_columns])</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> file_name <span class="op">==</span> <span class="st">'train_metadata_2020.csv'</span>:</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            metadata_2020 <span class="op">=</span> pd.read_csv(path, low_memory<span class="op">=</span><span class="va">False</span>).rename(columns<span class="op">=</span><span class="bu">dict</span>(<span class="bu">zip</span>(selected_2019_2020_columns, common_columns)))</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            metadata_2020.fillna({<span class="st">'age_approx'</span>: metadata_2020.age_approx.median(), <span class="st">'sex'</span>: <span class="st">'unknown'</span>, <span class="st">'anatom_site_general'</span>: <span class="st">'unknown'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            tabular_dfs.append(metadata_2020[common_columns])</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> file_name <span class="op">==</span> <span class="st">'train_metadata_2019.csv'</span>:</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>            metadata_2019 <span class="op">=</span> pd.read_csv(path, low_memory<span class="op">=</span><span class="va">False</span>).rename(columns<span class="op">=</span><span class="bu">dict</span>(<span class="bu">zip</span>(selected_2019_2020_columns, common_columns)))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            metadata_2019.fillna({<span class="st">'age_approx'</span>: metadata_2019.age_approx.median(), <span class="st">'anatom_site_general'</span>: <span class="st">'unknown'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            tabular_dfs.append(metadata_2019[common_columns])</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tabular_dfs</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Format and encode tabular data</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_and_encode_tabular_data(tabular_data_paths, train_images, preprocessor<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="st">'Formatting and encoding tabular data...'</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    tabular_data <span class="op">=</span> pd.concat(format_tabular_data(tabular_data_paths), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reindex tabular data to align with image IDs</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    train_tabular <span class="op">=</span> tabular_data.set_index(<span class="st">'isic_id'</span>).reindex(train_images).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> preprocessor <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the preprocessor if not provided (for training)</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Creating a new preprocessor to encode tabular data'</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        preprocessor <span class="op">=</span> fit_tabular_encoder(train_tabular)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        save_preprocessor(preprocessor, preprocessor_path)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        encoded_tabular_data <span class="op">=</span> encode_tabular_data(train_tabular, preprocessor)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Using provided preprocessor to encode tabular data'</span>)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        encoded_tabular_data <span class="op">=</span> encode_tabular_data(train_tabular, preprocessor)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> encoded_tabular_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="encoding-utils" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="encoding-utils"><span class="header-section-number">2.1.2</span> Encoding utils</h3>
<div id="c9d08d99" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the encoder for tabular data using dense format</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_tabular_encoder(tabular_data):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    num_cols <span class="op">=</span> [<span class="st">'age_approx'</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    one_hot_cols <span class="op">=</span> [<span class="st">'anatom_site_general'</span>, <span class="st">'sex'</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using dense format for OneHotEncoder</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'num'</span>, StandardScaler(), num_cols),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'cat'</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>, sparse_output<span class="op">=</span><span class="va">False</span>), one_hot_cols)  <span class="co"># Dense output</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    preprocessor.fit(tabular_data)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preprocessor</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode tabular data with dense format, called only after fit_tabular_encoder</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># or directely for val and eval data</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_tabular_data(tabular_data, preprocessor):</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the preprocessor to transform the tabular data into dense format</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preprocessor.transform(tabular_data)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Save and load preprocessor for reuse between training and inference</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_preprocessor(preprocessor, file_path):</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        pickle.dump(preprocessor, f)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Saved preprocessor at'</span>, file_path)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_preprocessor(file_path):</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        preprocessor <span class="op">=</span> pickle.load(f)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Loaded preprocessor from'</span>, file_path)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> preprocessor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="oversampling-utils" class="level3" data-number="2.1.3">
<h3 data-number="2.1.3" class="anchored" data-anchor-id="oversampling-utils"><span class="header-section-number">2.1.3</span> Oversampling utils</h3>
<div id="75708392" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally apply smote on the whole dataset to balance minority and majority</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> smote_oversampling(image_paths, labels, tabular_data):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply SMOTE to the labels and tabular data, with synchronized image resampling."""</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="st">"Applying SMOTE"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Separate image paths, labels, and tabular data by class</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    class_0_indices <span class="op">=</span> [i <span class="cf">for</span> i, label <span class="kw">in</span> <span class="bu">enumerate</span>(labels) <span class="cf">if</span> label <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    class_1_indices <span class="op">=</span> [i <span class="cf">for</span> i, label <span class="kw">in</span> <span class="bu">enumerate</span>(labels) <span class="cf">if</span> label <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    class_0_image_paths <span class="op">=</span> [image_paths[i] <span class="cf">for</span> i <span class="kw">in</span> class_0_indices]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    class_1_image_paths <span class="op">=</span> [image_paths[i] <span class="cf">for</span> i <span class="kw">in</span> class_1_indices]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        class_0_tabular <span class="op">=</span> tabular_data.iloc[class_0_indices].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        class_1_tabular <span class="op">=</span> tabular_data.iloc[class_1_indices].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        class_0_tabular <span class="op">=</span> class_1_tabular <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply SMOTE to the labels and tabular data</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    smote <span class="op">=</span> SMOTE(sampling_strategy<span class="op">=</span><span class="st">'minority'</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        oversampled_tabular_data, oversampled_labels <span class="op">=</span> smote.fit_resample(tabular_data, labels)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        dummy_data <span class="op">=</span> np.zeros((<span class="bu">len</span>(labels), <span class="dv">1</span>))</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        _, oversampled_labels <span class="op">=</span> smote.fit_resample(dummy_data, labels)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        oversampled_tabular_data <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare for synchronized resampling of image paths and tabular data</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    synthetic_image_paths <span class="op">=</span> []</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    synthetic_tabular_data <span class="op">=</span> []</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    class_0_count <span class="op">=</span> <span class="bu">len</span>(class_0_image_paths)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    class_1_count <span class="op">=</span> <span class="bu">len</span>(class_1_image_paths)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, label <span class="kw">in</span> <span class="bu">enumerate</span>(oversampled_labels):</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>            synthetic_image_paths.append(class_0_image_paths[idx <span class="op">%</span> class_0_count])</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                synthetic_tabular_data.append(class_0_tabular.iloc[idx <span class="op">%</span> class_0_count].values)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            synthetic_image_paths.append(class_1_image_paths[idx <span class="op">%</span> class_1_count])</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                synthetic_tabular_data.append(class_1_tabular.iloc[idx <span class="op">%</span> class_1_count].values)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure coherence by converting synthetic_tabular_data to DataFrame if needed</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        synthetic_tabular_data <span class="op">=</span> pd.DataFrame(synthetic_tabular_data, columns<span class="op">=</span>tabular_data.columns)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        synthetic_tabular_data <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return synchronized image paths, labels, and tabular data</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> synthetic_image_paths, oversampled_labels, synthetic_tabular_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subset-sampling-utils" class="level3" data-number="2.1.4">
<h3 data-number="2.1.4" class="anchored" data-anchor-id="subset-sampling-utils"><span class="header-section-number">2.1.4</span> Subset sampling utils</h3>
<div id="cd9ee784" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_data(image_paths, labels, tabular_data, sampling_fraction):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sample a subset of data for test purposes."""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="st">"Sampling data..."</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    sampled_indices <span class="op">=</span> np.random.choice(<span class="bu">len</span>(image_paths), <span class="bu">int</span>(<span class="bu">len</span>(image_paths) <span class="op">*</span> sampling_fraction), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    image_paths <span class="op">=</span> [image_paths[i] <span class="cf">for</span> i <span class="kw">in</span> sampled_indices]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> [labels[i] <span class="cf">for</span> i <span class="kw">in</span> sampled_indices]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        tabular_data <span class="op">=</span> tabular_data[sampled_indices]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image_paths, labels, tabular_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="serialization-utils" class="level3" data-number="2.1.5">
<h3 data-number="2.1.5" class="anchored" data-anchor-id="serialization-utils"><span class="header-section-number">2.1.5</span> Serialization utils</h3>
<div id="f6ede4ff" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data writing to tf_records for later reuse if working in cloud</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_dataset_to_tfrecords(image_paths, labels, tabular_data, output_prefix, num_workers, data_type<span class="op">=</span><span class="st">'train'</span>):</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Start writting </span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss"> tfrecords..."</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    chunk_size <span class="op">=</span> <span class="bu">len</span>(image_paths) <span class="op">//</span> num_workers</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"Number of workers: </span><span class="sc">{</span>num_workers<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"Dataset size: </span><span class="sc">{</span><span class="bu">len</span>(image_paths)<span class="sc">}</span><span class="ss">, chunk size: </span><span class="sc">{</span>chunk_size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> [</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>            image_paths[i:i <span class="op">+</span> chunk_size],</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            labels[i:i <span class="op">+</span> chunk_size],</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            tabular_data[i:i <span class="op">+</span> chunk_size] <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>output_prefix<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.tfrecord'</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(image_paths), chunk_size)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>num_workers) <span class="im">as</span> executor:</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        executor.<span class="bu">map</span>(write_tfrecord_single_batch, args)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_tfrecord_single_batch(args):</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Write a batch of data to a TFRecord file. This function processes images and optional tabular data,</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">    serializes them into a TFRecord format, and saves the result to a file.</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">        args: A tuple or list containing the following:</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">            - image_paths: List of file paths to the images (batch).</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">            - labels: List of corresponding labels for the images (batch).</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">            - tabular_data: Optional tabular data associated with the images (batch) (could be None).</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">            - output_file: Path to the output TFRecord file.</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        image_paths, labels, tabular_data, output_file <span class="op">=</span> args</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print which file is being written</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f"Writing TFRecords to: </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Specify compression options for the TFRecord (GZIP in this case)</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        options <span class="op">=</span> tf.io.TFRecordOptions(compression_type<span class="op">=</span><span class="st">"GZIP"</span>)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open a TFRecordWriter for writing data to the specified output file</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> tf.io.TFRecordWriter(output_file, options<span class="op">=</span>options) <span class="im">as</span> writer:</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Loop through each image and label in the batch</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, (img_path, label) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(image_paths, labels)):</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>                img_bytes <span class="op">=</span> process_image(img_path)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Convert the raw image into a feature that can be stored in the TFRecord</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>                img_feature <span class="op">=</span> tf.train.Feature(bytes_list<span class="op">=</span>tf.train.BytesList(value<span class="op">=</span>[img_bytes]))</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Convert the label into a feature (using int64 since it's a categorical label)</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>                label_feature <span class="op">=</span> tf.train.Feature(int64_list<span class="op">=</span>tf.train.Int64List(value<span class="op">=</span>[label]))</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create a dictionary to store the image and label as features</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>                features <span class="op">=</span> {<span class="st">'image'</span>: img_feature, <span class="st">'label'</span>: label_feature}</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If tabular data is used and provided, add it to the features dictionary</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> tabular_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Convert the tabular data to a float list feature for this specific sample</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                    tab_feature <span class="op">=</span> tf.train.Feature(float_list<span class="op">=</span>tf.train.FloatList(value<span class="op">=</span>tabular_data[i]))</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>                    features[<span class="st">'tabular_data'</span>] <span class="op">=</span> tab_feature</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create a TFRecord example from the features dictionary</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>                example <span class="op">=</span> tf.train.Example(features<span class="op">=</span>tf.train.Features(feature<span class="op">=</span>features))</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Serialize the example to a string and write it to the TFRecord file</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>                writer.write(example.SerializeToString())</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error in write_tfrecord: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        traceback.print_exc()</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_image(img_path):</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Helper function to read and process a single image."""</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>        img_bytes <span class="op">=</span> tf.io.read_file(img_path)</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img_bytes.numpy()  <span class="co"># Return the image bytes</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Error reading image </span><span class="sc">{</span>img_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-download-utils" class="level3" data-number="2.1.6">
<h3 data-number="2.1.6" class="anchored" data-anchor-id="data-download-utils"><span class="header-section-number">2.1.6</span> Data download utils</h3>
<div id="27f92ae3" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_folder_from_dagshub(boto_client, bucket_name, remote_folder, local_folder):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Downloads all files from a specified remote folder in DagsHub to a local folder.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">        boto_client: The boto client used to interact with DagsHub (S3-compatible).</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">        bucket_name: Name of the DagsHub repository (S3 bucket).</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">        remote_folder: The path to the folder in DagsHub (e.g., "kaggle/isic-2024/datasets/tf_records/sample_1k/validation/").</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">        local_folder: The path to the local folder where files will be downloaded.</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure local folder exists</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    os.makedirs(local_folder, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all files in the remote folder</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> boto_client.list_objects_v2(Bucket<span class="op">=</span>bucket_name, Prefix<span class="op">=</span>remote_folder)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are contents in the folder</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Contents'</span> <span class="kw">in</span> response:</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> obj <span class="kw">in</span> response[<span class="st">'Contents'</span>]:</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>            remote_file_path <span class="op">=</span> obj[<span class="st">'Key'</span>]</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            local_file_path <span class="op">=</span> os.path.join(local_folder, os.path.basename(remote_file_path))</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Download each file</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>remote_file_path<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>local_file_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>            boto_client.download_file(</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>                Bucket<span class="op">=</span>bucket_name,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>                Key<span class="op">=</span>remote_file_path,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>                Filename<span class="op">=</span>local_file_path</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Download completed!"</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"No files found in the folder: </span><span class="sc">{</span>remote_folder<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> resolve_remote_folder(local_folder):</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> local_folder.replace(<span class="ss">f'</span><span class="sc">{</span>ROOT_DB_DIR<span class="sc">}</span><span class="ss">/'</span>, <span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preparation-pipeline" class="level3" data-number="2.1.7">
<h3 data-number="2.1.7" class="anchored" data-anchor-id="preparation-pipeline"><span class="header-section-number">2.1.7</span> Preparation pipeline</h3>
<div id="6cfae9e3" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, MinMaxScaler, StandardScaler, OrdinalEncoder</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.sparse <span class="im">import</span> vstack, csr_matrix</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, StandardScaler</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>common_columns <span class="op">=</span> [<span class="st">'isic_id'</span>, <span class="st">'age_approx'</span>, <span class="st">'sex'</span>, <span class="st">'anatom_site_general'</span>]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>selected_2019_2020_columns <span class="op">=</span> [<span class="st">'image_name'</span>, <span class="st">'age_approx'</span>, <span class="st">'sex'</span>, <span class="st">'anatom_site_general_challenge'</span>]</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparing data directories using dense tabular data format</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_data_directories(train_dir, tabular_data_paths, sampling_fraction<span class="op">=</span><span class="fl">1.0</span>, use_oversampling<span class="op">=</span><span class="va">False</span>, data_type<span class="op">=</span><span class="st">'train'</span>):</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load image paths, labels, and optionally tabular data"""</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Start </span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss"> data preparation..."</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    train_image_paths <span class="op">=</span> glob(os.path.join(train_dir, <span class="st">'**'</span>, <span class="st">'*.jpg'</span>), recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    train_labels <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> os.path.dirname(path).endswith(<span class="st">'positives'</span>) <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> path <span class="kw">in</span> train_image_paths]</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    train_images <span class="op">=</span> [os.path.basename(path).split(<span class="st">'.'</span>)[<span class="dv">0</span>] <span class="cf">for</span> path <span class="kw">in</span> train_image_paths]</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    data_type <span class="op">=</span> data_type.capitalize()</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss"> labels length before preparing data"</span>, <span class="bu">len</span>(train_labels))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load the preprocessor for validation or fit it for training data</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        preprocessor <span class="op">=</span> <span class="va">None</span> <span class="cf">if</span> data_type <span class="op">==</span> <span class="st">'Train'</span> <span class="cf">else</span> load_preprocessor(preprocessor_path)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        train_tabular <span class="op">=</span> format_and_encode_tabular_data(tabular_data_paths, train_images, preprocessor<span class="op">=</span>preprocessor)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        train_tabular <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># oversample only train data</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_oversampling:</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        train_image_paths, train_labels, train_tabular <span class="op">=</span> smote_oversampling(</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>            train_image_paths, train_labels, train_tabular</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss"> data size after oversampling:"</span>, <span class="bu">len</span>(train_labels))</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sample all the datasets if sampling is needed</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sampling_fraction <span class="op">&lt;</span> <span class="fl">1.0</span>:</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        train_image_paths, train_labels, train_tabular <span class="op">=</span> sample_data(</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>            train_image_paths, train_labels, train_tabular, sampling_fraction</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss"> data size after subsampling:"</span>, <span class="bu">len</span>(train_labels))</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> train_tabular <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>        tabular_data_length <span class="op">=</span> train_tabular.shape[<span class="dv">0</span>]</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Image data size: </span><span class="sc">{</span><span class="bu">len</span>(train_image_paths)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Tabular data size: </span><span class="sc">{</span>tabular_data_length<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure that the number of tabular rows matches the number of image paths</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(train_image_paths) <span class="op">==</span> tabular_data_length, <span class="st">"Image paths and tabular data do not match"</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (train_image_paths, train_labels, train_tabular)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="run" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="run"><span class="header-section-number">2.2</span> Run</h2>
<section id="download-raw-datasets" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="download-raw-datasets"><span class="header-section-number">2.2.1</span> Download raw datasets</h3>
<div id="f3e7bbf6" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> download_raw_datasets:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    boto_client <span class="op">=</span> get_repo_bucket_client(<span class="st">"AmadouMamane/dagshub-drive"</span>, flavor<span class="op">=</span><span class="st">"boto"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(eval_dir_pos), eval_dir_pos)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(eval_dir_negs), eval_dir_negs)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(val_dir_pos), val_dir_pos)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(val_dir_negs), val_dir_negs)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(train_dir_pos), train_dir_pos)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(train_dir_negs), train_dir_negs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-refined-datasets" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="download-refined-datasets"><span class="header-section-number">2.2.2</span> Download refined datasets</h3>
<div id="f038ea39" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> download_refined_training_datasets:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    boto_client <span class="op">=</span> get_repo_bucket_client(<span class="st">"AmadouMamane/dagshub-drive"</span>, flavor<span class="op">=</span><span class="st">"boto"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(tf_records_eval_dir), tf_records_eval_dir)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(tf_records_val_dir), tf_records_val_dir)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    download_folder_from_dagshub(boto_client, <span class="st">"dagshub-drive"</span>, resolve_remote_folder(tf_records_train_val_dir), tf_records_train_val_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation-1" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="data-preparation-1"><span class="header-section-number">2.2.3</span> Data preparation</h3>
<div id="2f7bc133" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare and process data</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>num_workers <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#total_samples = #49403 + 12100 + 4389 =65892</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> create_new_training_datasets:</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    sampling_fraction <span class="op">=</span> dataset_size <span class="op">/</span> <span class="dv">65892</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    metadata_2024_path <span class="op">=</span> os.path.join(<span class="ss">f'</span><span class="sc">{</span>training_metadata_dir<span class="sc">}</span><span class="ss">'</span>, <span class="st">'train_metadata_2024.csv'</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    metadata_2020_path <span class="op">=</span> os.path.join(<span class="ss">f'</span><span class="sc">{</span>training_metadata_dir<span class="sc">}</span><span class="ss">'</span>, <span class="st">'train_metadata_2020.csv'</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    metadata_2019_path <span class="op">=</span> os.path.join(<span class="ss">f'</span><span class="sc">{</span>training_metadata_dir<span class="sc">}</span><span class="ss">'</span>, <span class="st">'train_metadata_2019.csv'</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    tabular_data_paths <span class="op">=</span> [metadata_2024_path, metadata_2020_path, metadata_2019_path]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    (train_image_paths, train_labels, train_tabular) <span class="op">=</span> prepare_data_directories(train_dir, tabular_data_paths, sampling_fraction<span class="op">=</span>sampling_fraction, use_oversampling<span class="op">=</span>oversample_persisted_data, data_type<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    (eval_image_paths, eval_labels, eval_tabular) <span class="op">=</span> prepare_data_directories(eval_dir, tabular_data_paths, sampling_fraction<span class="op">=</span>sampling_fraction, use_oversampling<span class="op">=</span>oversample_persisted_data, data_type<span class="op">=</span><span class="st">'eval'</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    (val_image_paths, val_labels, val_tabular) <span class="op">=</span> prepare_data_directories(val_dir, tabular_data_paths, sampling_fraction<span class="op">=</span>sampling_fraction, use_oversampling<span class="op">=</span>oversample_persisted_data, data_type<span class="op">=</span><span class="st">'Val'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-serialization" class="level3" data-number="2.2.4">
<h3 data-number="2.2.4" class="anchored" data-anchor-id="data-serialization"><span class="header-section-number">2.2.4</span> Data serialization</h3>
<div id="1993ff13" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> create_new_training_datasets:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    write_dataset_to_tfrecords(eval_image_paths, eval_labels, eval_tabular, <span class="ss">f'</span><span class="sc">{</span>tf_records_eval_dir<span class="sc">}</span><span class="ss">/eval'</span>, num_workers<span class="op">=</span>num_workers, data_type<span class="op">=</span><span class="st">'train'</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    write_dataset_to_tfrecords(val_image_paths, val_labels, val_tabular, <span class="ss">f'</span><span class="sc">{</span>tf_records_val_dir<span class="sc">}</span><span class="ss">/val'</span>, num_workers<span class="op">=</span>num_workers, data_type<span class="op">=</span><span class="st">'eval'</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    write_dataset_to_tfrecords(train_image_paths, train_labels, train_tabular, <span class="ss">f'</span><span class="sc">{</span>tf_records_train_val_dir<span class="sc">}</span><span class="ss">/train'</span>, num_workers<span class="op">=</span>num_workers, data_type<span class="op">=</span><span class="st">'Val'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Number of train and val positives class samples'</span>, train_labels.count(<span class="dv">1</span>))</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Number of val positives class samples'</span>, val_labels.count(<span class="dv">1</span>))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Number of eval positives class samples'</span>, eval_labels.count(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-augmentation" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="data-augmentation"><span class="header-section-number">2.3</span> Data augmentation</h2>
<section id="random-hue-saturation" class="level4" data-number="2.3.0.1">
<h4 data-number="2.3.0.1" class="anchored" data-anchor-id="random-hue-saturation"><span class="header-section-number">2.3.0.1</span> Random hue saturation</h4>
<div id="352e6e0a" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sat_max_delta_hs<span class="op">=</span><span class="fl">0.0005</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>hue_max_delta_hs<span class="op">=</span><span class="fl">0.0005</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>val_max_delta_hs<span class="op">=</span><span class="fl">0.0005</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_hue_saturation(image, hue_max_delta<span class="op">=</span>hue_max_delta_hs, sat_max_delta<span class="op">=</span>sat_max_delta_hs, val_max_delta<span class="op">=</span>val_max_delta_hs, probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_hue_sat_val(img):</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.random_hue(img, max_delta<span class="op">=</span>hue_max_delta)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.random_saturation(img, lower<span class="op">=</span><span class="dv">1</span> <span class="op">-</span> sat_max_delta, upper<span class="op">=</span><span class="dv">1</span> <span class="op">+</span> sat_max_delta)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.random_brightness(img, max_delta<span class="op">=</span>val_max_delta)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.clip_by_value(img, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_hue_sat_val(image),</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-shift-scale-rotate" class="level4" data-number="2.3.0.2">
<h4 data-number="2.3.0.2" class="anchored" data-anchor-id="random-shift-scale-rotate"><span class="header-section-number">2.3.0.2</span> Random shift scale rotate</h4>
<div id="076fced9" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_shift_scale_rotate(image, shift_limit<span class="op">=</span><span class="fl">0.05</span>, scale_limit<span class="op">=</span><span class="fl">0.05</span>, rotate_limit<span class="op">=</span><span class="dv">5</span>, threshold<span class="op">=</span><span class="fl">0.5</span>, image_size<span class="op">=</span>image_size, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_shift_scale_rotate(img, seed):</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        angle_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        scale_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        dx_seed <span class="op">=</span> seeds[<span class="dv">3</span>]</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        dy_seed <span class="op">=</span> seeds[<span class="dv">4</span>]</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Random rotation</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> tf.random.stateless_uniform([], <span class="op">-</span>rotate_limit, rotate_limit, seed<span class="op">=</span>angle_seed) <span class="op">*</span> <span class="fl">3.14159265</span> <span class="op">/</span> <span class="dv">180</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.rot90(img, k<span class="op">=</span>tf.cast(angle <span class="op">/</span> (<span class="fl">3.14159265</span> <span class="op">/</span> <span class="dv">2</span>), tf.int32))</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Random scaling</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> tf.random.stateless_uniform([], <span class="dv">1</span> <span class="op">-</span> scale_limit, <span class="dv">1</span> <span class="op">+</span> scale_limit, seed<span class="op">=</span>scale_seed)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        new_size <span class="op">=</span> tf.cast(tf.cast(tf.shape(img)[<span class="dv">0</span>:<span class="dv">2</span>], tf.float32) <span class="op">*</span> scale, tf.int32)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.resize(img, new_size)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Random shifting</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        max_dx <span class="op">=</span> tf.cast(shift_limit <span class="op">*</span> tf.cast(tf.shape(img)[<span class="dv">1</span>], tf.float32), tf.int32)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        max_dy <span class="op">=</span> tf.cast(shift_limit <span class="op">*</span> tf.cast(tf.shape(img)[<span class="dv">0</span>], tf.float32), tf.int32)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">=</span> tf.random.stateless_uniform([], <span class="op">-</span>max_dx, max_dx, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>dx_seed)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> tf.random.stateless_uniform([], <span class="op">-</span>max_dy, max_dy, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>dy_seed)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        target_height <span class="op">=</span> tf.minimum(image_size, new_size[<span class="dv">0</span>] <span class="op">-</span> tf.<span class="bu">abs</span>(dy))</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        target_width <span class="op">=</span> tf.minimum(image_size, new_size[<span class="dv">1</span>] <span class="op">-</span> tf.<span class="bu">abs</span>(dx))</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.crop_to_bounding_box(</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            img,</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            offset_height<span class="op">=</span>tf.maximum(<span class="dv">0</span>, dy),</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>            offset_width<span class="op">=</span>tf.maximum(<span class="dv">0</span>, dx),</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>            target_height<span class="op">=</span>target_height,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            target_width<span class="op">=</span>target_width</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resize back to original size</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.resize_with_crop_or_pad(img, target_height<span class="op">=</span>image_size, target_width<span class="op">=</span>image_size)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), threshold),</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_shift_scale_rotate(image, seed),</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-crop" class="level4" data-number="2.3.0.3">
<h4 data-number="2.3.0.3" class="anchored" data-anchor-id="random-crop"><span class="header-section-number">2.3.0.3</span> Random crop</h4>
<div id="c38e3bc8" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_crop(image, min_crop_size_ratio<span class="op">=</span><span class="fl">0.7</span>, max_crop_size_ratio<span class="op">=</span><span class="fl">1.0</span>, probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_random_crop_per_image(img):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        img_shape <span class="op">=</span> tf.shape(img)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> img_shape[<span class="dv">0</span>]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> img_shape[<span class="dv">1</span>]</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        crop_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        size_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        y_seed <span class="op">=</span> seeds[<span class="dv">2</span>]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        x_seed <span class="op">=</span> seeds[<span class="dv">3</span>]</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Randomly determine the crop size ratio within the given range using the seed</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        crop_size_ratio <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>min_crop_size_ratio, maxval<span class="op">=</span>max_crop_size_ratio, seed<span class="op">=</span>size_seed)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the crop size based on the randomly chosen ratio</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        crop_height <span class="op">=</span> tf.cast(crop_size_ratio <span class="op">*</span> tf.cast(height, tf.float32), tf.int32)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        crop_width <span class="op">=</span> tf.cast(crop_size_ratio <span class="op">*</span> tf.cast(width, tf.float32), tf.int32)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        y_maxval <span class="op">=</span> tf.maximum(height <span class="op">-</span> crop_height, <span class="dv">1</span>)  <span class="co"># Ensure maxval is &gt; min_val</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        x_maxval <span class="op">=</span> tf.maximum(width <span class="op">-</span> crop_width, <span class="dv">1</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Randomly select the top-left corner of the crop using the seed</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        y1 <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>x_maxval, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>y_seed)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>y_maxval, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>x_seed)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define the bottom-right corner of the crop</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        y2 <span class="op">=</span> y1 <span class="op">+</span> crop_height</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> x1 <span class="op">+</span> crop_width</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Crop the image</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        cropped_img <span class="op">=</span> img[y1:y2, x1:x2, :]</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set a static shape for cropped image if necessary before resizing (adjust as needed)</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        cropped_img.set_shape([<span class="va">None</span>, <span class="va">None</span>, img.shape[<span class="op">-</span><span class="dv">1</span>]])</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resize the cropped image back to the original size</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        cropped_img <span class="op">=</span> tf.image.resize(cropped_img, [height, width], method<span class="op">=</span><span class="st">'bilinear'</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cropped_img</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Use stateless random to generate a seed if none is provided</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply random crop with the specified probability</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_random_crop_per_image(image),</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-cutout" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="random-cutout"><span class="header-section-number">2.3.1</span> Random cutout</h3>
<div id="65041e5c" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_cutout(image, max_cutout_size_ratio<span class="op">=</span><span class="fl">0.3</span>, probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_cutout(img):</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        img_shape <span class="op">=</span> tf.shape(img)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> img_shape[<span class="op">-</span><span class="dv">3</span>]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> img_shape[<span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        cutout_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        x_center_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        y_center_seed <span class="op">=</span> seeds[<span class="dv">2</span>]</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate the cutout size using a stateless random function with a seed</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        cutout_size <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>max_cutout_size_ratio, dtype<span class="op">=</span>tf.float32, seed<span class="op">=</span>cutout_seed) <span class="op">*</span> tf.cast(tf.minimum(height, width), tf.float32)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        cutout_size <span class="op">=</span> tf.cast(cutout_size, tf.int32)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Randomly select the center position of the cutout using the seed</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        x_center <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>width, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>x_center_seed)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        y_center <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span>height, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>y_center_seed)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define the top-left and bottom-right corners of the cutout</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        x1 <span class="op">=</span> tf.clip_by_value(x_center <span class="op">-</span> cutout_size <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, width)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        y1 <span class="op">=</span> tf.clip_by_value(y_center <span class="op">-</span> cutout_size <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, height)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        x2 <span class="op">=</span> tf.clip_by_value(x_center <span class="op">+</span> cutout_size <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, width)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        y2 <span class="op">=</span> tf.clip_by_value(y_center <span class="op">+</span> cutout_size <span class="op">//</span> <span class="dv">2</span>, <span class="dv">0</span>, height)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the cutout mask</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> tf.ones_like(img)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>        x_range <span class="op">=</span> tf.<span class="bu">range</span>(x1, x2)</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        y_range <span class="op">=</span> tf.<span class="bu">range</span>(y1, y2)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate all the coordinates to update in the mask</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        y_grid, x_grid <span class="op">=</span> tf.meshgrid(y_range, x_range)</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>        coords <span class="op">=</span> tf.stack([y_grid, x_grid], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>        coords <span class="op">=</span> tf.reshape(coords, [<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update the mask with zeros at the selected coordinates</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> tf.tensor_scatter_nd_update(mask, coords, tf.zeros([tf.shape(coords)[<span class="dv">0</span>], img_shape[<span class="op">-</span><span class="dv">1</span>]], dtype<span class="op">=</span>img.dtype))</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply the mask to the image</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img <span class="op">*</span> mask</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use stateless random to generate a seed if none is provided</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply cutout with the specified probability</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_cutout(image),</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>      )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="distorsions" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="distorsions"><span class="header-section-number">2.3.2</span> Distorsions</h3>
<section id="random-elastic-transform" class="level4" data-number="2.3.2.1">
<h4 data-number="2.3.2.1" class="anchored" data-anchor-id="random-elastic-transform"><span class="header-section-number">2.3.2.1</span> Random elastic transform</h4>
<div id="722626ae" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_elastic_transform(image, alpha_range<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">3</span>), sigma_range<span class="op">=</span>(<span class="fl">0.8</span>, <span class="dv">2</span>), padding_size_range<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">15</span>),  probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use stateless random to generate a seed if none is provided</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate random values for alpha, sigma, and padding_size from their respective ranges</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>alpha_range[<span class="dv">0</span>], maxval<span class="op">=</span>alpha_range[<span class="dv">1</span>], seed<span class="op">=</span>seed)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>sigma_range[<span class="dv">0</span>], maxval<span class="op">=</span>sigma_range[<span class="dv">1</span>], seed<span class="op">=</span>seed)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    padding_size <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>padding_size_range[<span class="dv">0</span>], maxval<span class="op">=</span>padding_size_range[<span class="dv">1</span>], seed<span class="op">=</span>seed, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_elastic_transform(img):</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cast(img, tf.float32)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        height, width, channels <span class="op">=</span> tf.shape(img)[<span class="dv">0</span>], tf.shape(img)[<span class="dv">1</span>], tf.shape(img)[<span class="dv">2</span>]</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pad the image to reduce boundary artifacts</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        img_padded <span class="op">=</span> tf.pad(img, [[padding_size, padding_size], [padding_size, padding_size], [<span class="dv">0</span>, <span class="dv">0</span>]], mode<span class="op">=</span><span class="st">'REFLECT'</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update dimensions after padding</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        padded_height, padded_width <span class="op">=</span> tf.shape(img_padded)[<span class="dv">0</span>], tf.shape(img_padded)[<span class="dv">1</span>]</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Split seed for reproducibility</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        dx_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        dy_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate random displacement fields</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">=</span> tf.random.stateless_normal([padded_height, padded_width], mean<span class="op">=</span><span class="fl">0.0</span>, stddev<span class="op">=</span>sigma, seed<span class="op">=</span>dx_seed)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> tf.random.stateless_normal([padded_height, padded_width], mean<span class="op">=</span><span class="fl">0.0</span>, stddev<span class="op">=</span>sigma, seed<span class="op">=</span>dy_seed)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth the displacement fields</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        kernel_size <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> tf.ones((kernel_size, kernel_size, <span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">/</span> (kernel_size <span class="op">*</span> kernel_size)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">=</span> tf.nn.depthwise_conv2d(tf.expand_dims(tf.expand_dims(dx, axis<span class="op">=-</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>), kernel, strides<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], padding<span class="op">=</span><span class="st">"SAME"</span>)[<span class="dv">0</span>, ..., <span class="dv">0</span>]</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">=</span> tf.nn.depthwise_conv2d(tf.expand_dims(tf.expand_dims(dy, axis<span class="op">=-</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>), kernel, strides<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], padding<span class="op">=</span><span class="st">"SAME"</span>)[<span class="dv">0</span>, ..., <span class="dv">0</span>]</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Scale the displacement fields</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        dx <span class="op">*=</span> alpha</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        dy <span class="op">*=</span> alpha</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate meshgrid and add the displacements</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        xs, ys <span class="op">=</span> tf.meshgrid(tf.<span class="bu">range</span>(padded_width), tf.<span class="bu">range</span>(padded_height))</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        xs <span class="op">=</span> tf.cast(xs, tf.float32) <span class="op">+</span> dx</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        ys <span class="op">=</span> tf.cast(ys, tf.float32) <span class="op">+</span> dy</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clip the values to be within image dimensions</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        xs <span class="op">=</span> tf.clip_by_value(xs, <span class="fl">0.0</span>, tf.cast(padded_width <span class="op">-</span> <span class="dv">1</span>, tf.float32))</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>        ys <span class="op">=</span> tf.clip_by_value(ys, <span class="fl">0.0</span>, tf.cast(padded_height <span class="op">-</span> <span class="dv">1</span>, tf.float32))</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resample using the distorted coordinates</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        distorted_indices <span class="op">=</span> tf.stack([ys, xs], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>        distorted_image_padded <span class="op">=</span> tf.gather_nd(img_padded, tf.cast(distorted_indices, tf.int32))</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove padding by cropping back to the original image size</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>        distorted_image <span class="op">=</span> distorted_image_padded[padding_size:padding_size <span class="op">+</span> height, padding_size:padding_size <span class="op">+</span> width, :]</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> distorted_image</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_elastic_transform(image),</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-grid-distortion" class="level4" data-number="2.3.2.2">
<h4 data-number="2.3.2.2" class="anchored" data-anchor-id="random-grid-distortion"><span class="header-section-number">2.3.2.2</span> Random grid distortion</h4>
<div id="a95a56a4" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_grid_distortion(image, num_steps<span class="op">=</span><span class="dv">10</span>, distort_limit<span class="op">=</span><span class="fl">0.05</span>, probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>             <span class="co"># Use stateless random to generate a seed if none is provided</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_grid_distortion(img):</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        img_shape <span class="op">=</span> tf.shape(img)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> tf.cast(img_shape[<span class="dv">0</span>], tf.float32)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> tf.cast(img_shape[<span class="dv">1</span>], tf.float32)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define grid step size</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        x_step <span class="op">=</span> tf.cast(width <span class="op">//</span> num_steps, tf.float32)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        y_step <span class="op">=</span> tf.cast(height <span class="op">//</span> num_steps, tf.float32)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verification for tf.random.stateless_uniform so that min_val and mx_val != 0</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        x_step <span class="op">=</span> tf.cond(x_step <span class="op">&gt;</span> <span class="dv">0</span>, <span class="kw">lambda</span>: x_step, <span class="kw">lambda</span>: tf.constant(<span class="fl">1e-7</span>))</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        y_step <span class="op">=</span> tf.cond(y_step <span class="op">&gt;</span> <span class="dv">0</span>, <span class="kw">lambda</span>: y_step, <span class="kw">lambda</span>: tf.constant(<span class="fl">1e-7</span>))</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        x_offsets_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        y_offsets_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate random offsets</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        x_offsets <span class="op">=</span> tf.random.stateless_uniform(</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>            shape<span class="op">=</span>[num_steps <span class="op">+</span> <span class="dv">1</span>, num_steps <span class="op">+</span> <span class="dv">1</span>],</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>            minval<span class="op">=-</span>distort_limit <span class="op">*</span> x_step,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>            maxval<span class="op">=</span>distort_limit <span class="op">*</span> x_step,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>            dtype<span class="op">=</span>tf.float32,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>x_offsets_seed</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        y_offsets <span class="op">=</span> tf.random.stateless_uniform(</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>            shape<span class="op">=</span>[num_steps <span class="op">+</span> <span class="dv">1</span>, num_steps <span class="op">+</span> <span class="dv">1</span>],</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>            minval<span class="op">=-</span>distort_limit <span class="op">*</span> y_step,</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>            maxval<span class="op">=</span>distort_limit <span class="op">*</span> y_step,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>            dtype<span class="op">=</span>tf.float32,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>            seed<span class="op">=</span>y_offsets_seed</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create grid of coordinates</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> tf.linspace(<span class="fl">0.0</span>, width, num_steps <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> tf.linspace(<span class="fl">0.0</span>, height, num_steps <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>        x_t, y_t <span class="op">=</span> tf.meshgrid(x, y)</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply offsets</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> x_t <span class="op">+</span> x_offsets</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>        y_t <span class="op">=</span> y_t <span class="op">+</span> y_offsets</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interpolate to get dense flow field</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>        x_interp <span class="op">=</span> tf.image.resize(x_t[..., tf.newaxis], [height, width], method<span class="op">=</span><span class="st">'bilinear'</span>)</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>        y_interp <span class="op">=</span> tf.image.resize(y_t[..., tf.newaxis], [height, width], method<span class="op">=</span><span class="st">'bilinear'</span>)</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack and subtract identity grid</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>        flow <span class="op">=</span> tf.stack([y_interp[..., <span class="dv">0</span>] <span class="op">-</span> tf.<span class="bu">range</span>(height)[:, <span class="va">None</span>],</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>                         x_interp[..., <span class="dv">0</span>] <span class="op">-</span> tf.<span class="bu">range</span>(width)[<span class="va">None</span>, :]], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply flow to image</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>        distorted_image <span class="op">=</span> tfa.image.dense_image_warp(img[tf.newaxis, ...], flow[tf.newaxis, ...])[<span class="dv">0</span>]</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> distorted_image</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_grid_distortion(image),</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-optical-distortion" class="level4" data-number="2.3.2.3">
<h4 data-number="2.3.2.3" class="anchored" data-anchor-id="random-optical-distortion"><span class="header-section-number">2.3.2.3</span> Random optical distortion</h4>
<div id="8450b605" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define distortion parameters</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>distort_limit_do <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>shift_limit_do <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define augmentation layers outside the tf.function</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>random_rotation <span class="op">=</span> preprocessing.RandomRotation(factor<span class="op">=</span>distort_limit_do)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>random_translation <span class="op">=</span> preprocessing.RandomTranslation(height_factor<span class="op">=</span>shift_limit_do,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                                                     width_factor<span class="op">=</span>shift_limit_do)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>random_zoom <span class="op">=</span> preprocessing.RandomZoom(height_factor<span class="op">=</span>(<span class="op">-</span>distort_limit_do, distort_limit_do),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                                       width_factor<span class="op">=</span>(<span class="op">-</span>distort_limit_do, distort_limit_do))</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_optical_distortion(image, probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_optical_distortion(img):</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply the augmentations</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> random_rotation(img, training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> random_translation(img, training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> random_zoom(img, training<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If seed is provided, split it for reproducible randomness</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_optical_distortion(image),</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-one-of-distorsion" class="level4" data-number="2.3.2.4">
<h4 data-number="2.3.2.4" class="anchored" data-anchor-id="random-one-of-distorsion"><span class="header-section-number">2.3.2.4</span> Random one of distorsion</h4>
<div id="2d54fb1f" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>distort_limit_do <span class="op">=</span><span class="fl">0.0005</span> <span class="co"># defined oon function definition also</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>shift_limit_do <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>num_steps_dg<span class="op">=</span><span class="dv">10</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>distort_limit_dg<span class="op">=</span><span class="fl">0.05</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>alpha_range_de <span class="op">=</span> (<span class="fl">0.5</span>,<span class="fl">1.5</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>sigma_range_de <span class="op">=</span>(<span class="fl">0.5</span>,<span class="fl">1.0</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>padding_size_range_de <span class="op">=</span> (<span class="dv">5</span>,<span class="dv">10</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_one_of_distortion(image, probability<span class="op">=</span><span class="fl">0.7</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate seed if not provided</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_random_transform(img, seed):</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate a random choice for distortion transformation</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        choice <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">2</span>, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>seed)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply random distortions based on the choice</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#img = tf.cond(choice == 0, lambda: random_optical_distortion(img, probability=1.0, seed=None), lambda: img)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(choice <span class="op">==</span> <span class="dv">0</span>, <span class="kw">lambda</span>: random_grid_distortion(img, num_steps<span class="op">=</span>num_steps_dg, distort_limit<span class="op">=</span>distort_limit_dg, probability<span class="op">=</span><span class="fl">1.0</span>, seed<span class="op">=</span><span class="va">None</span>), <span class="kw">lambda</span>: img)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(choice <span class="op">==</span> <span class="dv">1</span>, <span class="kw">lambda</span>: random_elastic_transform(img, alpha_range<span class="op">=</span>alpha_range_de, sigma_range<span class="op">=</span>sigma_range_de, padding_size_range<span class="op">=</span>padding_size_range_de, probability<span class="op">=</span><span class="fl">1.0</span>, seed<span class="op">=</span><span class="va">None</span>), <span class="kw">lambda</span>: img)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply transformation based on the probability</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_random_transform(image, seed),</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="blurings" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="blurings"><span class="header-section-number">2.3.3</span> Blurings</h3>
<div id="68715e1a" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>var_limit_gn<span class="op">=</span>(<span class="fl">0.0</span>, <span class="fl">0.0001</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>sigma_range_gb<span class="op">=</span>(<span class="fl">0.0</span>, <span class="fl">0.7</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>kernel_size_range_gb<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>angle_range_gm<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">30</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>kernel_size_range_gm<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="random-gaussian-blur" class="level4" data-number="2.3.3.1">
<h4 data-number="2.3.3.1" class="anchored" data-anchor-id="random-gaussian-blur"><span class="header-section-number">2.3.3.1</span> Random gaussian blur</h4>
<div id="9eb5c117" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_gaussian_blur(image, kernel_size_range<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">7</span>), sigma_range<span class="op">=</span>(<span class="fl">0.1</span>, <span class="fl">2.0</span>), probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gaussian_kernel(size: <span class="bu">int</span>, mean: <span class="bu">float</span>, std: <span class="bu">float</span>):</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Creates a 2D Gaussian Kernel for convolution."""</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        coords <span class="op">=</span> tf.<span class="bu">range</span>(<span class="op">-</span>(size <span class="op">//</span> <span class="dv">2</span>), size <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.float32)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> tf.exp(<span class="op">-</span>tf.<span class="bu">pow</span>(coords <span class="op">-</span> mean, <span class="fl">2.0</span>) <span class="op">/</span> (<span class="fl">2.0</span> <span class="op">*</span> tf.<span class="bu">pow</span>(std, <span class="fl">2.0</span>)))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        g <span class="op">/=</span> tf.reduce_sum(g)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        gauss_kernel <span class="op">=</span> tf.tensordot(g, g, axes<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gauss_kernel <span class="op">/</span> tf.reduce_sum(gauss_kernel)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_blur(img):</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate a seed if none is provided for consistent randomness</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        kernel_size_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        sigma_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Randomize the kernel size and sigma within the given ranges</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        random_kernel_size <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>kernel_size_range[<span class="dv">0</span>], maxval<span class="op">=</span>kernel_size_range[<span class="dv">1</span>], dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>kernel_size_seed)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        random_kernel_size <span class="op">=</span> tf.where(random_kernel_size <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>, random_kernel_size <span class="op">+</span> <span class="dv">1</span>, random_kernel_size)  <span class="co"># Ensure kernel size is odd</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        random_sigma <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>sigma_range[<span class="dv">0</span>], maxval<span class="op">=</span>sigma_range[<span class="dv">1</span>], seed<span class="op">=</span>sigma_seed)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the Gaussian kernel</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> gaussian_kernel(random_kernel_size, <span class="fl">0.</span>, random_sigma)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> kernel[:, :, tf.newaxis, tf.newaxis]</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> tf.tile(kernel, [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>])  <span class="co"># Match kernel to the RGB channels</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure image is 4D (batch size, height, width, channels)</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(tf.equal(tf.rank(img), <span class="dv">3</span>),  <span class="co"># Check if the image is rank 3 (without batch dimension)</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: tf.expand_dims(img, axis<span class="op">=</span><span class="dv">0</span>),  <span class="co"># Add batch dimension</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: img)  <span class="co"># If already 4D, pass as-is</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply depthwise convolution (motion blur)</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.nn.depthwise_conv2d(img, kernel, [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], padding<span class="op">=</span><span class="st">'SAME'</span>)[<span class="dv">0</span>]</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_blur(image),</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-motion-blur" class="level4" data-number="2.3.3.2">
<h4 data-number="2.3.3.2" class="anchored" data-anchor-id="random-motion-blur"><span class="header-section-number">2.3.3.2</span> Random motion blur</h4>
<div id="9a010366" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_motion_blur(image, kernel_size_range<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">7</span>), angle_range<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">360</span>), probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> motion_blur_kernel(img, kernel_size, angle):</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        center <span class="op">=</span> tf.cast(kernel_size <span class="op">//</span> <span class="dv">2</span>, tf.float32)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the angle in radians</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        angle_rad <span class="op">=</span> angle <span class="op">*</span> (<span class="fl">3.14159265359</span> <span class="op">/</span> <span class="fl">180.0</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        cos_a <span class="op">=</span> tf.cos(angle_rad)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        sin_a <span class="op">=</span> tf.sin(angle_rad)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create meshgrid for indices</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> tf.cast(tf.<span class="bu">range</span>(kernel_size), tf.float32) <span class="op">-</span> center</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> tf.cast(tf.<span class="bu">range</span>(kernel_size), tf.float32) <span class="op">-</span> center</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        xx, yy <span class="op">=</span> tf.meshgrid(x, y)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the distance to simulate motion blur in the specified direction</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> xx <span class="op">*</span> cos_a <span class="op">+</span> yy <span class="op">*</span> sin_a</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> tf.cast(tf.<span class="bu">abs</span>(distance) <span class="op">&lt;</span> <span class="fl">0.5</span>, tf.float32)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize the kernel</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> kernel <span class="op">/</span> tf.reduce_sum(kernel)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expand dimensions to 4D for depthwise convolution</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> kernel[:, :, tf.newaxis, tf.newaxis]</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> tf.tile(kernel, [<span class="dv">1</span>, <span class="dv">1</span>, tf.shape(img)[<span class="op">-</span><span class="dv">1</span>], <span class="dv">1</span>])  <span class="co"># Match the number of channels</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> kernel</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_motion_blur(img, seed):</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Generate a seed if none is provided for consistent randomness</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>            seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        kernel_size_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        angle_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Randomly choose a kernel size and angle within the specified range</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        kernel_size <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>kernel_size_range[<span class="dv">0</span>], maxval<span class="op">=</span>kernel_size_range[<span class="dv">1</span>], dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>kernel_size_seed)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        angle <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>angle_range[<span class="dv">0</span>], maxval<span class="op">=</span>angle_range[<span class="dv">1</span>], dtype<span class="op">=</span>tf.float32, seed<span class="op">=</span>angle_seed)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the motion blur kernel</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> motion_blur_kernel(img, kernel_size, angle)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure image is 4D (batch size, height, width, channels)</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(tf.equal(tf.rank(img), <span class="dv">3</span>),  <span class="co"># Check if the image is rank 3 (without batch dimension)</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: tf.expand_dims(img, axis<span class="op">=</span><span class="dv">0</span>),  <span class="co"># Add batch dimension</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: img)  <span class="co"># If already 4D, pass as-is</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply depthwise convolution (motion blur)</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.nn.depthwise_conv2d(img, kernel, [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], padding<span class="op">=</span><span class="st">'SAME'</span>)[<span class="dv">0</span>]</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply motion blur with a certain probability</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">lambda</span>: apply_motion_blur(image, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">lambda</span>: image)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-median-blur" class="level4" data-number="2.3.3.3">
<h4 data-number="2.3.3.3" class="anchored" data-anchor-id="random-median-blur"><span class="header-section-number">2.3.3.3</span> Random median blur</h4>
<div id="38511f65" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_median_blur(image, kernel_size<span class="op">=</span><span class="dv">5</span>, probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_median_blur(img, seed):</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If no seed is provided, generate one</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>            seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert image to uint8 for applying the median filter</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cast(img <span class="op">*</span> <span class="fl">255.0</span>, tf.uint8)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.rgb_to_grayscale(img)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply median blur</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.median_filter2d(img, filter_shape<span class="op">=</span>[kernel_size, kernel_size])</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.image.grayscale_to_rgb(img)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert back to float32 after blurring</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.cast(img, tf.float32) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the blur based on the given probability</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_median_blur(image, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="radom-gaussian-noise" class="level4" data-number="2.3.3.4">
<h4 data-number="2.3.3.4" class="anchored" data-anchor-id="radom-gaussian-noise"><span class="header-section-number">2.3.3.4</span> Radom gaussian noise</h4>
<div id="2468027e" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_gaussian_noise(image, var_limit<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>), probability<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_noise(img, seed):</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Create a seed if none is provided to ensure consistent randomness</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>            seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        seeds <span class="op">=</span> tf.random.experimental.stateless_split(seed, num<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        stddev_seed <span class="op">=</span> seeds[<span class="dv">0</span>]</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        noise_seed <span class="op">=</span> seeds[<span class="dv">1</span>]</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate random standard deviation for the noise within the given limits</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        stddev <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span>var_limit[<span class="dv">0</span>], maxval<span class="op">=</span>var_limit[<span class="dv">1</span>], seed<span class="op">=</span>stddev_seed)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate random Gaussian noise</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        noise <span class="op">=</span> tf.random.stateless_normal(shape<span class="op">=</span>tf.shape(img), mean<span class="op">=</span><span class="fl">0.0</span>, stddev<span class="op">=</span>stddev, dtype<span class="op">=</span>tf.float32, seed<span class="op">=</span>noise_seed)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add noise to the image and clip values to ensure valid pixel values [0, 1]</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.clip_by_value(img <span class="op">+</span> noise, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply noise with a certain probability</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_noise(image, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-one-of-blur" class="level4" data-number="2.3.3.5">
<h4 data-number="2.3.3.5" class="anchored" data-anchor-id="random-one-of-blur"><span class="header-section-number">2.3.3.5</span> Random one of blur</h4>
<div id="e38d3d76" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_one_of_blur(image, probability<span class="op">=</span><span class="fl">0.7</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> apply_random_transform(img, seed):</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If no seed is provided, generate one</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>            seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate a random choice using stateless randomness for reproducibility</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        choice <span class="op">=</span> tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">3</span>, dtype<span class="op">=</span>tf.int32, seed<span class="op">=</span>seed)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply different blur/noise transformations based on random choice</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(choice <span class="op">==</span> <span class="dv">0</span>,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: random_motion_blur(img, kernel_size_range<span class="op">=</span>kernel_size_range_gm, angle_range<span class="op">=</span>angle_range_gm, probability<span class="op">=</span><span class="fl">1.0</span>, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: img)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(choice <span class="op">==</span> <span class="dv">1</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: random_gaussian_blur(img, kernel_size_range<span class="op">=</span>kernel_size_range_gb, sigma_range<span class="op">=</span>sigma_range_gb, probability<span class="op">=</span><span class="fl">1.0</span>, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: img)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> tf.cond(choice <span class="op">==</span> <span class="dv">2</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: random_gaussian_noise(img, var_limit<span class="op">=</span>var_limit_gn, probability<span class="op">=</span><span class="fl">1.0</span>, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">lambda</span>: img)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the main condition to determine whether to apply a transformation or not</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), probability),</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: apply_random_transform(image, seed<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7ceb1549" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_transpose(image, threshold<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure stateless randomness for reproducibility</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), threshold),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: tf.image.transpose(image),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_vertical_flip(image, threshold<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), threshold),</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: tf.image.flip_up_down(image),</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_horizontal_flip(image, threshold<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), threshold),</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: tf.image.flip_left_right(image),</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_brightness(image, max_delta<span class="op">=</span><span class="fl">0.05</span>, threshold<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), threshold),</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: tf.image.random_brightness(image, max_delta<span class="op">=</span>max_delta),</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_contrast(image, lower<span class="op">=</span><span class="fl">0.9</span>, upper<span class="op">=</span><span class="fl">1.1</span>, threshold<span class="op">=</span><span class="fl">0.5</span>, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seed <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> tf.random.uniform([<span class="dv">2</span>], maxval<span class="op">=</span><span class="dv">2</span><span class="op">**</span><span class="dv">31</span> <span class="op">-</span> <span class="dv">1</span>, dtype<span class="op">=</span>tf.int32)</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.cond(</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        tf.less(tf.random.stateless_uniform([], minval<span class="op">=</span><span class="dv">0</span>, maxval<span class="op">=</span><span class="dv">1</span>, seed<span class="op">=</span>seed), threshold),</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: tf.image.random_contrast(image, lower<span class="op">=</span>lower, upper<span class="op">=</span>upper),</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span>: image</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="apply-augmentations" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="apply-augmentations"><span class="header-section-number">2.3.4</span> Apply augmentations</h3>
<div id="dfe77ab7" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>threshold_low<span class="op">=</span><span class="fl">0.4</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>threshold_medium<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>threshold_high<span class="op">=</span><span class="fl">0.7</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>threshold_very_high<span class="op">=</span><span class="fl">0.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b4257cfc" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>threshold_low<span class="op">=</span><span class="fl">0.4</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>threshold_medium<span class="op">=</span><span class="fl">0.65</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>threshold_high<span class="op">=</span><span class="fl">0.7</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>threshold_very_high<span class="op">=</span><span class="fl">0.65</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_minority(image, threshold<span class="op">=</span>threshold_very_high, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply a series of augmentations with appropriate thresholds</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_transpose(image, threshold_high, seed<span class="op">=</span>seed)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_vertical_flip(image, threshold<span class="op">=</span>threshold_high, seed<span class="op">=</span>seed)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_horizontal_flip(image, threshold<span class="op">=</span>threshold_high, seed<span class="op">=</span>seed)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_brightness(image,  threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_contrast(image, threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_one_of_blur(image, probability<span class="op">=</span>threshold_medium, seed<span class="op">=</span>seed)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_one_of_distortion(image, probability<span class="op">=</span>threshold_medium, seed<span class="op">=</span>seed)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_hue_saturation(image, probability<span class="op">=</span>threshold_medium, seed<span class="op">=</span>seed)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_crop(image, probability<span class="op">=</span>threshold_medium, seed<span class="op">=</span>seed)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_cutout(image, probability<span class="op">=</span>threshold_medium, seed<span class="op">=</span>seed)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.clip_by_value(image, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_majority(image, threshold<span class="op">=</span>threshold_low, seed<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply augmentations with lower thresholds for majority class</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_transpose(image,  threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_vertical_flip(image,  threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_horizontal_flip(image,  threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_brightness(image, threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_contrast(image, threshold<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_one_of_blur(image, probability<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_one_of_distortion(image, probability<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_hue_saturation(image, probability<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_crop(image, probability<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> random_cutout(image, probability<span class="op">=</span>threshold, seed<span class="op">=</span>seed)</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.clip_by_value(image, <span class="fl">0.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_image_batch_old(images, labels):</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a><span class="co">    This function applies augmentations to batches of images based on the label using vectorized operations.</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a><span class="co">    It applies augment_minority if label == 1, otherwise augment_majority.</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define how to augment each image based on the label</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> augment_single(image, label):</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> augment_minority(image)</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> augment_majority(image)</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply augmentations to the batch using tf.map_fn</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>    augmented_images <span class="op">=</span> tf.map_fn(<span class="kw">lambda</span> x: augment_single(x[<span class="dv">0</span>], x[<span class="dv">1</span>]), (images, labels), fn_output_signature<span class="op">=</span>tf.float32)</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming augment_single takes image and label as input and returns augmented image</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> augmented_images</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_image_batch(images, labels):</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply augmentations based on the label (minority or majority) using tf.where.</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a><span class="co">    Labels of 1 apply minority augmentations, labels of 0 apply majority augmentations.</span></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a mask where label == 1 (for minority)</span></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> tf.equal(labels, <span class="dv">1</span>)</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply augmentations conditionally based on the mask</span></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>    augmented_images <span class="op">=</span> tf.where(mask[:, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>],</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#augment_minority(images),</span></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#augment_majority(images)</span></span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>                                tf.map_fn(<span class="kw">lambda</span> x: augment_minority(x), images, fn_output_signature<span class="op">=</span>tf.float32),</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>                                tf.map_fn(<span class="kw">lambda</span> x: augment_majority(x), images, fn_output_signature<span class="op">=</span>tf.float32)</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>                               )</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> augmented_images</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_augmentations(dataset, use_tabular_data<span class="op">=</span>use_tabular_data):</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="st">"Started data augmentation..."</span>)</span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map using (image, tabular_data, label)</span></span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dataset.<span class="bu">map</span>(<span class="kw">lambda</span> img, tab, lbl: (augment_image_batch(img, lbl), tab, lbl),</span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>                           num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE)</span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map using only (image, label)</span></span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dataset.<span class="bu">map</span>(<span class="kw">lambda</span> img, lbl: (augment_image_batch(img, lbl), lbl),</span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>                           num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-processing" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="data-processing"><span class="header-section-number">2.4</span> Data processing</h2>
<section id="caching-utils" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="caching-utils"><span class="header-section-number">2.4.1</span> Caching utils</h3>
<div id="8de6ce41" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_file_modification_time(file_path):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Get the last modification time of a file."""</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> os.path.getmtime(file_path)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_file_checksum(file_path):</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a checksum for a file's contents."""</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    md5_hash <span class="op">=</span> hashlib.md5()</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tf.io.gfile.GFile(file_path, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> chunk <span class="op">:=</span> f.read(<span class="dv">8192</span>):</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>            md5_hash.update(chunk)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> md5_hash.hexdigest()</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dataset_checksum(file_pattern, check_modification_time<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a checksum for the dataset based on file contents or modification times."""</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> tf.io.gfile.glob(file_pattern)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> files:</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"No files match the pattern: </span><span class="sc">{</span>file_pattern<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    combined_checksum <span class="op">=</span> hashlib.md5()</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> check_modification_time:</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Include file modification times</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>            file_mod_time <span class="op">=</span> <span class="bu">str</span>(get_file_modification_time(<span class="bu">file</span>))</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>            combined_checksum.update(file_mod_time.encode(<span class="st">'utf-8'</span>))</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Include file contents checksum</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>            file_checksum <span class="op">=</span> get_file_checksum(<span class="bu">file</span>)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>            combined_checksum.update(file_checksum.encode(<span class="st">'utf-8'</span>))</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined_checksum.hexdigest()</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_cache_name(file_pattern, checksum, prefix<span class="op">=</span><span class="st">"dataset_cache"</span>, run_id<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a unique cache name based on the file pattern and dataset checksum."""</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> file_pattern:</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        file_pattern_hash <span class="op">=</span> hashlib.md5(file_pattern.encode(<span class="st">'utf-8'</span>)).hexdigest()</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>        file_pattern_hash <span class="op">=</span> <span class="st">"not_provided"</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    cache_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>file_pattern_hash<span class="sc">}</span><span class="ss">_checksum_</span><span class="sc">{</span>checksum<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> run_id:</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        cache_name <span class="op">+=</span> <span class="ss">f"_run_</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cache_name</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_lockfile_if_exists(cache_path):</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Remove a lockfile if it exists."""</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    lockfile_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>cache_path<span class="sc">}</span><span class="ss">.lockfile"</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(lockfile_path):</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Removing stale lockfile: </span><span class="sc">{</span>lockfile_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>        os.remove(lockfile_path)</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_cache_exists(cache_dir, cache_name):</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check if the cache exists by looking for any cache files with the given prefix."""</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    cache_pattern <span class="op">=</span> os.path.join(cache_dir, cache_name <span class="op">+</span> <span class="st">"*"</span>)</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(glob(cache_pattern)) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Force full caching of the dataset by fully consuming it</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fully_cache_dataset(dataset, train_val_dataset_steps):</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fully cache the dataset by iterating over all elements."""</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Triggering full dataset caching..."</span>)</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> dataset:</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span>  <span class="co"># Consume all elements to force caching</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Caching complete."</span>)</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> persist_dataset(dataset, file_pattern, dataset_steps, cache_in_memory, cache_dir<span class="op">=</span>cache_dir,</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>                    prefix<span class="op">=</span><span class="st">"dataset_cache"</span>, run_id<span class="op">=</span><span class="va">None</span>, check_modification_time<span class="op">=</span><span class="va">False</span>, force_cache<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a><span class="co">    Efficiently caches a TensorFlow dataset to memory or disk.</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a><span class="co">        dataset (tf.data.Dataset): The TensorFlow dataset to cache.</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a><span class="co">        file_pattern (str): Pattern for the dataset files.</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a><span class="co">        dataset_steps (int): Number of steps in the dataset.</span></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a><span class="co">        cache_in_memory (bool): Whether to cache the dataset in memory.</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a><span class="co">        cache_dir (str): Directory for storing the cached dataset (if not in memory).</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a><span class="co">        prefix (str): Prefix for cache file names.</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a><span class="co">        run_id (str): Optional identifier to distinguish cache versions.</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a><span class="co">        check_modification_time (bool): Consider file modification times for caching.</span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a><span class="co">        force_cache (bool): If True, forces cache re-generation.</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a><span class="co">        tf.data.Dataset: The cached dataset.</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate the cache name and path</span></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> file_pattern:</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>        dataset_checksum <span class="op">=</span> get_dataset_checksum(file_pattern, check_modification_time)</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>        dataset_checksum <span class="op">=</span> <span class="st">'not_provided'</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>    cache_name <span class="op">=</span> generate_cache_name(file_pattern, dataset_checksum, prefix, run_id)</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>    cache_path <span class="op">=</span> os.path.join(cache_dir, cache_name)</span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If forcing cache or no cache exists, optionally clean the previous cache</span></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> force_cache:</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>        clean_cache_path(cache_path)</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use existing cache if available and not forced to recache</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_cache <span class="kw">and</span> check_cache_exists(cache_dir, cache_name):</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Using cached dataset at </span><span class="sc">{</span>cache_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">#return dataset if cache_in_memory else dataset.cache(cache_path)</span></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dataset</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create cache directory only if caching to disk</span></span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> cache_in_memory:</span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>        os.makedirs(cache_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Caching dataset to disk at </span><span class="sc">{</span>cache_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Caching dataset to memory"</span>)</span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cache in memory or disk and ensure dataset is fully cached</span></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.cache() <span class="cf">if</span> cache_in_memory <span class="cf">else</span> dataset.cache(cache_path)</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>    fully_cache_dataset(dataset, dataset_steps)</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset</span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_cache_path(cache_path, cache_dir<span class="op">=</span>cache_dir):</span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a><span class="co">    Removes all lockfiles from the cache directory to clean up stale caches.</span></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a><span class="co">        cache_dir (str): The directory where the cache is stored.</span></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># List all files in the cache directory</span></span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> root, dirs, files <span class="kw">in</span> os.walk(cache_dir):</span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if the file is a lockfile</span></span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">file</span>.startswith(cache_path):</span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>                    lockfile_path <span class="op">=</span> os.path.join(root, <span class="bu">file</span>)</span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Removing lockfile: </span><span class="sc">{</span>lockfile_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>                    os.remove(lockfile_path)</span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Cache </span><span class="sc">{</span>cache_path<span class="sc">}</span><span class="ss"> cleanup completed"</span>)</span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred while cleaning the cache path </span><span class="sc">{</span>cache_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-processing-utils" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="data-processing-utils"><span class="header-section-number">2.4.2</span> Data processing utils</h3>
<div id="5091c2c0" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_samples_per_class(labels):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    unique, counts <span class="op">=</span> np.unique(labels, return_counts<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">zip</span>(unique, counts))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_class_weights(samples_per_class):</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    total_samples <span class="op">=</span> <span class="bu">sum</span>(samples_per_class.values())</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {cls: total_samples <span class="op">/</span> (<span class="bu">len</span>(samples_per_class) <span class="op">*</span> count) <span class="cf">for</span> cls, count <span class="kw">in</span> samples_per_class.items()}</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_steps_per_epoch(total_samples, batch_size<span class="op">=</span>batch_size, strategy<span class="op">=</span>strategy):</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    steps <span class="op">=</span> total_samples <span class="op">//</span> (batch_size <span class="op">*</span> strategy.num_replicas_in_sync)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> steps <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Calculated steps is 0 because the provided batch_size </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> is too big !</span><span class="ch">\n</span><span class="ss"> Total samples is </span><span class="sc">{</span>total_samples<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> steps</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stratified_split_indices(labels, n_splits<span class="op">=</span><span class="dv">5</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    skf <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span>n_splits, shuffle<span class="op">=</span>shuffle, random_state<span class="op">=</span>random_state)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(skf.split(np.zeros(<span class="bu">len</span>(labels)), labels))</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_samples_in_tfrecord(file_pattern):</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Count the total number of samples in the TFRecord files."""</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Calculating tfrecords dataset size..."</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> tf.data.Dataset.list_files(file_pattern)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    total_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> dataset:</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _ <span class="kw">in</span> tf.data.TFRecordDataset(<span class="bu">file</span>, compression_type<span class="op">=</span><span class="st">"GZIP"</span>))</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>        total_count <span class="op">+=</span> count</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_count</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_dataset(dataset, indices):</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="st">'Splitting the dataset'</span>)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> tf.convert_to_tensor(indices, dtype<span class="op">=</span>tf.int64)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    indices_dataset <span class="op">=</span> tf.data.Dataset.from_tensor_slices(indices)</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use enumerate to pair each element with its index, then filter</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    filtered_dataset <span class="op">=</span> dataset.<span class="bu">enumerate</span>().<span class="bu">filter</span>(</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> idx, _: tf.reduce_any(tf.equal(idx, indices))</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">map</span>(<span class="kw">lambda</span> idx, data: data)  <span class="co"># Discard the index after filtering</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if use_tabular_data:</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">#return filtered_dataset.map(lambda img, tab, lbl: ((img, tab), lbl))</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#else:</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">#return filtered_dataset.map(lambda img, lbl: (img, lbl))</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filtered_dataset</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_samples_in_training_dataset(dataset, batch_size<span class="op">=</span><span class="va">None</span>, strategy<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Count the number of samples in a dataset, taking into account batched datasets.</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a><span class="co">    dataset: A `tf.data.Dataset` object, possibly batched.</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a><span class="co">    batch_size: If the dataset is batched, specify the batch size to correctly count samples.</span></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Integer count of the number of samples in the dataset.</span></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Calculating the dataset size..."</span>)</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the dataset is batched, multiply by batch size, or use the actual number of samples in each batch</span></span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> batch_size:</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Count the number of batches</span></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>        batch_count <span class="op">=</span> dataset.<span class="bu">reduce</span>(<span class="dv">0</span>, <span class="kw">lambda</span> x, _: x <span class="op">+</span> <span class="dv">1</span>).numpy()</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Multiply by batch size to get the total number of samples</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>        total_samples <span class="op">=</span> batch_count <span class="op">*</span> batch_size <span class="op">*</span> strategy.num_replicas_in_sync</span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total samples: </span><span class="sc">{</span>total_samples<span class="sc">}</span><span class="ss"> and number of batches: </span><span class="sc">{</span>batch_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> total_samples</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Unbatched case: Simply count the samples</span></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>        total_samples <span class="op">=</span> dataset.<span class="bu">reduce</span>(<span class="dv">0</span>, <span class="kw">lambda</span> x, _: x <span class="op">+</span> <span class="dv">1</span>).numpy()</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total samples: </span><span class="sc">{</span>total_samples<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> total_samples</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_input_dataset(dataset, use_tabular_data<span class="op">=</span>use_tabular_data):</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> dataset.<span class="bu">map</span>(<span class="kw">lambda</span> img, tab, lbl: ((img, tab), lbl))</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> dataset.<span class="bu">map</span>(<span class="kw">lambda</span> img, lbl: (img, lbl))</span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image, label):</span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.image.resize(image, [img_height, img_width])</span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image, label</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cast_labels(dataset, use_tabular_data<span class="op">=</span>use_tabular_data):</span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> dataset.<span class="bu">map</span>(<span class="kw">lambda</span> img, tab, lbl: (img, tab, tf.cast(lbl, dtype<span class="op">=</span>tf.float32)))</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> dataset.<span class="bu">map</span>(<span class="kw">lambda</span> img, lbl: (img, tf.cast(lbl, dtype<span class="op">=</span>tf.float32)))</span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper to optimize dataset caching and prefetching</span></span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_dataset(dataset, steps, batch_size<span class="op">=</span>batch_size, file_pattern<span class="op">=</span><span class="va">None</span>, shuffle<span class="op">=</span><span class="va">True</span>, buffer_size<span class="op">=</span>buffer_size,</span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>                     drop_remainder<span class="op">=</span><span class="va">True</span>,  prefix<span class="op">=</span><span class="st">'train'</span>, force_cache<span class="op">=</span><span class="va">False</span>, cache_in_memory<span class="op">=</span><span class="va">False</span>, run_id<span class="op">=</span>run_id,</span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>                     cache_dir<span class="op">=</span>cache_dir, check_modification_time<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Optimize dataset with caching, batching, shuffling, and prefetching."""</span></span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dataset = persist_dataset(dataset, file_pattern=file_pattern, dataset_steps=steps, cache_in_memory=cache_in_memory,</span></span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#force_cache=force_cache, prefix=prefix, run_id=run_id,</span></span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a>                             <span class="co">#cache_dir=cache_dir, check_modification_time=check_modification_time)</span></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prefix <span class="op">==</span> <span class="st">'train'</span>:</span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Repeating, shuffling and batching </span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss"> dataset"</span>)</span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Repeating </span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss"> dataset"</span>)</span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.repeat()</span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.shuffle(buffer_size<span class="op">=</span>buffer_size) <span class="cf">if</span> shuffle <span class="cf">else</span> dataset</span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prefix <span class="op">==</span> <span class="st">'train'</span>:</span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> dataset.batch(batch_size <span class="op">*</span> strategy.num_replicas_in_sync, drop_remainder<span class="op">=</span>drop_remainder)</span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.prefetch(tf.data.AUTOTUNE)</span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset</span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_session():</span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reset the session and clear the graph before each fold</span></span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>    tf.keras.backend.clear_session()</span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>    tf.compat.v1.reset_default_graph()</span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a>    gc.collect()</span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deletes_old_datasets():</span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> train_dataset</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> val_dataset</span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a>    clean_session()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="oversampling-utils-1" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="oversampling-utils-1"><span class="header-section-number">2.4.3</span> Oversampling utils</h3>
<div id="9ac76d91" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> oversample_minority_class_random(dataset, batch_size<span class="op">=</span>batch_size, strategy<span class="op">=</span>strategy, use_tabular_data<span class="op">=</span>use_tabular_data):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Randomly oversample the minority class by duplicating its samples within the dataset.</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Random oversampling the minority class..."</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Separate the dataset into majority and minority classes</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    minority_class <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    majority_class <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For datasets with both image and tabular data</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        minority_dataset <span class="op">=</span> dataset.<span class="bu">filter</span>(<span class="kw">lambda</span> image, tab, label: tf.equal(label, minority_class))</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        majority_dataset <span class="op">=</span> dataset.<span class="bu">filter</span>(<span class="kw">lambda</span> image, tab, label: tf.equal(label, majority_class))</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For datasets with only image data</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        minority_dataset <span class="op">=</span> dataset.<span class="bu">filter</span>(<span class="kw">lambda</span> image, label: tf.equal(label, minority_class))</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        majority_dataset <span class="op">=</span> dataset.<span class="bu">filter</span>(<span class="kw">lambda</span> image, label: tf.equal(label, majority_class))</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count the number of samples in each class</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    minority_count <span class="op">=</span> count_samples_in_training_dataset(minority_dataset, batch_size<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    majority_count <span class="op">=</span> count_samples_in_training_dataset(majority_dataset, batch_size<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    sample_per_class_input_ds <span class="op">=</span> <span class="bu">dict</span>(majority_class<span class="op">=</span>majority_count, minority_class<span class="op">=</span>minority_count)</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate how many samples need to be added to the minority class</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    additional_samples_needed <span class="op">=</span> majority_count <span class="op">-</span> minority_count</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly sample from the minority dataset to add more samples</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    minority_dataset_repeated <span class="op">=</span> minority_dataset.repeat()</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    minority_dataset_sampled <span class="op">=</span> minority_dataset_repeated.shuffle(buffer_size<span class="op">=</span>buffer_size).take(additional_samples_needed)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine the sampled dataset with the original minority dataset</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    oversampled_minority_dataset <span class="op">=</span> minority_dataset.concatenate(minority_dataset_sampled)</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine the oversampled minority class with the majority class</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    oversampled_dataset <span class="op">=</span> majority_dataset.concatenate(oversampled_minority_dataset)</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shuffle the combined dataset</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    oversampled_dataset <span class="op">=</span> oversampled_dataset.shuffle(buffer_size<span class="op">=</span>buffer_size)</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recalculate steps per epoch after oversampling</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    oversampled_sample_count <span class="op">=</span> majority_count <span class="op">+</span> additional_samples_needed</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    training_steps <span class="op">=</span> calculate_steps_per_epoch(oversampled_sample_count, batch_size)</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    sample_per_class_oversampled_ds <span class="op">=</span> <span class="bu">dict</span>(majority_class<span class="op">=</span>majority_count, minority_class<span class="op">=</span>majority_count)</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> oversampled_dataset, training_steps, oversampled_sample_count, sample_per_class_input_ds, sample_per_class_oversampled_ds</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> oversample_minority_with_tabular_smote_images_random(dataset, batch_size<span class="op">=</span>batch_size, strategy<span class="op">=</span>strategy, use_tabular_data<span class="op">=</span>use_tabular_data):</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a><span class="co">    Randomly oversample the minority class by duplicating its samples within the dataset for images.</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply SMOTE for tabular data to oversample synthetic features. The function handles both cases: with and without tabular data.</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Separate the dataset into majority and minority classes</span></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>    minority_class <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>    majority_class <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If using tabular data, the dataset contains (image, tabular_data, label)</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>        tabular_data <span class="op">=</span> []</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>        images <span class="op">=</span> []</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> []</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> image, tabular, label <span class="kw">in</span> dataset:</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>            images.append(image.numpy())</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>            tabular_data.append(tabular.numpy())</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>            labels.append(label.numpy())</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to numpy arrays</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>        tabular_data <span class="op">=</span> np.array(tabular_data)</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> np.array(labels)</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>        images <span class="op">=</span> np.array(images)</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Separate majority and minority classes</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>        minority_images <span class="op">=</span> images[labels <span class="op">==</span> minority_class]</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>        minority_tabular_data <span class="op">=</span> tabular_data[labels <span class="op">==</span> minority_class]</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>        majority_images <span class="op">=</span> images[labels <span class="op">==</span> majority_class]</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>        majority_tabular_data <span class="op">=</span> tabular_data[labels <span class="op">==</span> majority_class]</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply SMOTE on the tabular data</span></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>        smote <span class="op">=</span> SMOTE(sampling_strategy<span class="op">=</span><span class="st">'auto'</span>)</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>        tabular_data_resampled, labels_resampled <span class="op">=</span> smote.fit_resample(tabular_data, labels)</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find how many new samples were generated by SMOTE for the minority class</span></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>        new_minority_count <span class="op">=</span> np.<span class="bu">sum</span>(labels_resampled <span class="op">==</span> minority_class) <span class="op">-</span> <span class="bu">len</span>(minority_tabular_data)</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each new synthetic tabular data point, randomly pick a corresponding minority image</span></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>        random_indices <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(minority_images), new_minority_count)</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>        minority_images_resampled <span class="op">=</span> minority_images[random_indices]</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">#minority_images_resampled = np.tile(minority_images, (new_minority_count // len(minority_images) + 1, 1, 1, 1))[:new_minority_count]</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine the original majority data with the resampled minority data</span></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>        combined_images <span class="op">=</span> np.concatenate([majority_images, minority_images, minority_images_resampled])</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>        combined_tabular_data <span class="op">=</span> np.concatenate([majority_tabular_data, minority_tabular_data, tabular_data_resampled[<span class="bu">len</span>(minority_tabular_data):]])</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>        combined_labels <span class="op">=</span> np.concatenate([np.full(<span class="bu">len</span>(majority_images), majority_class), np.full(<span class="bu">len</span>(minority_images), minority_class), np.full(<span class="bu">len</span>(minority_images_resampled), minority_class)])</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(combined_images) <span class="op">==</span> <span class="bu">len</span>(combined_tabular_data) <span class="op">==</span> <span class="bu">len</span>(combined_labels), <span class="st">"Mismatch in dataset length!"</span></span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the combined data back to TensorFlow tensors</span></span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>        combined_images <span class="op">=</span> tf.convert_to_tensor(combined_images, dtype<span class="op">=</span>tf.float32)</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>        combined_tabular_data <span class="op">=</span> tf.convert_to_tensor(combined_tabular_data, dtype<span class="op">=</span>tf.float32)</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>        combined_labels <span class="op">=</span> tf.convert_to_tensor(combined_labels, dtype<span class="op">=</span>tf.int64)</span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine the resampled data into a dataset</span></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>        oversampled_dataset <span class="op">=</span> tf.data.Dataset.from_tensor_slices((combined_images, combined_tabular_data, combined_labels))</span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If not using tabular data, the dataset contains (image, label)</span></span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>        minority_dataset <span class="op">=</span> dataset.<span class="bu">filter</span>(<span class="kw">lambda</span> image, label: tf.equal(label, minority_class))</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>        majority_dataset <span class="op">=</span> dataset.<span class="bu">filter</span>(<span class="kw">lambda</span> image, label: tf.equal(label, majority_class))</span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply random oversampling for images only</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>        minority_dataset_repeated <span class="op">=</span> minority_dataset.repeat()</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>        minority_dataset_sampled <span class="op">=</span> minority_dataset_repeated.shuffle(buffer_size<span class="op">=</span>buffer_size).take(majority_dataset.<span class="bu">reduce</span>(<span class="dv">0</span>, <span class="kw">lambda</span> x, _: x <span class="op">+</span> <span class="dv">1</span>).numpy())</span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>        oversampled_minority_dataset <span class="op">=</span> minority_dataset.concatenate(minority_dataset_sampled)</span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine the oversampled minority class with the majority class</span></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>        oversampled_dataset <span class="op">=</span> majority_dataset.concatenate(oversampled_minority_dataset)</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shuffle the combined dataset (optional)</span></span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a>    oversampled_dataset <span class="op">=</span> oversampled_dataset.shuffle(buffer_size<span class="op">=</span>buffer_size)</span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recalculate steps per epoch after oversampling</span></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a>    oversampled_sample_count <span class="op">=</span> <span class="bu">len</span>(combined_labels) <span class="cf">if</span> use_tabular_data <span class="cf">else</span> count_samples_in_training_dataset(oversampled_dataset)</span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a>    training_steps <span class="op">=</span> calculate_steps_per_epoch(oversampled_sample_count, batch_size)</span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> oversampled_dataset, training_steps, oversampled_sample_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-loading-utils" class="level3" data-number="2.4.4">
<h3 data-number="2.4.4" class="anchored" data-anchor-id="data-loading-utils"><span class="header-section-number">2.4.4</span> Data loading utils</h3>
<div id="0cf14213" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> StratifiedKFold</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_auc_score</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_tfrecord_fn(example_proto):</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parse a TFRecord into image and optional tabular data."""</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    feature_description <span class="op">=</span> {<span class="st">'image'</span>: tf.io.FixedLenFeature([], tf.string), <span class="st">'label'</span>: tf.io.FixedLenFeature([], tf.int64)}</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        feature_description[<span class="st">'tabular_data'</span>] <span class="op">=</span> tf.io.FixedLenFeature([<span class="dv">14</span>], tf.float32)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    example <span class="op">=</span> tf.io.parse_single_example(example_proto, feature_description)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.image.decode_jpeg(example[<span class="st">'image'</span>], channels<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.image.resize(image, [img_height, img_width])</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> image <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#label = tf.cast(example['label'], tf.float32)</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Parsing data including tabular metadata'</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(example[<span class="st">'label'</span>])</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, example[<span class="st">'tabular_data'</span>], example[<span class="st">'label'</span>]</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, example[<span class="st">'label'</span>]</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrap parsing function with error handling</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_parse_fn(example):</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> parse_tfrecord_fn(example)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f"Error parsing example: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_tfrecord_dataset(file_pattern,</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>                          use_tabular_data<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>                          cache_in_memory<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>                          is_training<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>                          batch_size<span class="op">=</span>batch_size,</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>                          num_parallel_reads<span class="op">=</span>tf.data.AUTOTUNE,</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>                          data_type<span class="op">=</span><span class="st">'Train'</span>):</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load TFRecord dataset with optional data augmentation and tabular data handling."""</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loading </span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss"> TFRecords..."</span>)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a dataset of file paths</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> tf.data.Dataset.list_files(file_pattern, shuffle<span class="op">=</span>is_training)</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    tf.<span class="bu">print</span>(<span class="ss">f"Number of files: </span><span class="sc">{</span>files<span class="sc">.</span>cardinality()<span class="sc">.</span>numpy()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interleave the files to read them in parallel</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> files.interleave(</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: tf.data.TFRecordDataset(x, compression_type<span class="op">=</span><span class="st">"GZIP"</span>),</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>        cycle_length<span class="op">=</span>num_parallel_reads,</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>        num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse the TFRecord files</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.<span class="bu">map</span>(parse_tfrecord_fn, num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE)</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> dataset.cache()</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dataset = persist_dataset(dataset, file_pattern, cache_in_memory, '/tmp/tf_cache_2', prefix=data_type, run_id=run_id, check_modification_time=False)</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_training:</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> dataset.prefetch(tf.data.AUTOTUNE)</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> dataset.batch(batch_size <span class="op">*</span> strategy.num_replicas_in_sync, drop_remainder<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> dataset.prefetch(tf.data.AUTOTUNE)</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Batched the dataset using batch size:"</span>, batch_size <span class="op">*</span> strategy.num_replicas_in_sync)</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>    rows_count <span class="op">=</span> count_samples_in_tfrecord(file_pattern)</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loaded dataset at </span><span class="sc">{</span>file_pattern<span class="sc">}</span><span class="ss">, number of rows: </span><span class="sc">{</span>rows_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rows_count <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"The provided dataset is empty"</span>)</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>    steps_per_epoch <span class="op">=</span> calculate_steps_per_epoch(rows_count, batch_size)</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Dataset number of batches: </span><span class="sc">{</span>steps_per_epoch<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset, steps_per_epoch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="modelling" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Modelling</h1>
<section id="models-utils" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="models-utils"><span class="header-section-number">3.1</span> Models utils</h2>
<section id="base-model" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="base-model"><span class="header-section-number">3.1.1</span> Base model</h3>
<div id="cf67651e" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to apply dense block</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_dense_block(x, units, activation<span class="op">=</span><span class="st">'swish'</span>, l2_lambda<span class="op">=</span><span class="va">None</span>, dropout_rate<span class="op">=</span><span class="va">None</span>, kernel_initializer<span class="op">=</span><span class="st">'glorot_uniform'</span>):</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Applying dense bloc with: kernel_initializer {kernel_initializer}, dropout_rate {dropout_rate}, activation {activation}, l2_lambda {l2_lambda}")</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Applying dense bloc with kernel_initializer: </span><span class="sc">{}</span><span class="st">, dropout_rate: </span><span class="sc">{}</span><span class="st">, activation: </span><span class="sc">{}</span><span class="st">, l2_lambda: </span><span class="sc">{}</span><span class="st">"</span>.</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>          <span class="bu">format</span>(kernel_initializer, dropout_rate, activation, l2_lambda))</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    kernel_reg <span class="op">=</span> regularizers.l2(l2_lambda) <span class="cf">if</span> l2_lambda <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> layers.Dense(units, kernel_regularizer<span class="op">=</span>kernel_reg, kernel_initializer<span class="op">=</span>kernel_initializer, activation<span class="op">=</span>activation)(x)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#x = layers.BatchNormalization()(x)</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dropout_rate:</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> layers.Dropout(dropout_rate)(x)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Base model class for all models</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BaseModel:</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name, dropout_rate<span class="op">=</span><span class="va">None</span>, l2_lambda<span class="op">=</span><span class="va">None</span>, freeze_base_model<span class="op">=</span><span class="va">False</span>, img_shape<span class="op">=</span>img_shape,</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>                 num_tabular_features<span class="op">=</span><span class="dv">14</span>, use_tabular_data<span class="op">=</span><span class="va">False</span>, kernel_initializer<span class="op">=</span><span class="st">'glorot_uniform'</span>, run_id<span class="op">=</span>run_id, <span class="op">**</span>kwargs):</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="co">            Base model constructor. Supports flexible parameter passing through **kwargs.</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="co">            Parameters:</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co">            - model_name: Name of the model to build (e.g., 'resnet50').</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co">            - dropout_rate: Dropout rate for dense layers.</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co">            - l2_lambda: L2 regularization.</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="co">            - freeze_base_model: Whether to freeze the base model layers.</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co">            - img_shape: Shape of the input images.</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="co">            - num_tabular_features: Number of tabular features (for hybrid models).</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="co">            - use_tabular_data: Whether to include tabular data as input.</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="co">            - kernel_initializer: Initializer for the kernel weights matrix.</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="co">            - run_id: Unique identifier for the model run (useful for saving/loading).</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="co">            - **kwargs: Additional parameters to pass through the model pipeline.</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> get_param(value, default, kwargs, key):</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> value <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> value</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> kwargs.get(key, default)</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_name <span class="op">=</span> get_param(model_name, <span class="va">None</span>, kwargs, <span class="st">'model_name'</span>)</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout_rate <span class="op">=</span> get_param(dropout_rate, <span class="va">None</span>, kwargs, <span class="st">'dropout_rate'</span>)</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.l2_lambda <span class="op">=</span> get_param(l2_lambda, <span class="va">None</span>, kwargs, <span class="st">'l2_lambda'</span>)</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.freeze_base_model <span class="op">=</span> get_param(freeze_base_model, <span class="va">False</span>, kwargs, <span class="st">'freeze_base_model'</span>)</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.img_shape <span class="op">=</span> get_param(img_shape, (<span class="dv">224</span>, <span class="dv">224</span>, <span class="dv">3</span>), kwargs, <span class="st">'img_shape'</span>)</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_tabular_features <span class="op">=</span> get_param(num_tabular_features, <span class="va">None</span>, kwargs, <span class="st">'num_tabular_features'</span>)</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_tabular_data <span class="op">=</span> get_param(use_tabular_data, <span class="va">False</span>, kwargs, <span class="st">'use_tabular_data'</span>)</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_initializer <span class="op">=</span> get_param(kernel_initializer, <span class="st">'glorot_uniform'</span>, kwargs, <span class="st">'kernel_initializer'</span>)</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> get_param(activation, <span class="st">'swish'</span>, kwargs, <span class="st">'activation'</span>)</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_id <span class="op">=</span> get_param(run_id, <span class="va">None</span>, kwargs, <span class="st">'run_id'</span>)</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kwargs <span class="op">=</span> kwargs</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _set_model_inputs_(<span class="va">self</span>):</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Set input layers for the model, with optional tabular data."""</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>        image_input <span class="op">=</span> tf.keras.Input(shape<span class="op">=</span><span class="va">self</span>.img_shape, name<span class="op">=</span><span class="st">'image_input'</span>)</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_tabular_data:</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>            tabular_input <span class="op">=</span> tf.keras.Input(shape<span class="op">=</span>(<span class="va">self</span>.num_tabular_features,), name<span class="op">=</span><span class="st">'tabular_input'</span>)</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [image_input, tabular_input]</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image_input</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _set_model_inputs(<span class="va">self</span>, image_input):</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Set input layers for the model, with optional tabular data."""</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_tabular_data:</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>            tabular_input <span class="op">=</span> tf.keras.Input(shape<span class="op">=</span>(<span class="va">self</span>.num_tabular_features,), name<span class="op">=</span><span class="st">'tabular_input'</span>)</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [image_input, tabular_input]</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image_input</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_base_model(<span class="va">self</span>, model_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Dynamically load the base model using the model name."""</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>            model_name <span class="op">=</span> <span class="va">self</span>.model_name</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>            parts <span class="op">=</span> model_name.split(<span class="st">'_'</span>)</span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Trick to get the class name from the provided string </span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Example res_net_50 -&gt; ResNet50, vgg_19 -&gt; VGG19</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>                model_class_name <span class="op">=</span> <span class="st">''</span>.join([part.capitalize() <span class="cf">for</span> part <span class="kw">in</span> parts])</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>                model_class_name <span class="op">=</span> <span class="st">''</span>.join([part.upper() <span class="cf">for</span> part <span class="kw">in</span> parts])</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>            base_model_cls <span class="op">=</span> <span class="bu">getattr</span>(tf.keras.applications, model_class_name, <span class="va">None</span>)</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> base_model_cls <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown model name: </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> base_model_cls(weights<span class="op">=</span><span class="va">None</span>, include_top<span class="op">=</span><span class="va">False</span>, input_shape<span class="op">=</span><span class="va">self</span>.img_shape)</span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Error loading model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _process_base_model(<span class="va">self</span>, base_model):</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Freeze/unfreeze base model and apply global pooling."""</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>        base_model.trainable <span class="op">=</span> <span class="kw">not</span> <span class="va">self</span>.freeze_base_model</span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> layers.GlobalAveragePooling2D()(base_model.output)</span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _combine_image_and_tabular_features(<span class="va">self</span>, image_features, inputs):</span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Combine image features with tabular features, if applicable."""</span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_tabular_data:</span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>            tabular_input <span class="op">=</span> inputs[<span class="dv">1</span>]</span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>            tabular_features <span class="op">=</span> apply_dense_block(tabular_input, <span class="dv">1024</span>, l2_lambda<span class="op">=</span><span class="va">self</span>.l2_lambda, dropout_rate<span class="op">=</span><span class="va">self</span>.dropout_rate,</span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>                                                 kernel_initializer<span class="op">=</span><span class="va">self</span>.kernel_initializer, activation<span class="op">=</span><span class="va">self</span>.activation)</span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>            tabular_features <span class="op">=</span> apply_dense_block(tabular_features, <span class="dv">812</span>, l2_lambda<span class="op">=</span><span class="va">self</span>.l2_lambda, dropout_rate<span class="op">=</span><span class="va">self</span>.dropout_rate,</span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>                                                 kernel_initializer<span class="op">=</span><span class="va">self</span>.kernel_initializer, activation<span class="op">=</span><span class="va">self</span>.activation)</span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> layers.Concatenate()([image_features, tabular_features])</span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image_features</span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_model_architecture(<span class="va">self</span>, model_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Set the full model architecture."""</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Setting model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> architecture'</span>)</span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>        base_model <span class="op">=</span> <span class="va">self</span>._get_base_model(model_name)</span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>        image_input <span class="op">=</span> base_model.<span class="bu">input</span></span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> <span class="va">self</span>._set_model_inputs(image_input)</span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">#inputs = self._set_model_inputs()</span></span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>        image_features <span class="op">=</span> <span class="va">self</span>._process_base_model(base_model)</span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a>        combined_features <span class="op">=</span> <span class="va">self</span>._combine_image_and_tabular_features(image_features, inputs)</span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add Dense and BatchNorm layers</span></span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>        combined_features <span class="op">=</span> apply_dense_block(combined_features, <span class="dv">512</span>, l2_lambda<span class="op">=</span><span class="va">self</span>.l2_lambda, dropout_rate<span class="op">=</span><span class="va">self</span>.dropout_rate,</span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>                                              kernel_initializer<span class="op">=</span><span class="va">self</span>.kernel_initializer, activation<span class="op">=</span><span class="va">self</span>.activation)</span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>        <span class="co">#combined_features = apply_dense_block(combined_features, 256, l2_lambda=self.l2_lambda, dropout_rate=self.dropout_rate,</span></span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>                                              <span class="co">#kernel_initializer=self.kernel_initializer, activation=self.activation)</span></span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dropout Models (Multiple Dropouts for Ensembling)</span></span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a>        combineds <span class="op">=</span> [layers.Dropout(<span class="fl">0.2</span>)(combined_features) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>)]</span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply a Dense layer after each dropout</span></span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> [layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">'sigmoid'</span>)(combined) <span class="cf">for</span> combined <span class="kw">in</span> combineds]</span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Average the outputs for ensembling</span></span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>        final_output <span class="op">=</span> layers.Average()(outputs)</span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> tf.keras.Model(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>final_output)</span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a>        model.base_model <span class="op">=</span> base_model  <span class="co"># Keep a reference to the base model for flexibility</span></span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> model</span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_model(<span class="va">self</span>, model_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a><span class="co">        Create a base model using the architecture specified by model_name.</span></span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a><span class="co">        If model_name is None, use the instance's model_name.</span></span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>            model_name <span class="op">=</span> <span class="va">self</span>.model_name</span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Creating model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> <span class="va">self</span>.set_model_architecture(model_name)</span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>        model.model_name <span class="op">=</span> model_name</span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ensemble-model" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="ensemble-model"><span class="header-section-number">3.1.2</span> Ensemble model</h3>
<div id="8daff0d1" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># EnsembleModel class inherits from BaseModel</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EnsembleModel(BaseModel):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name, model_names, mode<span class="op">=</span><span class="st">'weighted'</span>, run_id<span class="op">=</span>run_id, num_ensemble<span class="op">=</span><span class="dv">2</span>, weights<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(model_name<span class="op">=</span>model_name, <span class="op">**</span>kwargs)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_name <span class="op">=</span> model_name</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_names <span class="op">=</span> model_names</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mode <span class="op">=</span> mode</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_ensemble <span class="op">=</span> num_ensemble</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weights <span class="op">=</span> weights <span class="cf">if</span> weights <span class="cf">else</span> [<span class="fl">1.0</span>] <span class="op">*</span> <span class="bu">len</span>(model_names)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_id <span class="op">=</span> run_id</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _load_pretrained_model(<span class="va">self</span>, model_name):</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load a pretrained model and return it."""</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> <span class="va">self</span>.set_model_architecture(model_name)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> resolve_prm_name(model_name):</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">''</span>.join(model_name.split(<span class="st">'_'</span>))</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>            model.load_weights(os.path.join(pretrained_models_dir, <span class="ss">f'</span><span class="sc">{</span>resolve_prm_name(model_name)<span class="sc">}</span><span class="ss">_weights.h5'</span>))</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Error loading weights for model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> model</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_ensemble(<span class="va">self</span>, pretrained):</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Create an ensemble model with the selected strategy (average, max, or weighted).</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Can load pretrained models or create new ones based on the `pretrained` flag.</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collect outputs from each model in the ensemble</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> <span class="va">self</span>._set_model_inputs_()  <span class="co"># Get the input layers</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>        model_outputs <span class="op">=</span> []</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name <span class="kw">in</span> <span class="va">self</span>.model_names:</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pretrained:</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>                <span class="co">## Creates a pretrained model by loading the loads of the pretrained ensemble models</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> <span class="va">self</span>._load_pretrained_model(model_name)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>                <span class="co">## Only set the architecture of the ensemble model from the individuals</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> <span class="va">self</span>.create_model(model_name<span class="op">=</span>model_name)  <span class="co"># Create a new model from the architecture</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>            model_outputs.append(model(inputs))</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply the selected ensembling strategy to combine the model outputs</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>        ensemble_output <span class="op">=</span> <span class="va">self</span>._apply_ensemble_strategy(model_outputs)</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create and return the ensemble model</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>        ensemble_model <span class="op">=</span> tf.keras.Model(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>ensemble_output)</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>        ensemble_model.model_name <span class="op">=</span> <span class="va">self</span>.model_name <span class="co"># For later reuse in the training pipeline</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ensemble_model</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _apply_ensemble_strategy(<span class="va">self</span>, outputs):</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Apply different ensemble strategies."""</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.mode <span class="op">==</span> <span class="st">'average'</span>:</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> layers.Average()(outputs)</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.mode <span class="op">==</span> <span class="st">'max'</span>:</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> layers.Maximum()(outputs)</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.mode <span class="op">==</span> <span class="st">'weighted'</span> <span class="kw">and</span> <span class="va">self</span>.weights:</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.weights <span class="op">=</span> [w <span class="op">/</span> <span class="bu">sum</span>(<span class="va">self</span>.weights) <span class="cf">for</span> w <span class="kw">in</span> <span class="va">self</span>.weights]</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> layers.Add()([output <span class="op">*</span> weight <span class="cf">for</span> output, weight <span class="kw">in</span> <span class="bu">zip</span>(outputs, <span class="va">self</span>.weights)])</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.mode <span class="op">==</span> <span class="st">'weighted_layer'</span> <span class="kw">and</span> <span class="va">self</span>.weights:</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.weights <span class="op">=</span> [w <span class="op">/</span> <span class="bu">sum</span>(<span class="va">self</span>.weights) <span class="cf">for</span> w <span class="kw">in</span> <span class="va">self</span>.weights]</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>            weighted_outputs <span class="op">=</span> [layers.Lambda(<span class="kw">lambda</span> x, w<span class="op">=</span>weight: x <span class="op">*</span> w)(output) <span class="cf">for</span> output, weight <span class="kw">in</span> <span class="bu">zip</span>(outputs, <span class="va">self</span>.weights)]</span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> layers.Add()(weighted_outputs)</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown ensemble mode: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>mode<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="single-model" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="single-model"><span class="header-section-number">3.1.3</span> Single model</h3>
<div id="4d78b385" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SingleModel(BaseModel):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name, <span class="op">**</span>kwargs):</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(model_name<span class="op">=</span>model_name, <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="factory-utils" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="factory-utils"><span class="header-section-number">3.1.4</span> Factory utils</h3>
<div id="018548a2" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelFactory:</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_model(model_type, model_names, pretrained<span class="op">=</span><span class="va">False</span>, <span class="op">**</span>kwargs):</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Factory method to create models based on type."""</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        strategy <span class="op">=</span> kwargs.get(<span class="st">'strategy'</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> strategy.scope():</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> model_type <span class="op">==</span> <span class="st">'ensemble'</span>:</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                weights <span class="op">=</span> kwargs.get(<span class="st">'weights'</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                ensemble_model_name <span class="op">=</span> <span class="st">'_'</span>.join([<span class="st">'_'</span>.join((model_name, <span class="bu">str</span>(weight))) <span class="cf">for</span> (model_name, weight) <span class="kw">in</span> <span class="bu">zip</span>(model_names, weights)])</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>                ensemble_model_name <span class="op">=</span>  <span class="ss">f"pretrained_ensemble_</span><span class="sc">{</span>ensemble_model_name<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> pretrained <span class="cf">else</span> <span class="ss">f"compact_ensemble_</span><span class="sc">{</span>ensemble_model_name<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> EnsembleModel(model_name<span class="op">=</span>ensemble_model_name, model_names<span class="op">=</span>model_names, <span class="op">**</span>kwargs).create_ensemble(pretrained<span class="op">=</span>pretrained)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> model_type <span class="op">==</span> <span class="st">'single'</span>:</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> SingleModel(model_name<span class="op">=</span>model_names[<span class="dv">0</span>], <span class="op">**</span>kwargs).create_model()</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown model type: </span><span class="sc">{</span>model_type<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loss-functions" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="loss-functions"><span class="header-section-number">3.1.5</span> Loss functions</h3>
<div id="1db7b503" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> focal_loss(y_true, y_pred, gamma<span class="op">=</span><span class="fl">2.0</span>, alpha<span class="op">=</span><span class="fl">0.25</span>):</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Focal Loss for binary classification.</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_true: Ground truth labels, shape = (batch_size, 1)</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_pred: Predicted labels, shape = (batch_size, 1)</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - gamma: Focusing parameter (default is 2.0)</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - alpha: Balancing factor (default is 0.25)</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - Loss value</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clip predictions to prevent log(0) and ensure stability</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> tf.clip_by_value(y_pred, K.epsilon(), <span class="fl">1.</span> <span class="op">-</span> K.epsilon())</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate cross-entropy loss</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    bce_loss <span class="op">=</span> <span class="op">-</span> (y_true <span class="op">*</span> K.log(y_pred) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> K.log(<span class="dv">1</span> <span class="op">-</span> y_pred))</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate p_t and modulating factor</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    p_t <span class="op">=</span> y_true <span class="op">*</span> y_pred <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> y_pred)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    modulating_factor <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> p_t) <span class="op">**</span> gamma</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply alpha balancing factor</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    alpha_factor <span class="op">=</span> y_true <span class="op">*</span> alpha <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute focal loss</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> alpha_factor <span class="op">*</span> modulating_factor <span class="op">*</span> bce_loss</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(loss)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> class_balanced_loss(y_true, y_pred, beta<span class="op">=</span><span class="fl">0.99</span>, samples_per_cls<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Class-Balanced Loss function for binary classification.</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_true: Ground truth labels, shape = (batch_size,)</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_pred: Predicted labels, shape = (batch_size,)</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="co">    - samples_per_cls: List or array containing the number of samples for each class (class 0 and class 1).</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="co">    - beta: Hyperparameter to adjust class balancing (default is 0.99)</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="co">    - Loss value</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the effective number of samples</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    effective_num <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> tf.<span class="bu">pow</span>(beta, samples_per_cls)</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> beta) <span class="op">/</span> tf.maximum(effective_num, tf.keras.backend.epsilon())</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> weights <span class="op">/</span> tf.reduce_sum(weights)  <span class="co"># Normalize weights</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the class weights for class 0 and class 1</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>    weight_for_0 <span class="op">=</span> weights[<span class="dv">0</span>]</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>    weight_for_1 <span class="op">=</span> weights[<span class="dv">1</span>]</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply weights to the true labels (binary classification)</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>    weights_per_sample <span class="op">=</span> y_true <span class="op">*</span> weight_for_1 <span class="op">+</span> (<span class="fl">1.0</span> <span class="op">-</span> y_true) <span class="op">*</span> weight_for_0</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the binary crossentropy loss</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> tf.keras.losses.binary_crossentropy(y_true, y_pred)</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply class-balanced weights to the loss</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> weights_per_sample <span class="op">*</span> loss</span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(loss)</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combined_loss(samples_per_cls, beta<span class="op">=</span><span class="fl">0.99</span>, gamma<span class="op">=</span><span class="fl">2.0</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, focal_loss_percent<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a><span class="co">    Combined Class-Balanced Loss and Focal Loss.</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_true: Ground truth labels, shape = (batch_size, num_classes)</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_pred: Predicted labels, shape = (batch_size, num_classes)</span></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a><span class="co">    - Combined loss value</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">@tf.function</span></span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> loss(y_true, y_pred):</span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>      y_true <span class="op">=</span> tf.cast(y_true, tf.float32)</span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>      y_true <span class="op">=</span> tf.reshape(y_true, [<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>      y_pred <span class="op">=</span> tf.reshape(y_pred, [<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>      cb_loss <span class="op">=</span> class_balanced_loss(y_true, y_pred, beta<span class="op">=</span>beta, samples_per_cls<span class="op">=</span>samples_per_cls)</span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a>      fl_loss <span class="op">=</span> focal_loss(y_true, y_pred, gamma<span class="op">=</span>gamma, alpha<span class="op">=</span>alpha)</span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ((<span class="dv">1</span> <span class="op">-</span> focal_loss_percent) <span class="op">*</span> cb_loss) <span class="op">+</span> (focal_loss_percent <span class="op">*</span> fl_loss)</span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loss</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a><span class="co">##Binary class balance loss</span></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_class_balanced_weights(beta, samples_per_cls):</span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>    effective_num <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> np.power(beta, samples_per_cls)</span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>    effective_num <span class="op">=</span> np.where(effective_num <span class="op">==</span> <span class="dv">0</span>, <span class="fl">1e-8</span>, effective_num)  <span class="co"># Avoid division by zero</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> beta) <span class="op">/</span> effective_num</span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> weights <span class="op">/</span> np.<span class="bu">sum</span>(weights) <span class="op">*</span> <span class="bu">len</span>(samples_per_cls)</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weights</span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> class_balanced_binary_cross_entropy(beta, samples_per_cls):</span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> get_class_balanced_weights(beta, samples_per_cls)</span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>    weight_for_0 <span class="op">=</span> weights[<span class="dv">0</span>]</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a>    weight_for_1 <span class="op">=</span> weights[<span class="dv">1</span>]</span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> loss(y_true, y_pred):</span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> tf.cast(y_true, tf.float32)</span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a>        bce <span class="op">=</span> tf.keras.losses.binary_crossentropy(y_true, y_pred)</span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a>        weights_per_sample <span class="op">=</span> y_true <span class="op">*</span> weight_for_1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> weight_for_0</span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a>        weighted_bce <span class="op">=</span> weights_per_sample <span class="op">*</span> bce</span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.reduce_mean(weighted_bce)</span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loss</span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> focal_loss_keras_bce(y_true, y_pred, gamma, alpha):</span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a><span class="co">    Focal Loss function.</span></span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_true: Ground truth labels, shape = (batch_size, num_classes)</span></span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_pred: Predicted labels, shape = (batch_size, num_classes)</span></span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a><span class="co">    - gamma: Focusing parameter (default is 2.0)</span></span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a><span class="co">    - alpha: Balancing factor (default is 0.25)</span></span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a><span class="co">    - Loss value</span></span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-130"><a href="#cb46-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">#y_true = tf.cast(y_true, tf.float32)</span></span>
<span id="cb46-131"><a href="#cb46-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute cross entropy</span></span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a>    bce <span class="op">=</span> tf.keras.losses.binary_crossentropy(y_true, y_pred)</span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-134"><a href="#cb46-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute focal loss</span></span>
<span id="cb46-135"><a href="#cb46-135" aria-hidden="true" tabindex="-1"></a>    p_t <span class="op">=</span> y_true <span class="op">*</span> y_pred <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> y_pred)</span>
<span id="cb46-136"><a href="#cb46-136" aria-hidden="true" tabindex="-1"></a>    alpha_factor <span class="op">=</span> y_true <span class="op">*</span> alpha <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> y_true) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb46-137"><a href="#cb46-137" aria-hidden="true" tabindex="-1"></a>    modulating_factor <span class="op">=</span> tf.<span class="bu">pow</span>(<span class="fl">1.0</span> <span class="op">-</span> p_t, gamma)</span>
<span id="cb46-138"><a href="#cb46-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-139"><a href="#cb46-139" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> alpha_factor <span class="op">*</span> modulating_factor <span class="op">*</span> bce</span>
<span id="cb46-140"><a href="#cb46-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(loss)</span>
<span id="cb46-141"><a href="#cb46-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-142"><a href="#cb46-142" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb46-143"><a href="#cb46-143" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weighted_binary_crossentropy(y_true, y_pred):</span>
<span id="cb46-144"><a href="#cb46-144" aria-hidden="true" tabindex="-1"></a>    class_weight_0 <span class="op">=</span> <span class="fl">0.1</span>  <span class="co"># Weight for class 0 (negative)</span></span>
<span id="cb46-145"><a href="#cb46-145" aria-hidden="true" tabindex="-1"></a>    class_weight_1 <span class="op">=</span> <span class="fl">0.9</span>  <span class="co"># Weight for class 1 (positive)</span></span>
<span id="cb46-146"><a href="#cb46-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-147"><a href="#cb46-147" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> tf.where(tf.equal(y_true, <span class="dv">1</span>), class_weight_1, class_weight_0)</span>
<span id="cb46-148"><a href="#cb46-148" aria-hidden="true" tabindex="-1"></a>    bce <span class="op">=</span> tf.keras.losses.binary_crossentropy(y_true, y_pred)</span>
<span id="cb46-149"><a href="#cb46-149" aria-hidden="true" tabindex="-1"></a>    weighted_bce <span class="op">=</span> bce <span class="op">*</span> weights</span>
<span id="cb46-150"><a href="#cb46-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(weighted_bce)</span>
<span id="cb46-151"><a href="#cb46-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-152"><a href="#cb46-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-153"><a href="#cb46-153" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb46-154"><a href="#cb46-154" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> class_balanced_loss_vect(y_true, y_pred, samples_per_cls, beta):</span>
<span id="cb46-155"><a href="#cb46-155" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-156"><a href="#cb46-156" aria-hidden="true" tabindex="-1"></a><span class="co">    Class-Balanced Loss function with samples_per_cls parameter.</span></span>
<span id="cb46-157"><a href="#cb46-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-158"><a href="#cb46-158" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb46-159"><a href="#cb46-159" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_true: Ground truth labels, shape = (batch_size, num_classes)</span></span>
<span id="cb46-160"><a href="#cb46-160" aria-hidden="true" tabindex="-1"></a><span class="co">    - y_pred: Predicted labels, shape = (batch_size, num_classes)</span></span>
<span id="cb46-161"><a href="#cb46-161" aria-hidden="true" tabindex="-1"></a><span class="co">    - samples_per_cls: List or array containing the number of samples for each class.</span></span>
<span id="cb46-162"><a href="#cb46-162" aria-hidden="true" tabindex="-1"></a><span class="co">    - beta: Hyperparameter to adjust class balancing (usually close to 1.0, default is 0.9999)</span></span>
<span id="cb46-163"><a href="#cb46-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-164"><a href="#cb46-164" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-165"><a href="#cb46-165" aria-hidden="true" tabindex="-1"></a><span class="co">    - Loss value</span></span>
<span id="cb46-166"><a href="#cb46-166" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-167"><a href="#cb46-167" aria-hidden="true" tabindex="-1"></a>    <span class="co">#y_true = tf.cast(y_true, tf.float32)</span></span>
<span id="cb46-168"><a href="#cb46-168" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the effective number of samples</span></span>
<span id="cb46-169"><a href="#cb46-169" aria-hidden="true" tabindex="-1"></a>    effective_num <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> tf.<span class="bu">pow</span>(beta, samples_per_cls)</span>
<span id="cb46-170"><a href="#cb46-170" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">-</span> beta) <span class="op">/</span> tf.maximum(effective_num, tf.keras.backend.epsilon())</span>
<span id="cb46-171"><a href="#cb46-171" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> weights <span class="op">/</span> tf.reduce_sum(weights)  <span class="co"># Normalize weights</span></span>
<span id="cb46-172"><a href="#cb46-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-173"><a href="#cb46-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply weights to the true labels</span></span>
<span id="cb46-174"><a href="#cb46-174" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> tf.reduce_sum(weights <span class="op">*</span> y_true, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb46-175"><a href="#cb46-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-176"><a href="#cb46-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the binary crossentropy loss</span></span>
<span id="cb46-177"><a href="#cb46-177" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> tf.keras.losses.binary_crossentropy(y_true, y_pred)</span>
<span id="cb46-178"><a href="#cb46-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-179"><a href="#cb46-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply class-balanced weights to the loss</span></span>
<span id="cb46-180"><a href="#cb46-180" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> weights <span class="op">*</span> loss</span>
<span id="cb46-181"><a href="#cb46-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(loss)</span>
<span id="cb46-182"><a href="#cb46-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-183"><a href="#cb46-183" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb46-184"><a href="#cb46-184" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> weighted_binary_crossentropy(y_true, y_pred):</span>
<span id="cb46-185"><a href="#cb46-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define class weights</span></span>
<span id="cb46-186"><a href="#cb46-186" aria-hidden="true" tabindex="-1"></a>    class_weight_0 <span class="op">=</span> <span class="fl">0.1</span>  <span class="co"># Weight for class 0 (negative)</span></span>
<span id="cb46-187"><a href="#cb46-187" aria-hidden="true" tabindex="-1"></a>    class_weight_1 <span class="op">=</span> <span class="fl">0.9</span>  <span class="co"># Weight for class 1 (positive)</span></span>
<span id="cb46-188"><a href="#cb46-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-189"><a href="#cb46-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a tensor of weights based on the true labels</span></span>
<span id="cb46-190"><a href="#cb46-190" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> tf.where(tf.equal(y_true, <span class="dv">1</span>), class_weight_1, class_weight_0)</span>
<span id="cb46-191"><a href="#cb46-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-192"><a href="#cb46-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate binary crossentropy</span></span>
<span id="cb46-193"><a href="#cb46-193" aria-hidden="true" tabindex="-1"></a>    bce <span class="op">=</span> tf.keras.losses.binary_crossentropy(y_true, y_pred)</span>
<span id="cb46-194"><a href="#cb46-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-195"><a href="#cb46-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the weights to the loss</span></span>
<span id="cb46-196"><a href="#cb46-196" aria-hidden="true" tabindex="-1"></a>    weighted_bce <span class="op">=</span> bce <span class="op">*</span> weights</span>
<span id="cb46-197"><a href="#cb46-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-198"><a href="#cb46-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the mean loss</span></span>
<span id="cb46-199"><a href="#cb46-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(weighted_bce)</span>
<span id="cb46-200"><a href="#cb46-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-201"><a href="#cb46-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> focal_loss_fix(gamma<span class="op">=</span><span class="fl">2.</span>, alpha<span class="op">=</span><span class="fl">0.25</span>):</span>
<span id="cb46-202"><a href="#cb46-202" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> focal_loss_fixed(y_true, y_pred):</span>
<span id="cb46-203"><a href="#cb46-203" aria-hidden="true" tabindex="-1"></a>        epsilon <span class="op">=</span> K.epsilon()</span>
<span id="cb46-204"><a href="#cb46-204" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> K.clip(y_pred, epsilon, <span class="fl">1.</span> <span class="op">-</span> epsilon)</span>
<span id="cb46-205"><a href="#cb46-205" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> K.cast(y_true, K.floatx())</span>
<span id="cb46-206"><a href="#cb46-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-207"><a href="#cb46-207" aria-hidden="true" tabindex="-1"></a>        alpha_t <span class="op">=</span> y_true <span class="op">*</span> alpha <span class="op">+</span> (K.ones_like(y_true) <span class="op">-</span> y_true) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb46-208"><a href="#cb46-208" aria-hidden="true" tabindex="-1"></a>        p_t <span class="op">=</span> y_true <span class="op">*</span> y_pred <span class="op">+</span> (K.ones_like(y_true) <span class="op">-</span> y_true) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> y_pred)</span>
<span id="cb46-209"><a href="#cb46-209" aria-hidden="true" tabindex="-1"></a>        fl <span class="op">=</span> <span class="op">-</span> alpha_t <span class="op">*</span> K.<span class="bu">pow</span>((K.ones_like(y_true) <span class="op">-</span> p_t), gamma) <span class="op">*</span> K.log(p_t)</span>
<span id="cb46-210"><a href="#cb46-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> K.mean(fl)</span>
<span id="cb46-211"><a href="#cb46-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> focal_loss_fixed</span>
<span id="cb46-212"><a href="#cb46-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-213"><a href="#cb46-213" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_binary_crossentropy_weighted_loss(positive_weights<span class="op">=</span>np.array([<span class="fl">5.291666666666667</span>]), negative_weights<span class="op">=</span>np.array([<span class="fl">0.5521739130434783</span>]), epsilon<span class="op">=</span><span class="fl">1e-7</span>):</span>
<span id="cb46-214"><a href="#cb46-214" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-215"><a href="#cb46-215" aria-hidden="true" tabindex="-1"></a><span class="co">    Note: Imported from the AI for Medicine Specialization course on Coursera: Assignment 1 Week 1.</span></span>
<span id="cb46-216"><a href="#cb46-216" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns weighted binary cross entropy loss function given negative weights and positive weights.</span></span>
<span id="cb46-217"><a href="#cb46-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-218"><a href="#cb46-218" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb46-219"><a href="#cb46-219" aria-hidden="true" tabindex="-1"></a><span class="co">      positive_weights (np.array): array of positive weights for each class, size (num_classes)</span></span>
<span id="cb46-220"><a href="#cb46-220" aria-hidden="true" tabindex="-1"></a><span class="co">      negative_weights (np.array): array of negative weights for each class, size (num_classes)</span></span>
<span id="cb46-221"><a href="#cb46-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-222"><a href="#cb46-222" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb46-223"><a href="#cb46-223" aria-hidden="true" tabindex="-1"></a><span class="co">      weighted_loss (function): weighted loss function</span></span>
<span id="cb46-224"><a href="#cb46-224" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-225"><a href="#cb46-225" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> binary_crossentropy_weighted_loss(y_true, y_pred):</span>
<span id="cb46-226"><a href="#cb46-226" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb46-227"><a href="#cb46-227" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns weighted binary cross entropy loss value.</span></span>
<span id="cb46-228"><a href="#cb46-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-229"><a href="#cb46-229" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb46-230"><a href="#cb46-230" aria-hidden="true" tabindex="-1"></a><span class="co">            y_true (Tensor): Tensor of true labels, size is (num_examples, num_classes)</span></span>
<span id="cb46-231"><a href="#cb46-231" aria-hidden="true" tabindex="-1"></a><span class="co">            y_pred (Tensor): Tensor of predicted labels, size is (num_examples, num_classes)</span></span>
<span id="cb46-232"><a href="#cb46-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-233"><a href="#cb46-233" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb46-234"><a href="#cb46-234" aria-hidden="true" tabindex="-1"></a><span class="co">            loss (Tensor): overall scalar loss summed across all classes</span></span>
<span id="cb46-235"><a href="#cb46-235" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb46-236"><a href="#cb46-236" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> tf.cast(y_true, tf.float32)</span>
<span id="cb46-237"><a href="#cb46-237" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> tf.cast(y_pred, tf.float32)</span>
<span id="cb46-238"><a href="#cb46-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-239"><a href="#cb46-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># initialize loss to zero</span></span>
<span id="cb46-240"><a href="#cb46-240" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb46-241"><a href="#cb46-241" aria-hidden="true" tabindex="-1"></a>        <span class="co">#y_true = tf.cast(y_true, tf.float32)</span></span>
<span id="cb46-242"><a href="#cb46-242" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(positive_weights)):</span>
<span id="cb46-243"><a href="#cb46-243" aria-hidden="true" tabindex="-1"></a>            <span class="co"># for each class, add average weighted loss for that class</span></span>
<span id="cb46-244"><a href="#cb46-244" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">+=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> K.mean((positive_weights[i] <span class="op">*</span> y_true[:, i] <span class="op">*</span> K.log(y_pred[:, i] <span class="op">+</span> epsilon) <span class="op">+</span></span>
<span id="cb46-245"><a href="#cb46-245" aria-hidden="true" tabindex="-1"></a>                                negative_weights[i] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> y_true[:, i]) <span class="op">*</span> K.log(<span class="dv">1</span> <span class="op">-</span> y_pred[:, i] <span class="op">+</span> epsilon)))</span>
<span id="cb46-246"><a href="#cb46-246" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb46-247"><a href="#cb46-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-248"><a href="#cb46-248" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> binary_crossentropy_weighted_loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metrics" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6" class="anchored" data-anchor-id="metrics"><span class="header-section-number">3.1.6</span> Metrics</h3>
<div id="954609f3" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score(y_true, y_pred, min_tpr: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.80</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    v_gt <span class="op">=</span> <span class="bu">abs</span>(np.asarray(y_true) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    v_pred <span class="op">=</span> np.array([<span class="fl">1.0</span> <span class="op">-</span> x <span class="cf">for</span> x <span class="kw">in</span> y_pred])</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    max_fpr <span class="op">=</span> <span class="bu">abs</span>(<span class="dv">1</span> <span class="op">-</span> min_tpr)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    partial_auc_scaled <span class="op">=</span> roc_auc_score(v_gt, v_pred, max_fpr<span class="op">=</span>max_fpr)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    partial_auc <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> max_fpr<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (max_fpr <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> max_fpr<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span>) <span class="op">*</span> (partial_auc_scaled <span class="op">-</span> <span class="fl">0.5</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> partial_auc</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="at">@register_keras_serializable</span>()</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> F1Score(tf.keras.metrics.Metric):</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name<span class="op">=</span><span class="st">'f1_score'</span>, <span class="op">**</span>kwargs):</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(F1Score, <span class="va">self</span>).<span class="fu">__init__</span>(name<span class="op">=</span>name, <span class="op">**</span>kwargs)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.precision <span class="op">=</span> tf.keras.metrics.Precision()</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.recall <span class="op">=</span> tf.keras.metrics.Recall()</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_state(<span class="va">self</span>, y_true, y_pred, sample_weight<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.precision.update_state(y_true, y_pred, sample_weight)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.recall.update_state(y_true, y_pred, sample_weight)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> result(<span class="va">self</span>):</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        precision <span class="op">=</span> <span class="va">self</span>.precision.result()</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>        recall <span class="op">=</span> <span class="va">self</span>.recall.result()</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> ((precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall <span class="op">+</span> tf.keras.backend.epsilon()))</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset_state(<span class="va">self</span>):</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.precision.reset_state()</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.recall.reset_state()</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_labels_and_predictions(model, dataset, steps):</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return true labels and predictions from the model."""</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    y_true, y_pred <span class="op">=</span> [], []</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x_batch, y_batch <span class="kw">in</span> dataset.take(steps):</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>        y_pred_batch <span class="op">=</span> model.predict_on_batch(x_batch).ravel()</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>        y_true.append(y_batch)</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>        y_pred.append(y_pred_batch)</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf.concat(y_true, axis<span class="op">=</span><span class="dv">0</span>), tf.concat(y_pred, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_model(model, eval_dataset, evaluation_steps, dataset_name<span class="op">=</span><span class="st">'eval_dataset'</span>):</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Evaluating'</span>, dataset_name, <span class="st">'with'</span>, evaluation_steps, <span class="st">'steps'</span>)</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    y_val, y_pred <span class="op">=</span> get_labels_and_predictions(model, eval_dataset, evaluation_steps)</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    partial_auc <span class="op">=</span> score(y_val, y_pred)</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Partial AUC for </span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>partial_auc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_memory_usage():</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># memory_usage returns a list, so we get the first item</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>    mem <span class="op">=</span> memory_usage(<span class="op">-</span><span class="dv">1</span>, interval<span class="op">=</span><span class="fl">0.1</span>, timeout<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>] <span class="co"># Return the first value from the list in MB</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>    mem <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>mem<span class="sc">:.2f}</span><span class="ss"> MB"</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  mem</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reset_session_and_get_memory():</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Cleans up the session and retrieves the initial memory usage."""</span></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>    clean_session()</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_memory_usage()</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_memory_usage(stage, memory_usage):</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Logs the memory usage with a specific stage identifier."""</span></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>stage<span class="sc">}</span><span class="ss"> memory usage: </span><span class="sc">{</span>memory_usage<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="callbacks" class="level3" data-number="3.1.7">
<h3 data-number="3.1.7" class="anchored" data-anchor-id="callbacks"><span class="header-section-number">3.1.7</span> Callbacks</h3>
<div id="41d94059" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PartialAUCCallback(tf.keras.callbacks.Callback):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, validation_data, validation_steps, monitor, train_data <span class="op">=</span> <span class="va">None</span>, steps_per_epoch<span class="op">=</span><span class="va">None</span>, min_tpr<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(PartialAUCCallback, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.validation_data <span class="op">=</span> validation_data</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.validation_steps <span class="op">=</span> validation_steps</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.monitor <span class="op">=</span> monitor</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_data <span class="op">=</span> train_data</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.steps_per_epoch <span class="op">=</span> steps_per_epoch</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_tpr <span class="op">=</span> min_tpr</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_fpr <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> min_tpr</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.best_partial_auc <span class="op">=</span> <span class="op">-</span><span class="bu">float</span>(<span class="st">'inf'</span>)  <span class="co"># Initialize to a very low value</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.best_epoch <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_epoch_end(<span class="va">self</span>, epoch, logs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        logs <span class="op">=</span> logs <span class="kw">or</span> {}</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute Partial AUC on Training Data if available</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.train_data:</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>            train_labels, train_predictions <span class="op">=</span> get_labels_and_predictions(<span class="va">self</span>.model,</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>                                                                         <span class="va">self</span>.train_data,</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>                                                                         <span class="va">self</span>.steps_per_epoch)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>            train_partial_auc <span class="op">=</span> <span class="va">self</span>.compute_auc(train_labels, train_predictions)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.log_partial_auc(logs, train_partial_auc, <span class="st">'partial_auc'</span>, epoch)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>            PartialAUCCallback.log_classification_report(train_labels, train_predictions, epoch, <span class="st">'Train'</span>)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Validation computations</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>        val_labels, val_predictions <span class="op">=</span> get_labels_and_predictions(<span class="va">self</span>.model,</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="va">self</span>.validation_data,</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="va">self</span>.validation_steps)</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the partial AUC</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>        val_partial_auc <span class="op">=</span> <span class="va">self</span>.compute_auc(val_labels, val_predictions)</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_partial_auc(logs, val_partial_auc, <span class="st">'val_partial_auc'</span>, epoch)</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>        PartialAUCCallback.log_classification_report(val_labels, val_predictions, epoch)</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> log_partial_auc(<span class="va">self</span>, logs, partial_auc, pauc_metric_name, epoch):</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>        logs[pauc_metric_name] <span class="op">=</span> partial_auc</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.monitor <span class="op">==</span> pauc_metric_name:</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store the best partial AUC</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> partial_auc <span class="op">&gt;</span> <span class="va">self</span>.best_partial_auc:</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.best_partial_auc <span class="op">=</span> partial_auc</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.best_epoch <span class="op">=</span> epoch</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Add the partial_auc to logs so it can be used in Keras Tuner</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>        logs[pauc_metric_name] <span class="op">=</span> partial_auc</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="ss">Epoch </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: Partial AUC = </span><span class="sc">{</span>partial_auc<span class="sc">:.4f}</span><span class="ss">'</span>)</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> log_classification_report(labels, predictions, epoch, name<span class="op">=</span><span class="st">'Validation'</span>):</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert probabilities to binary predictions</span></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>        bin_preds <span class="op">=</span> np.<span class="bu">round</span>(predictions).astype(<span class="bu">int</span>)</span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate the classification report</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> classification_report(labels, bin_preds, labels<span class="op">=</span> [<span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>                                       target_names<span class="op">=</span>[<span class="st">'positives'</span>, <span class="st">'negatives'</span>])</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print the report</span></span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> classification report for epoch </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="sc">{</span>report<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_auc(<span class="va">self</span>, y_true, y_pred, max_fpr<span class="op">=</span><span class="fl">0.2</span>):</span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>        v_gt <span class="op">=</span> np.<span class="bu">abs</span>(y_true <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>        v_pred <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> y_pred</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>        partial_auc_scaled <span class="op">=</span> roc_auc_score(v_gt, v_pred, max_fpr<span class="op">=</span>max_fpr)</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>        partial_auc <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> max_fpr<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> (max_fpr <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> max_fpr<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">-</span> <span class="fl">0.5</span>) <span class="op">*</span> (partial_auc_scaled <span class="op">-</span> <span class="fl">0.5</span>)</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> partial_auc</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_auc_kaggle(<span class="va">self</span>, y_true, y_pred):</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>        y_true <span class="op">=</span> tf.cast(y_true, tf.float32).numpy()</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> tf.cast(y_pred, tf.float32).numpy()</span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Invert classes as needed for minority focus</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>        v_gt <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> y_true</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>        v_pred <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> y_pred</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>        fpr, tpr, _ <span class="op">=</span> roc_curve(v_gt, v_pred)</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find where FPR reaches max_fpr</span></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>        stop <span class="op">=</span> np.searchsorted(fpr, <span class="va">self</span>.max_fpr, <span class="st">'right'</span>)</span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># If max_fpr is very low and FPR doesn't reach it</span></span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>        x_interp <span class="op">=</span> [fpr[stop <span class="op">-</span> <span class="dv">1</span>], fpr[stop]]</span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>        y_interp <span class="op">=</span> [tpr[stop <span class="op">-</span> <span class="dv">1</span>], tpr[stop]]</span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>        tpr_interp <span class="op">=</span> np.interp(<span class="va">self</span>.max_fpr, x_interp, y_interp)</span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append this interpolated point and calculate AUC</span></span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>        tpr <span class="op">=</span> np.append(tpr[:stop], tpr_interp)</span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a>        fpr <span class="op">=</span> np.append(fpr[:stop], <span class="va">self</span>.max_fpr)</span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> auc(fpr, tpr)</span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_best_partial_auc(<span class="va">self</span>):</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.best_partial_auc</span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_best_epoch(<span class="va">self</span>):</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.best_epoch</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __deepcopy__(<span class="va">self</span>, memo):</span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip deep copying the validation data to avoid issues</span></span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> PartialAUCCallback(<span class="va">self</span>.validation_data, <span class="va">self</span>.validation_steps,</span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a>                                  <span class="va">self</span>.monitor, <span class="va">self</span>.train_data,</span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>                                  <span class="va">self</span>.steps_per_epoch, <span class="va">self</span>.min_tpr)</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LearningRatePrinterCallback(tf.keras.callbacks.Callback):</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_epoch_end(<span class="va">self</span>, epoch, logs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Access the learning rate from the optimizer</span></span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">=</span> <span class="va">self</span>.model.optimizer.learning_rate</span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the learning rate is a learning rate schedule (like CyclicalLearningRate), evaluate it</span></span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(lr, tf.keras.optimizers.schedules.LearningRateSchedule):</span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>            lr <span class="op">=</span> lr(<span class="va">self</span>.model.optimizer.iterations)</span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>        tf.<span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Learning rate at the end of epoch </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tf<span class="sc">.</span>keras<span class="sc">.</span>backend<span class="sc">.</span>get_value(lr)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom Callback to monitor memory after each epoch</span></span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MemoryUsageCallback(tf.keras.callbacks.Callback):</span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_epoch_end(<span class="va">self</span>, epoch, logs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a>        process <span class="op">=</span> psutil.Process(os.getpid())</span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a>        mem <span class="op">=</span> process.memory_info().rss <span class="op">/</span> (<span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)  <span class="co"># RSS memory in MB</span></span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Memory usage after epoch </span><span class="sc">{</span>epoch <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>mem<span class="sc">:.2f}</span><span class="ss"> MB"</span>)</span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a>        <span class="co">#tf.keras.backend.clear_session()</span></span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">#tf.compat.v1.reset_default_graph()</span></span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a>        <span class="co">#clean_session()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optimizers" class="level3" data-number="3.1.8">
<h3 data-number="3.1.8" class="anchored" data-anchor-id="optimizers"><span class="header-section-number">3.1.8</span> Optimizers</h3>
<div id="39e1256a" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_metric_name(metric_name):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use regular expression to check if the string ends with _ followed by digits</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> re.search(<span class="vs">r'_\d+$'</span>, metric_name):</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove the _ and the digits at the end</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> re.sub(<span class="vs">r'_\d+$'</span>, <span class="st">''</span>, metric_name)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metric_name</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a custom learning rate scheduler for cyclical learning rates</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CyclicalLearningRate(tf.keras.optimizers.schedules.LearningRateSchedule):</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, initial_learning_rate, maximal_learning_rate, step_size):</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.initial_learning_rate <span class="op">=</span> tf.cast(initial_learning_rate, tf.float32)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.maximal_learning_rate <span class="op">=</span> tf.cast(maximal_learning_rate, tf.float32)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.step_size <span class="op">=</span> tf.cast(step_size, tf.float32)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, step):</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        step <span class="op">=</span> tf.cast(step, tf.float32)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        cycle <span class="op">=</span> tf.floor(<span class="dv">1</span> <span class="op">+</span> step <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.step_size))</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> tf.<span class="bu">abs</span>(step <span class="op">/</span> <span class="va">self</span>.step_size <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> cycle <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">=</span> <span class="va">self</span>.initial_learning_rate <span class="op">+</span> (<span class="va">self</span>.maximal_learning_rate <span class="op">-</span> <span class="va">self</span>.initial_learning_rate) <span class="op">*</span> tf.maximum(<span class="fl">0.0</span>, (<span class="dv">1</span> <span class="op">-</span> x))</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lr</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"initial_learning_rate"</span>: <span class="va">self</span>.initial_learning_rate.numpy(),</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"maximal_learning_rate"</span>: <span class="va">self</span>.maximal_learning_rate.numpy(),</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"step_size"</span>: <span class="va">self</span>.step_size.numpy(),</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the parameters for the CLR</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>initial_learning_rate <span class="op">=</span> <span class="fl">1e-6</span>  <span class="co"># Minimum LR</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>maximal_learning_rate <span class="op">=</span> <span class="fl">1e-4</span>  <span class="co"># Maximum LR</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>step_size <span class="op">=</span> <span class="dv">50</span>  <span class="co"># Number of steps in half a cycle</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_optimizer(optimizer, learning_rate<span class="op">=</span><span class="fl">1e-4</span>, use_nesterov_sgd<span class="op">=</span><span class="va">False</span>, use_amsgrad_adam<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>                  initial_learning_rate<span class="op">=</span><span class="fl">1e-6</span>,</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>                  maximal_learning_rate<span class="op">=</span><span class="fl">1e-4</span>,</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>                  step_size<span class="op">=</span><span class="dv">50</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>                  ):</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> optimizer <span class="op">==</span> <span class="st">"sgd"</span>:</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optimizers.SGD(</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>            momentum<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>            nesterov<span class="op">=</span>use_nesterov_sgd</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"adam"</span>:</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optimizers.Adam(</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>            beta_1<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>            beta_2<span class="op">=</span><span class="fl">0.999</span>,</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>            epsilon<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>            amsgrad<span class="op">=</span>use_amsgrad_adam</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"nadam"</span>:</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optimizers.Nadam(</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>            beta_1<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>            beta_2<span class="op">=</span><span class="fl">0.999</span>,</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>            epsilon<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"adamw"</span>:</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optimizers.AdamW(</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>            beta_1<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>            beta_2<span class="op">=</span><span class="fl">0.999</span>,</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>            epsilon<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"adamax"</span>:</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optimizers.Adamax(</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>            beta_1<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>            beta_2<span class="op">=</span><span class="fl">0.999</span>,</span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>            epsilon<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"radam"</span>:</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> tfa.optimizers.RectifiedAdam(</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>            beta_1<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>            beta_2<span class="op">=</span><span class="fl">0.999</span>,</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>            epsilon<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"rmsprop"</span>:</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> optimizers.RMSprop(</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span>learning_rate,</span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>            rho<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>            momentum<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>            epsilon<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>            centered<span class="op">=</span><span class="va">False</span></span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"nadam_cyclical"</span>:</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>         optimizer <span class="op">=</span>  optimizers.Nadam(</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>             learning_rate<span class="op">=</span>CyclicalLearningRate(</span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>                 initial_learning_rate<span class="op">=</span>initial_learning_rate,</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>                 maximal_learning_rate<span class="op">=</span>maximal_learning_rate,</span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>                 step_size<span class="op">=</span>step_size</span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"radam_cyclical"</span>:</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>         optimizer <span class="op">=</span> tfa.optimizers.RectifiedAdam(</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>             learning_rate<span class="op">=</span>CyclicalLearningRate(</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>                 initial_learning_rate<span class="op">=</span>initial_learning_rate,</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>                 maximal_learning_rate<span class="op">=</span>maximal_learning_rate,</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>                 step_size<span class="op">=</span>step_size</span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> optimizer <span class="op">==</span> <span class="st">"adamw_cyclical"</span>:</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a>         optimizer <span class="op">=</span>  optimizers.AdamW(</span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>             learning_rate<span class="op">=</span>CyclicalLearningRate(</span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>                 initial_learning_rate<span class="op">=</span>initial_learning_rate,</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a>                 maximal_learning_rate<span class="op">=</span>maximal_learning_rate,</span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>                 step_size<span class="op">=</span>step_size</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> optimizer</span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OneCycleScheduler(tf.keras.callbacks.Callback):</span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, max_lr, steps_per_epoch, epochs, start_lr<span class="op">=</span><span class="va">None</span>, last_epoch_lr<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(OneCycleScheduler, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_lr <span class="op">=</span> max_lr</span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.steps_per_epoch <span class="op">=</span> steps_per_epoch</span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.epochs <span class="op">=</span> epochs</span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total_steps <span class="op">=</span> steps_per_epoch <span class="op">*</span> epochs</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.current_step <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> start_lr <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.start_lr <span class="op">=</span> max_lr <span class="op">/</span> <span class="dv">25</span>  <span class="co"># A commonly used starting ratio</span></span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.start_lr <span class="op">=</span> start_lr</span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> last_epoch_lr <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.last_epoch_lr <span class="op">=</span> <span class="va">self</span>.start_lr <span class="op">/</span> <span class="fl">1e4</span>  <span class="co"># A small value to anneal towards</span></span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.last_epoch_lr <span class="op">=</span> last_epoch_lr</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_batch_begin(<span class="va">self</span>, batch, logs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update learning rate based on current step</span></span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.current_step <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">=</span> <span class="va">self</span>.calc_lr()</span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">#tf.keras.backend.set_value(self.model.optimizer[0].lr, lr)</span></span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>        tf.keras.backend.set_value(<span class="va">self</span>.model.optimizer.lr, lr)</span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calc_lr(<span class="va">self</span>):</span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1Cycle Learning Rate Schedule: Increases then decreases</span></span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a>        step_ratio <span class="op">=</span> <span class="va">self</span>.current_step <span class="op">/</span> <span class="va">self</span>.total_steps</span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> step_ratio <span class="op">&lt;</span> <span class="fl">0.6</span>:</span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Increase learning rate for first half of training</span></span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a>            lr <span class="op">=</span> <span class="va">self</span>.start_lr <span class="op">+</span> (<span class="va">self</span>.max_lr <span class="op">-</span> <span class="va">self</span>.start_lr) <span class="op">*</span> (step_ratio <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Decrease learning rate for the second half of training</span></span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a>            lr <span class="op">=</span> <span class="va">self</span>.max_lr <span class="op">-</span> (<span class="va">self</span>.max_lr <span class="op">-</span> <span class="va">self</span>.last_epoch_lr) <span class="op">*</span> ((step_ratio <span class="op">-</span> <span class="fl">0.5</span>) <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lr</span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SGDRScheduler(tf.keras.callbacks.Callback):</span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Cosine annealing learning rate scheduler with periodic restarts.'''</span></span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, min_lr, max_lr, steps_per_epoch, lr_decay<span class="op">=</span><span class="dv">1</span>, cycle_length<span class="op">=</span><span class="dv">10</span>, mult_factor<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(SGDRScheduler, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_lr <span class="op">=</span> min_lr</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_lr <span class="op">=</span> max_lr</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lr_decay <span class="op">=</span> lr_decay</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.steps_per_epoch <span class="op">=</span> steps_per_epoch</span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_since_restart <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.next_restart <span class="op">=</span> cycle_length</span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cycle_length <span class="op">=</span> cycle_length</span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mult_factor <span class="op">=</span> mult_factor</span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_batch_begin(<span class="va">self</span>, batch, logs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''Adjust the learning rate at the start of each batch.'''</span></span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a>        fraction_to_restart <span class="op">=</span> <span class="va">self</span>.batch_since_restart <span class="op">/</span> (<span class="va">self</span>.steps_per_epoch <span class="op">*</span> <span class="va">self</span>.cycle_length)</span>
<span id="cb49-169"><a href="#cb49-169" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">=</span> <span class="va">self</span>.min_lr <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="va">self</span>.max_lr <span class="op">-</span> <span class="va">self</span>.min_lr) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> np.cos(fraction_to_restart <span class="op">*</span> np.pi))</span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a>        tf.keras.backend.set_value(<span class="va">self</span>.model.optimizer.lr, lr)</span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_since_restart <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_epoch_end(<span class="va">self</span>, epoch, logs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''Check for end of current cycle, apply restarts when necessary.'''</span></span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">+</span> <span class="dv">1</span> <span class="op">==</span> <span class="va">self</span>.next_restart:</span>
<span id="cb49-176"><a href="#cb49-176" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.batch_since_restart <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-177"><a href="#cb49-177" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.next_restart <span class="op">+=</span> <span class="va">self</span>.cycle_length</span>
<span id="cb49-178"><a href="#cb49-178" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.cycle_length <span class="op">=</span> <span class="bu">int</span>(<span class="va">self</span>.cycle_length <span class="op">*</span> <span class="va">self</span>.mult_factor)</span>
<span id="cb49-179"><a href="#cb49-179" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.max_lr <span class="op">*=</span> <span class="va">self</span>.lr_decay</span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.min_lr <span class="op">*=</span> <span class="va">self</span>.lr_decay</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="training-utils" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="training-utils"><span class="header-section-number">3.2</span> Training utils</h2>
<section id="plotting-metrics" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="plotting-metrics"><span class="header-section-number">3.2.1</span> Plotting metrics</h3>
<div id="3f8666ef" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_training_history(history, model_name, metrics<span class="op">=</span>[<span class="st">'f1_score'</span>, <span class="st">'precision'</span>, <span class="st">'recall'</span>, <span class="st">'loss'</span>, <span class="st">'accuracy'</span>, <span class="st">'partial_auc'</span>, <span class="st">'auc'</span>]):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">16</span>))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, metric <span class="kw">in</span> <span class="bu">enumerate</span>(metrics):</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">4</span>, <span class="dv">2</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        plt.title(metric.capitalize())</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> metric <span class="kw">in</span> history:</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>            plt.plot(history[metric], label<span class="op">=</span>metric)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="ss">f'val_</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">'</span> <span class="kw">in</span> history:</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>            plt.plot(history[<span class="ss">f'val_</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">'</span>], label<span class="op">=</span><span class="ss">f'val_</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    plt.title(model_name, loc<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="ss">f'</span><span class="sc">{</span>models_dir<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_training_</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_history_keys(history):</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Normalize the keys in the history dictionary using clean_metric_name.</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {clean_metric_name(key): value <span class="cf">for</span> key, value <span class="kw">in</span> history.items()}</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_infos(training_mode, fold_no, messages):</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> training_mode <span class="op">==</span> <span class="st">'train-validation-split'</span>:</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> message <span class="kw">in</span> messages:</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(message.capitalize())</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> message <span class="kw">in</span> messages:</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Fold </span><span class="sc">{</span>fold_no <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, message)</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_histories(history_initial, history_fine_tune):</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge histories</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> history_initial <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize the keys in history_initial</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>        history_initial_cleaned <span class="op">=</span> normalize_history_keys(history_initial.history)</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> history_initial_cleaned.items():</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>            history[key] <span class="op">=</span> value</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalize the keys in history_fine_tune</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>        history_fine_tune_cleaned <span class="op">=</span> normalize_history_keys(history_fine_tune.history)</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> history_fine_tune_cleaned.items():</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>            history[key].extend(value)</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> <span class="bu">dict</span>(history)</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-loading" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="data-loading"><span class="header-section-number">3.2.2</span> Data loading</h3>
<div id="5f3e707e" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_train_val_dataset(file_pattern, shuffle_dataset_at_each_call<span class="op">=</span><span class="va">True</span>, cache_dataset<span class="op">=</span><span class="va">True</span>, cache_in_memory<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                 cache_dir<span class="op">=</span>cache_dir, prefix<span class="op">=</span><span class="st">"train_val"</span>, run_id<span class="op">=</span>run_id, check_modification_time<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                 is_training<span class="op">=</span><span class="va">True</span>, force_cache<span class="op">=</span><span class="va">True</span>, use_tabular_data<span class="op">=</span>use_tabular_data, batch_size<span class="op">=</span>batch_size):</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Reloading and shuffling dataset..."</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> dataset</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'batch_size'</span>, batch_size)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'file_pattern'</span>, file_pattern)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'is_training'</span>, is_training)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'cache_in_memory'</span>, cache_in_memory)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load dataset once and cache</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    dataset, dataset_steps <span class="op">=</span> load_tfrecord_dataset(file_pattern<span class="op">=</span>file_pattern, is_training<span class="op">=</span>is_training,</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>                                                   batch_size<span class="op">=</span>batch_size, cache_in_memory<span class="op">=</span>cache_in_memory)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dataset = cast_labels(dataset, use_tabular_data)</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dataset = persist_dataset(dataset, file_pattern=train_file_pattern, dataset_steps=dataset_steps, cache_in_memory=cache_in_memory,</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#cache_dir=cache_dir, prefix=prefix, run_id=run_id, check_modification_time=check_modification_time, force_cache=force_cache)</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract labels for stratified splitting</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    use_cross_validation <span class="op">=</span> <span class="va">False</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_cross_validation :</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> []</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">*</span>_, lbl <span class="kw">in</span> dataset:</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>            labels.append(lbl.numpy())</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> np.array(labels)</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>        seed <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="fl">1e9</span>) <span class="cf">if</span> shuffle_dataset_at_each_call <span class="cf">else</span> <span class="dv">42</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_cross_validation:</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Generate stratified split indices for cross-validation</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>            split_indices <span class="op">=</span> stratified_split_indices(labels, n_splits<span class="op">=</span><span class="dv">5</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span>seed)</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a stratified 80/20 train-test split</span></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>            sss <span class="op">=</span> StratifiedShuffleSplit(n_splits<span class="op">=</span><span class="dv">1</span>, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span>seed)</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>            train_index, val_index <span class="op">=</span> <span class="bu">next</span>(sss.split(np.zeros(<span class="bu">len</span>(labels)), labels))</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>            split_indices <span class="op">=</span> [(train_index, val_index)]  <span class="co"># Single split for train-test</span></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dataset, split_indices, dataset_steps</span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dataset, dataset_steps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-pipeline-common" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="training-pipeline-common"><span class="header-section-number">3.2.3</span> Training pipeline common</h3>
<div id="d5ae90bc" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> training_pipeline(model_name, model_names<span class="op">=</span><span class="va">None</span>, model<span class="op">=</span><span class="va">None</span>, train_file_pattern<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    run_id <span class="op">=</span> kwargs.get(<span class="st">'run_id'</span>, <span class="va">None</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    strategy <span class="op">=</span> kwargs.get(<span class="st">'strategy'</span>, <span class="va">None</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    batch_size <span class="op">=</span> kwargs.get(<span class="st">'batch_size'</span>, <span class="va">None</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    val_batch_size <span class="op">=</span> kwargs.get(<span class="st">'val_batch_size'</span>, <span class="va">None</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    cache_in_memory <span class="op">=</span> kwargs.get(<span class="st">'cache_in_memory'</span>, <span class="va">None</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    freeze_base_model <span class="op">=</span> kwargs.get(<span class="st">'freeze_base_model'</span>, <span class="va">None</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> kwargs.get(<span class="st">'loss'</span>, <span class="va">None</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    shuffle_dataset_at_each_call <span class="op">=</span> kwargs.get(<span class="st">'shuffle_dataset_at_each_call'</span>, <span class="va">None</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    do_fine_tuning <span class="op">=</span> kwargs.get(<span class="st">'do_fine_tuning'</span>, <span class="va">None</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    initial_epochs <span class="op">=</span> kwargs.get(<span class="st">'initial_epochs'</span>, <span class="va">None</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    fine_tune_epochs <span class="op">=</span> kwargs.get(<span class="st">'fine_tune_epochs'</span>, <span class="va">None</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    oversample_minority_class <span class="op">=</span> kwargs.get(<span class="st">'oversample_minority_class'</span>, <span class="va">None</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    augment_train_data <span class="op">=</span> kwargs.get(<span class="st">'augment_train_data'</span>, <span class="va">None</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    use_cross_validation <span class="op">=</span> kwargs.get(<span class="st">'use_cross_validation'</span>, <span class="va">None</span>)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    use_tabular_data <span class="op">=</span> kwargs.get(<span class="st">'use_tabular_data'</span>, <span class="va">None</span>)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    execution_env <span class="op">=</span> kwargs.get(<span class="st">'execution_env'</span>, <span class="va">None</span>)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    total_epochs <span class="op">=</span> initial_epochs <span class="op">+</span> fine_tune_epochs  <span class="cf">if</span> freeze_base_model <span class="cf">else</span> fine_tune_epochs</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cleaning the session</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    deletes_old_datasets()</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    partial_aucs <span class="op">=</span> []</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    training_mode <span class="op">=</span> <span class="st">'train-validation-split'</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Kwargs from training_pipeline "</span>, kwargs)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load train dataset once and cache</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    train_dataset, training_steps <span class="op">=</span> load_tfrecord_dataset(file_pattern<span class="op">=</span>train_file_pattern,</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>                                                        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>                                                        is_training<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>                                                        cache_in_memory<span class="op">=</span>cache_in_memory)</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validation dataset</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    val_dataset, validation_steps <span class="op">=</span> load_tfrecord_dataset(<span class="ss">f'</span><span class="sc">{</span>tf_records_eval_dir<span class="sc">}</span><span class="ss">/*.tfrecord'</span>,</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>                                                                batch_size<span class="op">=</span>val_batch_size,</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>                                                                is_training<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>                                                                cache_in_memory<span class="op">=</span>cache_in_memory)</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    print_infos(training_mode, <span class="va">None</span>, [<span class="ss">f"start training model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">..."</span>, </span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>                                      <span class="ss">f"training size: </span><span class="sc">{</span>training_steps <span class="op">*</span> batch_size <span class="op">*</span> strategy<span class="sc">.</span>num_replicas_in_sync<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>                                      <span class="ss">f"validation size: </span><span class="sc">{</span>validation_steps <span class="op">*</span> val_batch_size <span class="op">*</span> strategy<span class="sc">.</span>num_replicas_in_sync<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Oversample the minority class within the fold</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> oversample_minority_class:</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>        (train_dataset, training_steps, training_total_samples, sample_per_class_input_ds,  </span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>        sample_per_class_oversampled_ds) <span class="op">=</span> oversample_minority_class_random(train_dataset, batch_size, strategy)</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Total samples in train dataset after oversampling'</span>, training_total_samples)</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate class weights</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    class_weights_ovs <span class="op">=</span> calculate_class_weights(sample_per_class_oversampled_ds)</span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>    class_weights_input_ds <span class="op">=</span> calculate_class_weights(sample_per_class_input_ds)</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>    print_infos(training_mode, <span class="va">None</span>, [<span class="ss">f"samples per class: </span><span class="sc">{</span>sample_per_class_input_ds<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"class weights: </span><span class="sc">{</span>class_weights_input_ds<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>                                            <span class="ss">f"training steps: </span><span class="sc">{</span>training_steps<span class="sc">}</span><span class="ss">, evaluation steps: </span><span class="sc">{</span>validation_steps<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training data processing</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>    train_dataset <span class="op">=</span> optimize_dataset(train_dataset, file_pattern<span class="op">=</span><span class="va">None</span>, steps<span class="op">=</span>training_steps, cache_in_memory<span class="op">=</span>cache_in_memory,</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>                    cache_dir<span class="op">=</span>cache_dir, prefix<span class="op">=</span><span class="st">'train'</span>, run_id<span class="op">=</span>run_id, check_modification_time<span class="op">=</span><span class="va">False</span>, force_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> augment_train_data:</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>        train_dataset <span class="op">=</span> apply_augmentations(train_dataset)</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>    train_dataset <span class="op">=</span> format_input_dataset(train_dataset, use_tabular_data)</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>    train_dataset <span class="op">=</span> train_dataset.prefetch(tf.data.AUTOTUNE)</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validation data processing</span></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>    val_dataset <span class="op">=</span> format_input_dataset(val_dataset, use_tabular_data)</span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>    val_dataset <span class="op">=</span> optimize_dataset(val_dataset, file_pattern<span class="op">=</span><span class="va">None</span>, steps<span class="op">=</span>validation_steps, cache_in_memory<span class="op">=</span>cache_in_memory,</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>                    cache_dir<span class="op">=</span>cache_dir, prefix<span class="op">=</span><span class="st">'val'</span>, run_id<span class="op">=</span>run_id, check_modification_time<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>                    force_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Callbacks</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>    memory_callback <span class="op">=</span> MemoryUsageCallback()</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>    early_stopping_callback <span class="op">=</span> EarlyStopping(monitor<span class="op">=</span><span class="st">'val_loss'</span>, patience<span class="op">=</span><span class="dv">20</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>    partial_auc_callback <span class="op">=</span> PartialAUCCallback(validation_data<span class="op">=</span>val_dataset, validation_steps<span class="op">=</span>validation_steps,</span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>                                              monitor<span class="op">=</span><span class="st">'val_partial_auc'</span>)</span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a>    one_cycle_scheduler_callback <span class="op">=</span> OneCycleScheduler(max_lr<span class="op">=</span><span class="fl">1e-5</span>, steps_per_epoch<span class="op">=</span>training_steps, epochs<span class="op">=</span>total_epochs,</span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a>                                                     last_epoch_lr<span class="op">=</span><span class="fl">1e-7</span>, start_lr<span class="op">=</span><span class="fl">1e-7</span>)</span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a>    model_checkpoint_callback <span class="op">=</span>  ModelCheckpoint(filepath<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>models_dir<span class="sc">}</span><span class="ss">/model_</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">_checkpoint.keras'</span>,</span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a>                                                 monitor<span class="op">=</span><span class="st">'val_partial_auc'</span>, save_best_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a>    callbacks<span class="op">=</span>[one_cycle_scheduler_callback, partial_auc_callback, early_stopping_callback, model_checkpoint_callback, memory_callback]</span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> strategy.scope():</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>        precision <span class="op">=</span> tf.keras.metrics.Precision()</span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>        recall <span class="op">=</span> tf.keras.metrics.Recall()</span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a>        f1_score <span class="op">=</span> F1Score()</span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a>        auc <span class="op">=</span> tf.keras.metrics.AUC(name<span class="op">=</span><span class="st">"auc"</span>)</span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> tf.keras.optimizers.Nadam() <span class="cf">if</span> execution_env <span class="op">==</span> <span class="st">'colab'</span> <span class="cf">else</span> tf.keras.optimizers.Adamax()</span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> set_binary_crossentropy_weighted_loss(positive_weights<span class="op">=</span>np.array([class_weights_input_ds[<span class="st">'minority_class'</span>]]),</span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a>                                                    negative_weights<span class="op">=</span>np.array([class_weights_input_ds[<span class="st">'majority_class'</span>]]),</span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a>                                                    epsilon<span class="op">=</span><span class="fl">1e-7</span>)</span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a>    history_initial <span class="op">=</span> <span class="va">None</span></span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a>    class_weights<span class="op">=</span><span class="bu">dict</span>(<span class="bu">zip</span>([<span class="dv">0</span>, <span class="dv">1</span>], class_weights_input_ds.values()))</span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initial training</span></span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> freeze_base_model:</span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> strategy.scope():</span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">compile</span>(optimizer<span class="op">=</span>optimizer, loss<span class="op">=</span>loss, metrics<span class="op">=</span>[precision, recall, f1_score])</span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Started fitting the model with base model freezed..."</span>)</span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a>        history_initial <span class="op">=</span> model.fit(train_dataset,epochs<span class="op">=</span>initial_epochs,steps_per_epoch<span class="op">=</span>training_steps, validation_data<span class="op">=</span>val_dataset,</span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a>                                    validation_steps<span class="op">=</span>validation_steps, callbacks<span class="op">=</span>callbacks, class_weight<span class="op">=</span>class_weights, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fine tuning</span></span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> do_fine_tuning:</span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>        initial_epoch <span class="op">=</span> history_initial.epoch[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> freeze_base_model <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> strategy.scope():</span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">compile</span>(optimizer<span class="op">=</span>optimizer, loss<span class="op">=</span>loss, metrics<span class="op">=</span>[<span class="st">'accuracy'</span>, precision, recall, f1_score, auc])</span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Started fine fitting the model with layers unfrozen..."</span>)</span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a>        history_fine_tune <span class="op">=</span> model.fit(train_dataset, epochs<span class="op">=</span>total_epochs, initial_epoch<span class="op">=</span>initial_epoch, steps_per_epoch<span class="op">=</span>training_steps,</span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a>                                      validation_data<span class="op">=</span>val_dataset, validation_steps<span class="op">=</span>validation_steps, class_weight<span class="op">=</span>class_weights,</span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a>                                      callbacks<span class="op">=</span>callbacks, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge histories</span></span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a>        history <span class="op">=</span> merge_histories(history_initial, history_fine_tune)</span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a>        history <span class="op">=</span> history_initial.history</span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Computing the final validation score after training ended"</span>)</span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate the model on the validation set</span></span>
<span id="cb52-119"><a href="#cb52-119" aria-hidden="true" tabindex="-1"></a>    y_val, y_pred <span class="op">=</span> get_labels_and_predictions(model, val_dataset, validation_steps)</span>
<span id="cb52-120"><a href="#cb52-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the Partial AUC</span></span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a>    partial_auc <span class="op">=</span> score(y_val, y_pred)</span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a>    partial_aucs.append(partial_auc)</span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Plotting the training metrics..."</span>)</span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the training history</span></span>
<span id="cb52-127"><a href="#cb52-127" aria-hidden="true" tabindex="-1"></a>    plot_training_history(history, model_name)</span>
<span id="cb52-128"><a href="#cb52-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a>    model.save_weights(os.path.join(models_dir, <span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">_weights.h5'</span>))</span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Train-validation-split partial AUC: </span><span class="sc">{</span>partial_auc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Finished training model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb52-134"><a href="#cb52-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="single-model-training-pipeline" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="single-model-training-pipeline"><span class="header-section-number">3.2.4</span> Single model training pipeline</h3>
<div id="50209ba9" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_single_model(model_name, <span class="op">**</span>kwargs):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train a unique model from scratch."""</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training single model: </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> ModelFactory.create_model(<span class="st">'single'</span>, pretrained<span class="op">=</span><span class="va">False</span>, model_names<span class="op">=</span>[model_name], <span class="op">**</span>kwargs)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> training_pipeline(model_name, model<span class="op">=</span>model, <span class="op">**</span>kwargs)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="training" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="training"><span class="header-section-number">3.3</span> Training</h2>
<section id="utils" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="utils"><span class="header-section-number">3.3.1</span> Utils</h3>
<div id="1d2f2384" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TrainConfig:</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, strategy, run_id, batch_size, val_batch_size, cache_in_memory,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                 freeze_base_model, shuffle_dataset_at_each_call, train_file_pattern,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                 do_fine_tuning, oversample_minority_class, initial_epochs, fine_tune_epochs,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                 img_shape, augment_train_data, use_cross_validation, dropout_rate, l2_lambda,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                 num_tabular_features, use_tabular_data, kernel_initializer, activation,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                 execution_env):</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.strategy <span class="op">=</span> strategy</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_id <span class="op">=</span> run_id</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> batch_size</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.val_batch_size <span class="op">=</span> val_batch_size</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cache_in_memory <span class="op">=</span> cache_in_memory</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.freeze_base_model <span class="op">=</span> freeze_base_model</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.shuffle_dataset_at_each_call <span class="op">=</span> shuffle_dataset_at_each_call</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_file_pattern <span class="op">=</span> train_file_pattern</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.do_fine_tuning <span class="op">=</span> do_fine_tuning</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.oversample_minority_class <span class="op">=</span> oversample_minority_class</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.initial_epochs <span class="op">=</span> initial_epochs</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fine_tune_epochs <span class="op">=</span> fine_tune_epochs</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.img_shape <span class="op">=</span> img_shape</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.augment_train_data <span class="op">=</span> augment_train_data</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_cross_validation <span class="op">=</span> use_cross_validation</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout_rate <span class="op">=</span> dropout_rate</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.l2_lambda <span class="op">=</span> l2_lambda</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_tabular_features <span class="op">=</span> num_tabular_features</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_tabular_data <span class="op">=</span> use_tabular_data</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.kernel_initializer <span class="op">=</span> kernel_initializer</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> activation</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.execution_env <span class="op">=</span> execution_env</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_pipeline(pipeline_func, config: TrainConfig, <span class="op">**</span>specific_params):</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""General pipeline function for training models with a TrainConfig object."""</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean the session and retrieve initial memory</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    initial_memory_usage <span class="op">=</span> reset_session_and_get_memory()</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    log_memory_usage(<span class="st">"Initial"</span>, initial_memory_usage)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure strategy is initialized</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> config.strategy <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Strategy must be set in the configuration."</span>)</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the model using the passed function with the TrainConfig object</span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">#with config.strategy.scope():</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> pipeline_func(strategy<span class="op">=</span>config.strategy, run_id<span class="op">=</span>config.run_id, batch_size<span class="op">=</span>config.batch_size,</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>                           cache_in_memory<span class="op">=</span>config.cache_in_memory, freeze_base_model<span class="op">=</span>config.freeze_base_model,</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>                           shuffle_dataset_at_each_call<span class="op">=</span>config.shuffle_dataset_at_each_call,</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>                           do_fine_tuning<span class="op">=</span>config.do_fine_tuning, train_file_pattern<span class="op">=</span>config.train_file_pattern,</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>                           oversample_minority_class <span class="op">=</span> config.oversample_minority_class,</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>                           initial_epochs <span class="op">=</span> config.initial_epochs, val_batch_size <span class="op">=</span> config.val_batch_size,</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>                           fine_tune_epochs <span class="op">=</span> config.fine_tune_epochs,</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>                           img_shape <span class="op">=</span> config.img_shape,</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>                           augment_train_data <span class="op">=</span> config.augment_train_data,</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>                           use_cross_validation <span class="op">=</span> config.use_cross_validation,</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>                           use_tabular_data <span class="op">=</span> config.use_tabular_data,</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>                           activation <span class="op">=</span> config.activation,</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>                           dropout_rate <span class="op">=</span> config.dropout_rate,</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>                           l2_lambda <span class="op">=</span> config.l2_lambda,</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>                           num_tabular_features <span class="op">=</span> config.num_tabular_features,</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>                           kernel_initializer <span class="op">=</span> config.kernel_initializer,</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>                           execution_env <span class="op">=</span> config.execution_env,</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>                           <span class="op">**</span>specific_params)</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve final memory usage</span></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>    final_memory_usage <span class="op">=</span> get_memory_usage()</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>    log_memory_usage(<span class="st">"Final"</span>, final_memory_usage)</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_model_evaluation(model):</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>    evaluate_model(model, val_dataset_small_formatted, validation_steps_small, dataset_name<span class="op">=</span><span class="st">'small validation dataset'</span>)</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>    evaluate_model(model, val_dataset_big_formatted, validation_steps_big, dataset_name<span class="op">=</span><span class="st">'big validation dataset'</span>)</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>    evaluate_model(model, train_val_dataset_formatted, train_val_dataset_steps, dataset_name<span class="op">=</span><span class="st">'train_val dataset'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initialization-1" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="initialization-1"><span class="header-section-number">3.3.2</span> Initialization</h3>
<div id="6d2ef861" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate TrainConfig with common parameters</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>train_config <span class="op">=</span> TrainConfig(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    strategy<span class="op">=</span>strategy,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    run_id<span class="op">=</span>run_id,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    val_batch_size<span class="op">=</span>val_batch_size,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    cache_in_memory<span class="op">=</span>cache_in_memory,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    freeze_base_model<span class="op">=</span>freeze_base_model,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    shuffle_dataset_at_each_call<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    train_file_pattern<span class="op">=</span>train_file_pattern,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    do_fine_tuning <span class="op">=</span> do_fine_tuning,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    oversample_minority_class <span class="op">=</span> oversample_minority_class,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    initial_epochs <span class="op">=</span> initial_epochs,</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    fine_tune_epochs <span class="op">=</span> fine_tune_epochs,</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    img_shape <span class="op">=</span> img_shape,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    augment_train_data <span class="op">=</span> augment_train_data,</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    use_cross_validation <span class="op">=</span> use_cross_validation,</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    dropout_rate <span class="op">=</span> dropout_rate,</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    l2_lambda <span class="op">=</span> l2_lambda,</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    num_tabular_features <span class="op">=</span> num_tabular_features,</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    use_tabular_data <span class="op">=</span> use_tabular_data,</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    kernel_initializer <span class="op">=</span> kernel_initializer,</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> activation,</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    execution_env <span class="op">=</span> execution_env</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-loading-1" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="data-loading-1"><span class="header-section-number">3.3.3</span> Data loading</h3>
<div id="ccd9ada2" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load dataset once and cache</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> run_evaluations:</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    train_val_dataset, train_val_dataset_steps <span class="op">=</span> load_tfrecord_dataset(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>            train_file_pattern,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>            is_training<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>            cache_in_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    train_val_dataset_formatted <span class="op">=</span> format_input_dataset(train_val_dataset)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify cache</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#!ls -al {cache_dir}</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load big validation dataset</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    val_dataset_small, validation_steps_small <span class="op">=</span> load_tfrecord_dataset(</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>tf_records_eval_dir<span class="sc">}</span><span class="ss">/*.tfrecord'</span>,</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>eval_batch_size,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>            is_training<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>            cache_in_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    val_dataset_small_formatted <span class="op">=</span> format_input_dataset(val_dataset_small)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load big validation dataset</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    val_dataset_big, validation_steps_big <span class="op">=</span> load_tfrecord_dataset(</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>tf_records_val_dir<span class="sc">}</span><span class="ss">/*.tfrecord'</span>,</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>eval_batch_size <span class="op">*</span> <span class="dv">2</span>,</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>            is_training<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>            cache_in_memory<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    val_dataset_big_formatted <span class="op">=</span> format_input_dataset(val_dataset_big)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-1" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="run-1"><span class="header-section-number">3.3.4</span> Run</h3>
<div id="81e543ea" class="cell" data-scrolled="true" data-trusted="true">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> model_type <span class="op">==</span> <span class="st">'single_model'</span>  <span class="kw">or</span> train_all_models:</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#strategy = tf.distribute.OneDeviceStrategy(device="/gpu:0")</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#strategy = tf.distribute.get_strategy()</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#with strategy.scope():</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    single_model <span class="op">=</span> run_pipeline(</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>            pipeline_func<span class="op">=</span>train_single_model, <span class="co"># Function to train the model</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>train_config,  <span class="co"># Common configuration object</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">#model_name='res_net_50'</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            model_name<span class="op">=</span>model_name</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> inference_model_name <span class="op">==</span> <span class="st">'single_model'</span>:</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>         inference_model <span class="op">=</span> single_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluate-on-unseen-and-train_val-datasets" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="evaluate-on-unseen-and-train_val-datasets"><span class="header-section-number">3.3.5</span> Evaluate on unseen and train_val datasets</h3>
<div id="bf028096" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> model_type <span class="op">==</span> <span class="st">'single_model'</span> <span class="kw">or</span> train_all_models:</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Evaluating single model:'</span>, model_name)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    run_model_evaluation(single_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="ensembling-models" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Ensembling models</h1>
<section id="trained-ensemble-model" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="trained-ensemble-model"><span class="header-section-number">4.1</span> Trained ensemble model</h2>
<section id="trained-ensemble-training-pipeline" class="level4" data-number="4.1.0.1">
<h4 data-number="4.1.0.1" class="anchored" data-anchor-id="trained-ensemble-training-pipeline"><span class="header-section-number">4.1.0.1</span> Trained ensemble training pipeline</h4>
<div id="a19e91a5" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_compact_ensemble_model(model_names<span class="op">=</span>[<span class="st">'efficientnetb0'</span>, <span class="st">'resnet50'</span>, <span class="st">'vgg16'</span>], <span class="op">**</span>kwargs):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train a unique ensmeble model from scratch."""</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training compact ensemble model"</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    compact_ensemble_model <span class="op">=</span> ModelFactory.create_model(<span class="st">'ensemble'</span>, model_names, pretrained<span class="op">=</span><span class="va">False</span>, <span class="op">**</span>kwargs)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    compact_ensemble_model <span class="op">=</span> training_pipeline(compact_ensemble_model.model_name, model<span class="op">=</span>compact_ensemble_model, <span class="op">**</span>kwargs)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> compact_ensemble_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-2" class="level4" data-number="4.1.0.2">
<h4 data-number="4.1.0.2" class="anchored" data-anchor-id="run-2"><span class="header-section-number">4.1.0.2</span> Run</h4>
<div id="c03e3566" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> model_type <span class="op">==</span> <span class="st">'compact_ensemble_model'</span> <span class="kw">and</span> train_all_models:</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    compact_ensemble_model <span class="op">=</span> run_pipeline(</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>        pipeline_func<span class="op">=</span>train_compact_ensemble_model, <span class="co"># Function to train ensemble model</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>train_config,  <span class="co"># Common configuration object</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">#model_names=['densenet201','resnet50', 'resnet152v2','vgg19'],</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">#weights=[0.41,  0.35, 0.14, 0.1],</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">#weights=[0.25,  0.25, 0.25, 0.25],</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        model_names<span class="op">=</span>[<span class="st">'res_net_152_v2'</span>, <span class="st">'dense_net_201'</span>],</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        weights<span class="op">=</span>[<span class="fl">0.55</span>,  <span class="fl">0.45</span>]</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluation" class="level4" data-number="4.1.0.3">
<h4 data-number="4.1.0.3" class="anchored" data-anchor-id="evaluation"><span class="header-section-number">4.1.0.3</span> Evaluation</h4>
<div id="0c04d456" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> model_type <span class="op">==</span> <span class="st">'compact_ensemble_model'</span> <span class="kw">or</span> train_all_models:</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Evaluating compact ensemble model'</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    run_model_evaluation(compact_ensemble_model)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> inference_model_name <span class="op">==</span> <span class="st">'compact_ensemble_model'</span>:</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        inference_model <span class="op">=</span> compact_ensemble_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pretrained-ensemble-model" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="pretrained-ensemble-model"><span class="header-section-number">4.2</span> Pretrained ensemble model</h2>
<section id="pretrained-ensemble-pipeline" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="pretrained-ensemble-pipeline"><span class="header-section-number">4.2.1</span> Pretrained ensemble pipeline</h3>
<div id="b2baad46" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_pretrained_ensemble(model_names, train_individuals<span class="op">=</span><span class="va">True</span>,  <span class="op">**</span>kwargs):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train a unique model from scratch."""</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Training pretrained ensemble model'</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    run_id <span class="op">=</span> kwargs.get(<span class="st">'run_id'</span>, <span class="va">None</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train individual models if needed</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    train_individual_models(model_names<span class="op">=</span>model_names, train_individuals<span class="op">=</span>train_individuals, <span class="op">**</span>kwargs)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    pretrained_ensemble <span class="op">=</span> ModelFactory.create_model(model_type<span class="op">=</span><span class="st">'ensemble'</span>, model_names<span class="op">=</span>model_names, pretrained<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>kwargs)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Saving the weights as it is not trained via the commom pipeline</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    pretrained_ensemble.save_weights(os.path.join(models_dir, <span class="ss">f'</span><span class="sc">{</span>pretrained_ensemble<span class="sc">.</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">_weights.h5'</span>))</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Finished creating the pretrained_ensemble'</span>, pretrained_ensemble.model_name)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pretrained_ensemble</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_individual_models(model_names, train_individuals<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>kwargs):</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train individual models if their weights do not already exist."""</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model_name <span class="kw">in</span> model_names:</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Training individual model'</span>, model_name)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        weights_path <span class="op">=</span> os.path.join(<span class="st">'models_dir'</span>, <span class="ss">f'</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>kwargs<span class="sc">.</span>get(<span class="st">"run_id"</span>, <span class="st">"default"</span>)<span class="sc">}</span><span class="ss">_weights.h5'</span>)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">not</span> os.path.exists(weights_path)) <span class="kw">and</span> train_individuals:</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Training </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> since weights are not found."</span>)</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>            train_single_model(model_name,  <span class="op">**</span>kwargs)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Weights for </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> already exist at </span><span class="sc">{</span>weights_path<span class="sc">}</span><span class="ss">, skipping training."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training-1" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="training-1"><span class="header-section-number">4.2.2</span> Training</h3>
</section>
<section id="run-3" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="run-3"><span class="header-section-number">4.2.3</span> Run</h3>
<div id="83c876d7" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> model_type <span class="op">==</span> <span class="st">'pretrained_ensemble_model'</span> <span class="kw">or</span> train_all_models:</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    pretrained_ensemble_model <span class="op">=</span> run_pipeline(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        pipeline_func<span class="op">=</span>train_pretrained_ensemble, <span class="co"># Function to train ensemble model</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        config<span class="op">=</span>train_config,  <span class="co"># Common configuration object</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        model_names<span class="op">=</span>[<span class="st">'dense_net_201'</span>,<span class="st">'res_net_50'</span>, <span class="st">'res_net_152_v2'</span>,<span class="st">'vgg_19'</span>],</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        weights<span class="op">=</span>[<span class="fl">0.41</span>,  <span class="fl">0.35</span>, <span class="fl">0.14</span>, <span class="fl">0.1</span>],</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        train_individuals<span class="op">=</span>train_individuals,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        mode<span class="op">=</span><span class="st">'weighted'</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> inference_model_name <span class="op">==</span> <span class="st">'pretrained_ensemble_model'</span>:</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        inference_model <span class="op">=</span> pretrained_ensemble_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluation-1" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="evaluation-1"><span class="header-section-number">4.2.4</span> Evaluation</h3>
<div id="61efc830" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (model_type <span class="op">==</span> <span class="st">'pretrained_ensemble_model'</span> <span class="kw">or</span> train_all_models) <span class="kw">and</span> run_evaluations:</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Evaluating pretrained ensemble model'</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    run_model_evaluation(pretrained_ensemble_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="inference" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Inference</h1>
<section id="data-preparation-2" class="level3" data-number="5.0.1">
<h3 data-number="5.0.1" class="anchored" data-anchor-id="data-preparation-2"><span class="header-section-number">5.0.1</span> Data preparation</h3>
<div id="a1c84ce5" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and preprocess images using fused operations for I/O and preprocessing</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="at">@tf.function</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image_bytes, img_height, img_width):</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Preprocess image loaded from HDF5."""</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.io.decode_jpeg(image_bytes, channels<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> tf.image.resize(image, [img_height, img_width])</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> image <span class="op">/</span> <span class="fl">255.0</span>  <span class="co"># Normalize to [0, 1]</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_image_from_hdf5(key, h5_file):</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Function to load image bytes from HDF5 file."""</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        image_bytes <span class="op">=</span> h5_file[key][()]</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> image_bytes <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">len</span>(image_bytes) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Empty image data for key: </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image_bytes</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Failed to load image for key </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">. Error: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hdf5_image_generator(h5_file, keys):</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Python generator to load images from HDF5 file."""</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> keys:</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>            image_bytes <span class="op">=</span> load_image_from_hdf5(key, h5_file)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> image_bytes</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error loading image for key </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_inference_dataset(image_paths, data_source<span class="op">=</span><span class="st">'hdf5'</span>, use_tabular_data <span class="op">=</span> use_tabular_data, tabular_data_paths<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>                              batch_size<span class="op">=</span>batch_size, cache_data<span class="op">=</span><span class="va">False</span>, preprocessor_path<span class="op">=</span>preprocessor_path, target_img_shape<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare the dataset for inference, either loading images from a file path or from an .hdf5 file.</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="co">        image_source: Path to the images or .hdf5 file containing the images.</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a><span class="co">        tabular_data_paths: Path to the tabular data, if any.</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="co">        preprocessor: Preprocessing function for tabular data.</span></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="co">        batch_size: Batch size for the dataset.</span></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a><span class="co">        cache_data: Whether to cache the dataset.</span></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a><span class="co">        data_source: 'path' if loading from image paths, 'hdf5' if loading from an .hdf5 file.</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a><span class="co">        A tf.data.Dataset ready for inference.</span></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loading images from file paths</span></span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data_source <span class="op">==</span> <span class="st">'path'</span>:</span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fused operations for loading and preprocessing images from file paths</span></span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>        image_paths <span class="op">=</span> glob(image_paths)</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>        image_dataset <span class="op">=</span> tf.data.Dataset.from_tensor_slices(image_paths)</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load and preprocess the images</span></span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>        image_dataset <span class="op">=</span> image_dataset.<span class="bu">map</span>(preprocess_image, num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE)</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>        keys <span class="op">=</span> [os.path.basename(path).split(<span class="st">'.'</span>)[<span class="dv">0</span>] <span class="cf">for</span> path <span class="kw">in</span> image_paths]</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loading images from an .hdf5 file</span></span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> data_source <span class="op">==</span> <span class="st">'hdf5'</span>:</span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the .hdf5 file and load the image dataset</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the HDF5 file</span></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>        h5_file <span class="op">=</span> h5py.File(image_paths, <span class="st">'r'</span>)</span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>        keys <span class="op">=</span> <span class="bu">list</span>(h5_file.keys())</span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a generator for loading images from the HDF5 file</span></span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> image_gen():</span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> hdf5_image_generator(h5_file, keys)</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a TensorFlow Dataset from the generator</span></span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>        image_dataset <span class="op">=</span> tf.data.Dataset.from_generator(</span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>            image_gen,</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>            output_signature<span class="op">=</span>tf.TensorSpec(shape<span class="op">=</span>(), dtype<span class="op">=</span>tf.string)</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map preprocessing function over the dataset</span></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>        image_dataset <span class="op">=</span> image_dataset.<span class="bu">map</span>(</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> image_bytes: preprocess_image(image_bytes, img_height, img_width),</span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>            num_parallel_calls<span class="op">=</span>tf.data.AUTOTUNE</span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Raise an error if the data_source is not recognized</span></span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"data_source must be either 'path' or 'hdf5'"</span>)</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If tabular data is provided, load and zip it with the image dataset</span></span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_tabular_data:</span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract filenames without extensions</span></span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>        inference_images <span class="op">=</span> keys</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>        preprocessor <span class="op">=</span> load_preprocessor(preprocessor_path)</span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>        tabular_data <span class="op">=</span> format_and_encode_tabular_data([tabular_data_paths], inference_images, preprocessor)</span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>        tabular_data <span class="op">=</span> tf.data.Dataset.from_tensor_slices(tabular_data)</span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine image and tabular data efficiently</span></span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a>        combined_dataset <span class="op">=</span> tf.data.Dataset.<span class="bu">zip</span>((image_dataset, tabular_data))</span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>        combined_dataset <span class="op">=</span> image_dataset</span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Batch the dataset and prefetch to load data asynchronously</span></span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a>    dataset_for_inference <span class="op">=</span> combined_dataset.batch(batch_size <span class="op">*</span> strategy.num_replicas_in_sync,</span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>                                                   drop_remainder<span class="op">=</span><span class="va">False</span>).prefetch(tf.data.AUTOTUNE)</span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cache_data:</span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>        dataset_for_inference <span class="op">=</span> dataset_for_inference.cache()</span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset_for_inference, keys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pipeline" class="level3" data-number="5.0.2">
<h3 data-number="5.0.2" class="anchored" data-anchor-id="pipeline"><span class="header-section-number">5.0.2</span> Pipeline</h3>
<div id="8b7e70bd" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run inference using fused operations, mixed precision, and optimized parallel data loading</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inference_pipeline(model, image_paths, use_tabular_data, tabular_data_paths<span class="op">=</span><span class="va">None</span>, batch_size<span class="op">=</span>batch_size,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                  cache_data<span class="op">=</span><span class="va">False</span>, use_mixed_precision<span class="op">=</span><span class="va">False</span>, preprocessor_path<span class="op">=</span>preprocessor_path,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                 submission_file_path<span class="op">=</span><span class="va">None</span>, target_img_shape<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    use_mixed_precision<span class="op">=</span><span class="va">False</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_mixed_precision:</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        enable_mixed_precision()</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare the dataset</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    dataset_for_inference, images_ids<span class="op">=</span> prepare_inference_dataset(image_paths<span class="op">=</span>image_paths, use_tabular_data<span class="op">=</span>use_tabular_data,</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>                                                      cache_data<span class="op">=</span>cache_data, tabular_data_paths<span class="op">=</span>tabular_data_paths,</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>                                                      batch_size<span class="op">=</span>batch_size, preprocessor_path<span class="op">=</span>preprocessor_path,</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>                                                      target_img_shape<span class="op">=</span>target_img_shape)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    all_predictions <span class="op">=</span> []</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run inference and get predictions</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> dataset_for_inference:</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_tabular_data:</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>            image_batch, tabular_batch <span class="op">=</span> batch</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> model.predict_on_batch([image_batch, tabular_batch]).ravel()</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>            image_batch <span class="op">=</span> batch</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> model.predict_on_batch(image_batch).ravel()</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>        all_predictions.append(predictions)</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save predictions to CSV</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    predictions_df <span class="op">=</span> pd.DataFrame(<span class="bu">zip</span>(images_ids, predictions), columns<span class="op">=</span>[<span class="st">'isic_id'</span>, <span class="st">'target'</span>])</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    predictions_df.to_csv(submission_file_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process predictions</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> predictions_df, dataset_for_inference</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="initialization-2" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="initialization-2"><span class="header-section-number">5.1</span> Initialization</h2>
<div id="0d7ac717" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>preprocessor_path <span class="op">=</span> preprocessor_path</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>inference_model_path <span class="op">=</span> inference_model_path</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>project_dir <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>input_dir<span class="sc">}</span><span class="ss">/isic-2024-challenge'</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>inference_images_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>project_dir<span class="sc">}</span><span class="ss">/test-image.hdf5'</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>inference_tabular_data_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>project_dir<span class="sc">}</span><span class="ss">/test-metadata.csv'</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>use_tabular_data <span class="op">=</span> use_tabular_data</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>cache_data<span class="op">=</span><span class="va">True</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>submission_file_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/submission.csv'</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>target_img_shape<span class="op">=</span>img_shape</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>run_inference_use_all_models <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-4" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="run-4"><span class="header-section-number">5.2</span> Run</h2>
<div id="ce887ba1" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run inference with optimizations and mixed precision enabled</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> run_inference:</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    inference_models <span class="op">=</span> [single_model, compact_ensemble_model, pretrained_ensemble_model] <span class="cf">if</span> run_inference_use_all_models <span class="cf">else</span> [inference_model]</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    predictions_dfs <span class="op">=</span> []</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> inf_model <span class="kw">in</span> inference_models:</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Running inference for model...'</span>, inf_model.model_name)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        predictions_df, dataset_for_inference <span class="op">=</span> inference_pipeline(model<span class="op">=</span>inf_model, image_paths<span class="op">=</span>inference_images_path, use_tabular_data<span class="op">=</span>use_tabular_data,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>                                      tabular_data_paths<span class="op">=</span>inference_tabular_data_path, batch_size<span class="op">=</span>batch_size,  cache_data<span class="op">=</span>cache_data,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>                                      use_mixed_precision<span class="op">=</span><span class="va">False</span>, preprocessor_path<span class="op">=</span>preprocessor_path, submission_file_path<span class="op">=</span>submission_file_path,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>                                      target_img_shape<span class="op">=</span>target_img_shape)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        predictions_dfs.append(predictions_df)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Finished running inference for model'</span>, inf_model.model_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="adc0f53a" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>predictions_dfs[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="annexe" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Annexe</h1>
<div id="a63e65a3" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit intra-op parallelism (operations within a single layer)</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">#export OMP_NUM_THREADS=100</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit inter-op parallelism (parallel operations across layers)</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">#export TF_NUM_INTEROP_THREADS=100</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit intra-op parallelism (for operations like matrix multiplications)</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co">#tf.config.threading.set_intra_op_parallelism_threads(100)</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit inter-op parallelism (for parallel operations across layers)</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">#tf.config.threading.set_inter_op_parallelism_threads(100)</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">#import os</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">#os.environ["CUDA_VISIBLE_DEVICES"] = "-1"  # Disables GPU by setting this environment variable</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">#tf.config.list_physical_devices('GPU')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="081d03c3" class="cell" data-trusted="true">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>visualization <span class="op">=</span> <span class="va">False</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> visualization:</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    eval_dataset_mapped <span class="op">=</span> eval_dataset.<span class="bu">map</span>(<span class="kw">lambda</span> x, y, z: ((x, y), z))</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    augmented_dataset <span class="op">=</span> apply_augmentations(eval_dataset_mapped)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    imgs <span class="op">=</span> augmented_dataset.as_numpy_iterator()</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    imgs_t <span class="op">=</span> imgs.<span class="bu">next</span>()[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">50</span>, <span class="dv">50</span>))</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#imgs_t = imgs.next()[0]</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">63</span>):</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">12</span>, <span class="dv">12</span>, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>        plt.xticks([])</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>        plt.yticks([])</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        plt.imshow(imgs_t[i])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>